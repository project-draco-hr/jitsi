{
  try {
    tm.checkServerTrusted(chain,authType);
  }
 catch (  CertificateException certificateException) {
    try {
      for (int i=0; i < chain.length; i++) {
        X509Certificate c=chain[i];
        if (temporalyAllowed.contains(c)) {
          return;
        }
        String alias=keyStore.getCertificateAlias(c);
        if (alias != null)         return;
      }
      if (guiVerification == null)       throw certificateException;
      int result=guiVerification.verificationNeeded(chain,address,port);
      if (result == CertificateVerificationService.DO_NOT_TRUST) {
        throw certificateException;
      }
 else       if (result == CertificateVerificationService.TRUST_THIS_SESSION_ONLY) {
        for (        X509Certificate c : chain)         temporalyAllowed.add(c);
      }
 else       if (result == CertificateVerificationService.TRUST_ALWAYS) {
        for (        X509Certificate c : chain)         keyStore.setCertificateEntry(String.valueOf(System.currentTimeMillis()),c);
      }
    }
 catch (    Exception e) {
      logger.error("Error trying to " + "show certificate to user",e);
      throw certificateException;
    }
    try {
      String keyStoreFile=SipActivator.getConfigurationService().getString(KEYSTORE_FILE_PROP);
      keyStore.store(new FileOutputStream(keyStoreFile),defaultPassword);
    }
 catch (    Exception e) {
      logger.error("Error saving keystore.",e);
    }
  }
}
