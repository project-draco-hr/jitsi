{
  PresenceStatus oldStatus=sshContact.getPresenceStatus();
  opSetPersPresence.changeContactPresenceStatus(sshContact,SSHStatusEnum.CONNECTING);
  try {
    if (!ppService.isSessionValid(sshContact))     ppService.createSSHSessionAndLogin(sshContact);
    fileTransferChannel=sshContact.getSSHSession().openChannel("exec");
    String command;
    if (uploadFile)     command="scp -p -t " + remotePath;
 else     command="scp -f " + remotePath;
    ((ChannelExec)fileTransferChannel).setCommand(command);
    scpInputStream=fileTransferChannel.getInputStream();
    scpOutputStream=fileTransferChannel.getOutputStream();
    fileTransferChannel.connect();
    opSetPersPresence.changeContactPresenceStatus(sshContact,SSHStatusEnum.FILE_TRANSFER);
    if (uploadFile) {
      instantMessaging.deliverMessage(instantMessaging.createMessage("Uploading " + file.getName() + " to server"),sshContact);
      upload();
    }
 else {
      instantMessaging.deliverMessage(instantMessaging.createMessage("Downloading " + file.getName() + " from server"),sshContact);
      download();
    }
  }
 catch (  Exception ex) {
    instantMessaging.deliverMessage(instantMessaging.createMessage(ex.getMessage()),sshContact);
    ex.printStackTrace();
    logger.error(ex.getMessage());
    try {
      if (fileInputStream != null) {
        fileInputStream.close();
      }
      if (fileOutputStream != null) {
        fileOutputStream.close();
      }
    }
 catch (    Exception e) {
    }
  }
  opSetPersPresence.changeContactPresenceStatus(sshContact,oldStatus);
}
