{
  Iterator iterator=historyList.iterator();
  String historyString="";
  while (iterator.hasNext()) {
    Object o=iterator.next();
    if (o instanceof MessageDeliveredEvent) {
      MessageDeliveredEvent evt=(MessageDeliveredEvent)o;
      ProtocolProviderService protocolProvider=evt.getDestinationContact().getProtocolProvider();
      historyString+=processHistoryMessage(getChatWindow().getMainFrame().getAccount(protocolProvider),evt.getTimestamp(),Constants.HISTORY_OUTGOING_MESSAGE,evt.getSourceMessage().getContent(),evt.getSourceMessage().getContentType());
    }
 else     if (o instanceof MessageReceivedEvent) {
      MessageReceivedEvent evt=(MessageReceivedEvent)o;
      if (!evt.getSourceMessage().getMessageUID().equals(escapedMessageID)) {
        historyString+=processHistoryMessage(evt.getSourceContact().getDisplayName(),evt.getTimestamp(),Constants.HISTORY_INCOMING_MESSAGE,evt.getSourceMessage().getContent(),evt.getSourceMessage().getContentType());
      }
    }
 else     if (o instanceof ChatRoomMessageDeliveredEvent) {
      ChatRoomMessageDeliveredEvent evt=(ChatRoomMessageDeliveredEvent)o;
      ProtocolProviderService protocolProvider=evt.getSourceChatRoom().getParentProvider();
      historyString+=processHistoryMessage(getChatWindow().getMainFrame().getAccount(protocolProvider),evt.getTimestamp(),Constants.HISTORY_OUTGOING_MESSAGE,evt.getMessage().getContent(),evt.getMessage().getContentType());
    }
 else     if (o instanceof ChatRoomMessageReceivedEvent) {
      ChatRoomMessageReceivedEvent evt=(ChatRoomMessageReceivedEvent)o;
      if (!evt.getMessage().getMessageUID().equals(escapedMessageID)) {
        historyString+=processHistoryMessage(evt.getSourceChatRoomMember().getName(),evt.getTimestamp(),Constants.HISTORY_INCOMING_MESSAGE,evt.getMessage().getContent(),evt.getMessage().getContentType());
      }
    }
  }
  conversationPanel.insertMessageAfterStart(historyString);
  getChatWindow().getMainToolBar().changeHistoryButtonsState(this);
}
