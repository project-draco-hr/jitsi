{
  assertSupportedAndConnected();
  ChatRoom room=null;
  if (roomName == null)   roomName="chatroom-" + StringUtils.randomString(4);
 else   room=findRoom(roomName);
  if (room == null) {
    logger.info("Find room returns null.");
    MultiUserChat muc=new MultiUserChat(getXmppConnection(),getCanonicalRoomName(roomName));
    try {
      muc.create(StringUtils.parseName(getXmppConnection().getUser()));
      muc.sendConfigurationForm(new Form(Form.TYPE_SUBMIT));
    }
 catch (    XMPPException ex) {
      logger.error("Failed to create chat room.",ex);
      throw new OperationFailedException("Failed to create chat room",ex.getXMPPError().getCode(),ex.getCause());
    }
    room=createLocalChatRoomInstance(muc);
    room.setUserRole(ChatRoomMemberRole.OWNER);
  }
  room.join();
  return room;
}
