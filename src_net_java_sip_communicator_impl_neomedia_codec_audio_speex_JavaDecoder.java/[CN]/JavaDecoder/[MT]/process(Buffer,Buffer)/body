{
  if (!checkInputBuffer(inputBuffer)) {
    return BUFFER_PROCESSED_FAILED;
  }
  if (isEOM(inputBuffer)) {
    propagateEOM(outputBuffer);
    return BUFFER_PROCESSED_OK;
  }
  byte[] inData=(byte[])inputBuffer.getData();
  int inpLength=inputBuffer.getLength();
  int outLength=0;
  int inOffset=inputBuffer.getOffset();
  int outOffset=outputBuffer.getOffset();
  Format newFormat=inputBuffer.getFormat();
  if (lastFormat != newFormat) {
    initConverter((AudioFormat)newFormat);
  }
  try {
    int fullyProcessed=decoder.processData(inData,inOffset,inpLength);
    while (fullyProcessed != 1) {
      fullyProcessed=decoder.processData(false);
    }
    outLength=decoder.getProcessedDataByteSize();
    Object outData=outputBuffer.getData();
    byte[] out;
    if (outData instanceof byte[]) {
      out=(byte[])outData;
      if (out.length < outLength)       out=null;
    }
 else     out=null;
    if (out == null)     out=new byte[outLength];
    decoder.getProcessedData(out,outOffset);
    outputBuffer.setData(out);
    outputBuffer.setLength(out.length);
    outputBuffer.setOffset(0);
    outputBuffer.setFormat(outputFormat);
  }
 catch (  StreamCorruptedException ex) {
    ex.printStackTrace();
  }
  return BUFFER_PROCESSED_OK;
}
