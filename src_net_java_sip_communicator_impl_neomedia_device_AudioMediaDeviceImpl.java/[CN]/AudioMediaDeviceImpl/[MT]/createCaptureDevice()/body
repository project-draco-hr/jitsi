{
  CaptureDevice captureDevice=null;
  if (getDirection().allowsSending()) {
    if (captureDeviceSharing == null) {
      CaptureDeviceInfo captureDeviceInfo=getCaptureDeviceInfo();
      boolean createCaptureDeviceIfNull=true;
      if (captureDeviceInfo != null) {
        MediaLocator locator=captureDeviceInfo.getLocator();
        String locatorProtocol=(locator == null) ? null : locator.getProtocol();
        if ("javasound".equalsIgnoreCase(locatorProtocol) || PortAudioAuto.LOCATOR_PROTOCOL.equalsIgnoreCase(locatorProtocol)) {
          captureDevice=super.createCaptureDevice();
          createCaptureDeviceIfNull=false;
          if (captureDevice != null) {
            captureDeviceSharing=createCaptureDeviceSharing(captureDevice);
            captureDevice=captureDeviceSharing.createOutputDataSource();
          }
        }
      }
      if ((captureDevice == null) && createCaptureDeviceIfNull)       captureDevice=super.createCaptureDevice();
    }
 else     captureDevice=captureDeviceSharing.createOutputDataSource();
  }
  return captureDevice;
}
