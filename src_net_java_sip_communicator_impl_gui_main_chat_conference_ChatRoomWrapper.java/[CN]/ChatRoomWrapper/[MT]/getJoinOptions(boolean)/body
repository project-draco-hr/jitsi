{
  String nickName=null;
  ChatRoomJoinOptionsDialog reasonDialog=new ChatRoomJoinOptionsDialog(GuiActivator.getResources().getI18NString("service.gui.CHANGE_NICKNAME"),GuiActivator.getResources().getI18NString("service.gui.CHANGE_NICKNAME_LABEL"),false,true,dontDisplaySubjectFields);
  reasonDialog.setIcon(ImageLoader.getImage(ImageLoader.CHANGE_NICKNAME_ICON));
  final OperationSetServerStoredAccountInfo accountInfoOpSet=getParentProvider().getProtocolProvider().getOperationSet(OperationSetServerStoredAccountInfo.class);
  String displayName="";
  if (accountInfoOpSet != null) {
    displayName=AccountInfoUtils.getDisplayName(accountInfoOpSet);
  }
  if (displayName == null || displayName.length() == 0) {
    displayName=GuiActivator.getGlobalDisplayDetailsService().getGlobalDisplayName();
    if (displayName == null || displayName.length() == 0) {
      displayName=getParentProvider().getProtocolProvider().getAccountID().getUserID();
      if (displayName != null) {
        int atIndex=displayName.lastIndexOf("@");
        if (atIndex > 0)         displayName=displayName.substring(0,atIndex);
      }
    }
  }
  reasonDialog.setReasonFieldText(displayName);
  int result=reasonDialog.showDialog();
  if (result == MessageDialog.OK_RETURN_CODE) {
    nickName=reasonDialog.getReason().trim();
    ConfigurationUtils.updateChatRoomProperty(getParentProvider().getProtocolProvider(),getChatRoomID(),"userNickName",nickName);
  }
  String[] joinOptions={nickName,(reasonDialog.isSubjectCheckboxChecked() ? reasonDialog.getSubject() : null)};
  return joinOptions;
}
