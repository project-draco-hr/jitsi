{
  if (!checkInputBuffer(inBuffer))   return BUFFER_PROCESSED_FAILED;
  if (isEOM(inBuffer) || !opened) {
    propagateEOM(outBuffer);
    return BUFFER_PROCESSED_OK;
  }
  if (inBuffer.isDiscard()) {
    outBuffer.setDiscard(true);
    return BUFFER_PROCESSED_OK;
  }
  got_picture[0]=false;
  FFmpeg.avcodec_decode_video(avctx,avframe,got_picture,(byte[])inBuffer.getData(),inBuffer.getLength());
  if (!got_picture[0]) {
    if ((inBuffer.getFlags() & Buffer.FLAG_RTP_MARKER) != 0) {
      if (keyFrameControl != null)       keyFrameControl.requestKeyFrame(!gotPictureAtLeastOnce);
    }
    outBuffer.setDiscard(true);
    return BUFFER_PROCESSED_OK;
  }
  gotPictureAtLeastOnce=true;
  int width=FFmpeg.avcodeccontext_get_width(avctx);
  int height=FFmpeg.avcodeccontext_get_height(avctx);
  if ((width > 0) && (height > 0) && ((this.width != width) || (this.height != height))) {
    this.width=width;
    this.height=height;
    Dimension outSize=new Dimension(this.width,this.height);
    VideoFormat inFormat=(VideoFormat)inBuffer.getFormat();
    float outFrameRate=ensureFrameRate(inFormat.getFrameRate());
    outputFormat=new AVFrameFormat(outSize,outFrameRate,FFmpeg.PIX_FMT_YUV420P,Format.NOT_SPECIFIED);
  }
  outBuffer.setFormat(outputFormat);
  Object out=outBuffer.getData();
  if (!(out instanceof AVFrame) || (((AVFrame)out).getPtr() != avframe))   outBuffer.setData(new AVFrame(avframe));
  long pts=FFmpeg.AV_NOPTS_VALUE;
  if (pts == FFmpeg.AV_NOPTS_VALUE)   outBuffer.setTimeStamp(Buffer.TIME_UNKNOWN);
 else {
    outBuffer.setTimeStamp(pts);
    int outFlags=outBuffer.getFlags();
    outFlags|=Buffer.FLAG_RELATIVE_TIME;
    outFlags&=~(Buffer.FLAG_RTP_TIME | Buffer.FLAG_SYSTEM_TIME);
    outBuffer.setFlags(outFlags);
  }
  return BUFFER_PROCESSED_OK;
}
