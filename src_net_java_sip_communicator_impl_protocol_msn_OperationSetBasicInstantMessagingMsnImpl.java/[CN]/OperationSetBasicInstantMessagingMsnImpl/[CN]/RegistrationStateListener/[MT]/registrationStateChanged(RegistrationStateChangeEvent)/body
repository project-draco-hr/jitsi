{
  if (logger.isDebugEnabled())   logger.debug("The provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERED) {
    opSetPersPresence=(OperationSetPersistentPresenceMsnImpl)msnProvider.getOperationSet(OperationSetPersistentPresence.class);
    MsnMessenger msnMessenger=msnProvider.getMessenger();
    if (msnMessenger != null) {
      MsnMessageListener listener=new MsnMessageListener();
      msnMessenger.addMessageListener(listener);
      msnMessenger.addEmailListener(listener);
    }
 else     if (logger.isInfoEnabled())     logger.info("Registered but msnMessenger is missing!",new Exception());
  }
 else   if (evt.getNewState() == RegistrationState.UNREGISTERED || evt.getNewState() == RegistrationState.CONNECTION_FAILED || evt.getNewState() == RegistrationState.AUTHENTICATION_FAILED) {
    if (senderThread != null) {
      senderThread.stopRunning();
      senderThread=null;
    }
  }
}
