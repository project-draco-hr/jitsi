{
  try {
    SimpleDateFormat sdf=new SimpleDateFormat(HistoryService.DATE_FORMAT);
    History history=this.getHistory(source,destination);
    HistoryWriter historyWriter=history.getWriter();
    StringBuffer callPeerIDs=new StringBuffer();
    StringBuffer callPeerNames=new StringBuffer();
    StringBuffer callPeerStartTime=new StringBuffer();
    StringBuffer callPeerEndTime=new StringBuffer();
    StringBuffer callPeerStates=new StringBuffer();
    for (    CallPeerRecord item : callRecord.getPeerRecords()) {
      if (callPeerIDs.length() > 0) {
        callPeerIDs.append(DELIM);
        callPeerNames.append(DELIM);
        callPeerStartTime.append(DELIM);
        callPeerEndTime.append(DELIM);
        callPeerStates.append(DELIM);
      }
      callPeerIDs.append(item.getPeerAddress());
      callPeerNames.append(item.getDisplayName());
      callPeerStartTime.append(sdf.format(item.getStartTime()));
      callPeerEndTime.append(sdf.format(item.getEndTime()));
      callPeerStates.append(item.getState().getStateString());
    }
    historyWriter.addRecord(new String[]{callRecord.getSourceCall().getProtocolProvider().getAccountID().getAccountUniqueID(),sdf.format(callRecord.getStartTime()),sdf.format(callRecord.getEndTime()),callRecord.getDirection(),callPeerIDs.toString(),callPeerStartTime.toString(),callPeerEndTime.toString(),callPeerStates.toString(),String.valueOf(callRecord.getEndReason()),callPeerNames.toString()},new Date());
  }
 catch (  IOException e) {
    logger.error("Could not add call to history",e);
  }
}
