{
  ZrtpFortuna fortuna=ZrtpFortuna.getInstance();
  if ((dataSource == null) || (audioStream == null))   return;
  try {
    dataSource.start();
    int i=0;
    while (gatheredEntropy < bytesToGather) {
      if (audioStream instanceof PushBufferStream) {
synchronized (bufferSync) {
          while (!bufferAvailable) {
            try {
              bufferSync.wait();
            }
 catch (            InterruptedException e) {
            }
          }
          bufferAvailable=false;
        }
      }
 else       ((PullBufferStream)audioStream).read(firstBuf);
      byte[] entropy=(byte[])firstBuf.getData();
      gatheredEntropy+=entropy.length;
      if (i < 32)       fortuna.addSeedMaterial(entropy);
 else {
        fortuna.addSeedMaterial((i % 3),entropy,0,entropy.length);
      }
      i=gatheredEntropy / bytes20ms;
    }
    entropyOk=true;
    if (logger.isInfoEnabled())     logger.info("GatherEntropy got: " + gatheredEntropy + " bytes");
  }
 catch (  IOException ioex) {
  }
 finally {
    audioStream=null;
    dataSource.disconnect();
  }
  byte[] random=new byte[300];
  fortuna.nextBytes(random);
}
