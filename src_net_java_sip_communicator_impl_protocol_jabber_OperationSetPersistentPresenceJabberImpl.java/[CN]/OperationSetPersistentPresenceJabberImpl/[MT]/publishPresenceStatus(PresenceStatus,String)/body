{
  assertConnected();
  JabberStatusEnum jabberStatusEnum=parentProvider.getJabberStatusEnum();
  boolean isValidStatus=false;
  for (Iterator<PresenceStatus> supportedStatusIter=jabberStatusEnum.getSupportedStatusSet(); supportedStatusIter.hasNext(); ) {
    if (supportedStatusIter.next().equals(status)) {
      isValidStatus=true;
      break;
    }
  }
  if (!isValidStatus)   throw new IllegalArgumentException(status + " is not a valid Jabber status");
  if (status.equals(jabberStatusEnum.getStatus(JabberStatusEnum.OFFLINE))) {
    parentProvider.unregister();
  }
 else {
    Presence presence=new Presence(Presence.Type.available);
    presence.setMode(presenceStatusToJabberMode(status));
    presence.setPriority(resourcePriority);
    if (status.equals(jabberStatusEnum.getStatus(JabberStatusEnum.ON_THE_PHONE))) {
      presence.setStatus(JabberStatusEnum.ON_THE_PHONE);
    }
 else     presence.setStatus(statusMessage);
    parentProvider.getConnection().sendPacket(presence);
  }
  fireProviderStatusChangeEvent(currentStatus,status);
  if (!getCurrentStatusMessage().equals(statusMessage)) {
    String oldStatusMessage=getCurrentStatusMessage();
    currentStatusMessage=statusMessage;
    fireProviderStatusMessageChangeEvent(oldStatusMessage,getCurrentStatusMessage());
  }
}
