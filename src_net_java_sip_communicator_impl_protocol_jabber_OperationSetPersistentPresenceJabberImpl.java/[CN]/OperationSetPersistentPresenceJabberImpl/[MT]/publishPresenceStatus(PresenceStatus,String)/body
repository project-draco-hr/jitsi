{
  assertConnected();
  if (!(status instanceof JabberStatusEnum))   throw new IllegalArgumentException(status + " is not a valid Jabber status");
  Presence presence=null;
  if (((JabberStatusEnum)status).equals(JabberStatusEnum.OFFLINE)) {
    presence=new Presence(Presence.Type.unavailable);
    jabberProvider.unregister();
  }
 else {
    presence=new Presence(Presence.Type.available);
    presence.setMode(presenceStatusToJabberMode((JabberStatusEnum)status));
    presence.setPriority(resourcePriority);
    presence.setStatus(statusMessage);
    presence.addExtension(new Version());
    jabberProvider.getConnection().sendPacket(presence);
  }
  fireProviderPresenceStatusChangeEvent(currentStatus,status);
  if (!getCurrentStatusMessage().equals(statusMessage)) {
    String oldStatusMessage=getCurrentStatusMessage();
    currentStatusMessage=statusMessage;
    fireProviderStatusMessageChangeEvent(oldStatusMessage,getCurrentStatusMessage());
  }
}
