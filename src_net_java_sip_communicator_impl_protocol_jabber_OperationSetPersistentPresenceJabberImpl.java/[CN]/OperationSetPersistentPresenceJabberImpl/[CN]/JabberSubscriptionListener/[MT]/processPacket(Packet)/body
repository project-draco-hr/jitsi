{
  Presence presence=(Presence)packet;
  if (presence == null)   return;
  Presence.Type presenceType=presence.getType();
  String fromID=presence.getFrom();
  if (presenceType == Presence.Type.subscribe) {
    if (logger.isTraceEnabled())     logger.trace(fromID + " wants to add you to its contact list");
    ContactJabberImpl srcContact=ssContactList.findContactById(fromID);
    if (srcContact == null)     srcContact=createVolatileContact(fromID);
    AuthorizationRequest req=new AuthorizationRequest();
    AuthorizationResponse response=handler.processAuthorisationRequest(req,srcContact);
    Presence.Type responsePresenceType;
    if (response != null && response.getResponseCode().equals(AuthorizationResponse.ACCEPT)) {
      responsePresenceType=Presence.Type.subscribed;
      if (logger.isInfoEnabled())       logger.info("Sending Accepted Subscription");
    }
 else {
      responsePresenceType=Presence.Type.unsubscribed;
      if (logger.isInfoEnabled())       logger.info("Sending Rejected Subscription");
    }
    Presence responsePacket=new Presence(responsePresenceType);
    responsePacket.setTo(fromID);
    parentProvider.getConnection().sendPacket(responsePacket);
  }
 else   if (presenceType == Presence.Type.unsubscribed) {
    if (logger.isTraceEnabled())     logger.trace(fromID + " does not allow your subscription");
    ContactJabberImpl contact=ssContactList.findContactById(fromID);
    if (contact != null) {
      AuthorizationResponse response=new AuthorizationResponse(AuthorizationResponse.REJECT,"");
      handler.processAuthorizationResponse(response,contact);
      ssContactList.removeContact(contact);
    }
  }
 else   if (presenceType == Presence.Type.subscribed) {
    ContactJabberImpl contact=ssContactList.findContactById(fromID);
    AuthorizationResponse response=new AuthorizationResponse(AuthorizationResponse.ACCEPT,"");
    handler.processAuthorizationResponse(response,contact);
  }
}
