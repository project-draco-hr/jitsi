{
  if (logger.isDebugEnabled())   logger.debug("The Jabber provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERING) {
    parentProvider.getConnection().addPacketListener(new ServerStoredListInit(),new PacketTypeFilter(RosterPacket.class));
  }
 else   if (evt.getNewState() == RegistrationState.REGISTERED) {
    fireProviderStatusChangeEvent(currentStatus,parentProvider.getJabberStatusEnum().getStatus(JabberStatusEnum.AVAILABLE));
    createContactPhotoPresenceListener();
    createAccountPhotoPresenceInterceptor();
  }
 else   if (evt.getNewState() == RegistrationState.UNREGISTERED || evt.getNewState() == RegistrationState.AUTHENTICATION_FAILED || evt.getNewState() == RegistrationState.CONNECTION_FAILED) {
    PresenceStatus oldStatus=currentStatus;
    PresenceStatus offlineStatus=parentProvider.getJabberStatusEnum().getStatus(JabberStatusEnum.OFFLINE);
    currentStatus=offlineStatus;
    fireProviderStatusChangeEvent(oldStatus,currentStatus);
    ssContactList.cleanup();
    subscribtionPacketListener=null;
    if (parentProvider.getConnection() != null && parentProvider.getConnection().getRoster() != null)     parentProvider.getConnection().getRoster().removeRosterListener(contactChangesListener);
    contactChangesListener=null;
  }
}
