{
  logger.debug("The Jabber provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERED) {
    jabberProvider.getConnection().getRoster().addRosterListener(new ContactChangesListener());
    fireProviderPresenceStatusChangeEvent(currentStatus,jabberProvider.getJabberStatusEnum().getStatus(JabberStatusEnum.AVAILABLE));
    ssContactList.init();
  }
 else   if (evt.getNewState() == RegistrationState.UNREGISTERED || evt.getNewState() == RegistrationState.AUTHENTICATION_FAILED || evt.getNewState() == RegistrationState.CONNECTION_FAILED) {
    PresenceStatus oldStatus=currentStatus;
    PresenceStatus offlineStatus=jabberProvider.getJabberStatusEnum().getStatus(JabberStatusEnum.OFFLINE);
    currentStatus=offlineStatus;
    fireProviderPresenceStatusChangeEvent(oldStatus,currentStatus);
    Iterator groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroupJabberImpl group=(ContactGroupJabberImpl)groupsIter.next();
      Iterator contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactJabberImpl contact=(ContactJabberImpl)contactsIter.next();
        PresenceStatus oldContactStatus=contact.getPresenceStatus();
        if (!oldContactStatus.isOnline())         continue;
        contact.updatePresenceStatus(offlineStatus);
        fireContactPresenceStatusChangeEvent(contact,contact.getParentContactGroup(),oldContactStatus,offlineStatus);
      }
    }
    Iterator contactsIter=getServerStoredContactListRoot().contacts();
    while (contactsIter.hasNext()) {
      ContactJabberImpl contact=(ContactJabberImpl)contactsIter.next();
      PresenceStatus oldContactStatus=contact.getPresenceStatus();
      if (!oldContactStatus.isOnline())       continue;
      contact.updatePresenceStatus(offlineStatus);
      fireContactPresenceStatusChangeEvent(contact,contact.getParentContactGroup(),oldContactStatus,offlineStatus);
    }
  }
}
