{
  this.lastMsgTimestamp=timestamp;
  Collection historyList=msgHistory.findLast(metaContact,Constants.CHAT_HISTORY_SIZE);
  if (historyList.size() > 0) {
    Iterator i=historyList.iterator();
    while (i.hasNext()) {
      Object o=i.next();
      if (o instanceof MessageDeliveredEvent) {
        MessageDeliveredEvent evt=(MessageDeliveredEvent)o;
        ProtocolProviderService protocolProvider=evt.getDestinationContact().getProtocolProvider();
        conversationPanel.processMessage(chatWindow.getMainFrame().getAccount(protocolProvider),evt.getTimestamp(),Constants.HISTORY_OUTGOING_MESSAGE,evt.getSourceMessage().getContent());
      }
 else       if (o instanceof MessageReceivedEvent) {
        MessageReceivedEvent evt=(MessageReceivedEvent)o;
        if (evt.getTimestamp().compareTo(lastMsgTimestamp) != 0) {
          conversationPanel.processMessage(evt.getSourceContact().getDisplayName(),evt.getTimestamp(),Constants.HISTORY_INCOMING_MESSAGE,evt.getSourceMessage().getContent());
        }
      }
    }
  }
}
