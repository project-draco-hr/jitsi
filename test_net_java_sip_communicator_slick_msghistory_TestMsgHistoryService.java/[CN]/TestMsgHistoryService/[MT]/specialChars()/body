{
  mockBImOpSet.deliverMessage(TEST_CONTACT_NAME_1,messagesToSend[5]);
  waitWrite(500);
  mockBImOpSet.deliverMessage(TEST_CONTACT_NAME_1,messagesToSend[6]);
  waitWrite(500);
  historyService.purgeLocallyCachedHistories();
  Collection<EventObject> rs=msgHistoryService.findLast(testMetaContact,4);
  assertTrue("Nothing found 8",!rs.isEmpty());
  List<String> msgs=getMessages(rs);
  assertEquals("Messages must be 4",4,msgs.size());
  assertTrue("Message not found",msgs.contains(messagesToSend[3].getContent()));
  assertTrue("Message not found",msgs.contains(messagesToSend[4].getContent()));
  assertTrue("Message not found",msgs.contains(XmlEscapers.xmlContentEscaper().escape(messagesToSend[5].getContent())));
  assertTrue("Message not found",msgs.contains(messagesToSend[6].getContent()));
}
