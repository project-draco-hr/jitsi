{
  Request req=responseEvent.getClientTransaction().getRequest();
  if (req.getHeader(SMS_OUTGOING_MESSAGE_HEADER) == null)   return true;
  int status=responseEvent.getResponse().getStatusCode();
  String content=null;
  try {
    content=new String(req.getRawContent(),getCharset(req));
  }
 catch (  UnsupportedEncodingException exc) {
    logger.debug("failed to convert the message charset",exc);
    content=new String(req.getRawContent());
  }
  ToHeader toHeader=(ToHeader)req.getHeader(ToHeader.NAME);
  if (toHeader == null) {
    logger.error("send a request without a to header");
    return false;
  }
  Contact to=resolveContact(toHeader.getAddress().getURI().toString());
  if (to == null) {
    logger.error("Error received a response from an unknown contact : " + toHeader.getAddress().getURI().toString() + " : "+ responseEvent.getResponse().getReasonPhrase());
    MessageDeliveryFailedEvent evt=new MessageDeliveryFailedEvent(createMessage(content),to,MessageDeliveryFailedEvent.INTERNAL_ERROR,new Date());
    fireMessageEvent(evt);
    return false;
  }
  String key=((CallIdHeader)req.getHeader(CallIdHeader.NAME)).getCallId();
  Message newMessage=(Message)sentMsg.get(key);
  if (newMessage == null) {
    logger.error("Couldn't find the message sent");
    MessageDeliveryFailedEvent evt=new MessageDeliveryFailedEvent(createMessage(content),to,MessageDeliveryFailedEvent.INTERNAL_ERROR,new Date());
    fireMessageEvent(evt);
    return false;
  }
  if (status >= 400 && status != 401 && status != 407) {
    logger.info("Error received from the network : " + responseEvent.getResponse().getReasonPhrase());
    MessageDeliveryFailedEvent evt=new MessageDeliveryFailedEvent(newMessage,to,MessageDeliveryFailedEvent.NETWORK_FAILURE,new Date(),responseEvent.getResponse().getReasonPhrase());
    fireMessageEvent(evt);
    sentMsg.remove(key);
    return false;
  }
 else   if (status == 401 || status == 407) {
    return true;
  }
 else   if (status >= 200) {
    logger.debug("Ack received from the network : " + responseEvent.getResponse().getReasonPhrase());
    MessageDeliveredEvent msgDeliveredEvt=new MessageDeliveredEvent(newMessage,to,new Date());
    fireMessageEvent(msgDeliveredEvt);
    sentMsg.remove(key);
    return false;
  }
  return false;
}
