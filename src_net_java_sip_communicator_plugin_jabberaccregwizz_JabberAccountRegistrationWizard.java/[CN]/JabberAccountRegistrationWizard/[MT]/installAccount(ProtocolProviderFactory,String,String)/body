{
  if (logger.isTraceEnabled()) {
    logger.trace("Preparing to install account for user " + userName);
  }
  Hashtable accountProperties=new Hashtable();
  if (registration.isRememberPassword()) {
    accountProperties.put(ProtocolProviderFactory.PASSWORD,passwd);
  }
  accountProperties.put("SEND_KEEP_ALIVE",String.valueOf(registration.isSendKeepAlive()));
  String serverName=null;
  if (registration.getServerAddress() != null) {
    serverName=registration.getServerAddress();
  }
 else {
    serverName=getServerFromUserName(userName);
  }
  accountProperties.put(ProtocolProviderFactory.SERVER_ADDRESS,serverName);
  accountProperties.put(ProtocolProviderFactory.SERVER_PORT,String.valueOf(registration.getPort()));
  accountProperties.put(ProtocolProviderFactory.RESOURCE,registration.getResource());
  accountProperties.put(ProtocolProviderFactory.RESOURCE_PRIORITY,String.valueOf(registration.getPriority()));
  if (isModification) {
    providerFactory.modifyAccount(protocolProvider,accountProperties);
    this.isModification=false;
    return protocolProvider;
  }
  try {
    if (logger.isTraceEnabled()) {
      logger.trace("Will install account for user " + userName + " with the following properties."+ accountProperties);
    }
    AccountID accountID=providerFactory.installAccount(userName,accountProperties);
    ServiceReference serRef=providerFactory.getProviderForAccount(accountID);
    protocolProvider=(ProtocolProviderService)JabberAccRegWizzActivator.bundleContext.getService(serRef);
  }
 catch (  IllegalArgumentException exc) {
    logger.warn("Failed to create a jabber account.",exc);
    JabberAccRegWizzActivator.getUIService().getPopupDialog().showMessagePopupDialog(exc.getMessage(),Resources.getString("service.gui.ERROR"),PopupDialog.ERROR_MESSAGE);
  }
catch (  IllegalStateException exc) {
    logger.warn("Failed to create a jabber account.",exc);
    JabberAccRegWizzActivator.getUIService().getPopupDialog().showMessagePopupDialog(exc.getMessage(),Resources.getString("service.gui.ERROR"),PopupDialog.ERROR_MESSAGE);
  }
  return protocolProvider;
}
