{
  Hashtable accountProperties=new Hashtable();
  if (registration.isRememberPassword()) {
    accountProperties.put(ProtocolProviderFactory.PASSWORD,passwd);
  }
  if (registration.isOverrideDefOptions()) {
    accountProperties.put(ProtocolProviderFactory.SERVER_ADDRESS,registration.getServerAddress());
    accountProperties.put(ProtocolProviderFactory.SERVER_PORT,String.valueOf(registration.getPort()));
  }
  if (protocolProvider != null) {
    providerFactory.uninstallAccount(protocolProvider.getAccountID());
    this.protocolProvider=null;
  }
  AccountID accountID=providerFactory.installAccount(user,accountProperties);
  configService.setProperty(propertiesPackage + ".REMEMBER_PASSWORD",new Boolean(registration.isRememberPassword()));
  ServiceReference serRef=providerFactory.getProviderForAccount(accountID);
  ProtocolProviderService protocolProvider=(ProtocolProviderService)JabberAccRegWizzActivator.bundleContext.getService(serRef);
  return protocolProvider;
}
