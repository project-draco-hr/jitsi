{
  BundleContext context=IcqActivator.getBundleContext();
  if (context == null)   throw new NullPointerException("The specified BundleContext was null");
  if ((IcqAccountID.isAIM(accountProperties) && !isAimFactory) || (!IcqAccountID.isAIM(accountProperties) && isAimFactory))   return null;
  if (!accountProperties.containsKey(PROTOCOL))   accountProperties.put(PROTOCOL,ProtocolNames.ICQ);
  String userIDStr=(String)accountProperties.get(USER_ID);
  AccountID accountID=new IcqAccountID(userIDStr,accountProperties);
  ProtocolProviderServiceIcqImpl icqProtocolProvider=new ProtocolProviderServiceIcqImpl();
  icqProtocolProvider.initialize(userIDStr,accountID);
  Hashtable properties=new Hashtable();
  properties.put(PROTOCOL,icqProtocolProvider.getProtocolName());
  properties.put(USER_ID,userIDStr);
  ServiceRegistration registration=context.registerService(ProtocolProviderService.class.getName(),icqProtocolProvider,properties);
  registeredAccounts.put(accountID,registration);
  return accountID;
}
