{
  try {
    if (evt.getEventType() != ChatRoomMessageReceivedEvent.CONVERSATION_MESSAGE_RECEIVED)     return;
    History history=this.getHistoryForMultiChat(evt.getSourceChatRoom());
    if (evt.isHistoryMessage()) {
      Collection<EventObject> c=findFirstMessagesAfter(evt.getSourceChatRoom(),evt.getTimestamp(),10);
      Iterator<EventObject> iter=c.iterator();
      boolean isPresent=false;
      while (iter.hasNext()) {
        EventObject e=iter.next();
        if (e instanceof ChatRoomMessageReceivedEvent) {
          ChatRoomMessageReceivedEvent cev=(ChatRoomMessageReceivedEvent)e;
          if (evt.getSourceChatRoomMember().getContactAddress().equals(cev.getSourceChatRoomMember().getContactAddress()) && evt.getTimestamp() != null && evt.getTimestamp().equals(cev.getTimestamp())) {
            isPresent=true;
            break;
          }
        }
      }
      if (isPresent)       return;
    }
    writeMessage(history,"in",evt.getSourceChatRoomMember(),evt.getMessage(),evt.getTimestamp());
  }
 catch (  IOException e) {
    logger.error("Could not add message to history",e);
  }
}
