{
  if (!(event.getSource() instanceof NetworkInterface))   return;
  NetworkInterface iface=(NetworkInterface)event.getSource();
  if (event.getType() == ChangeEvent.IFACE_UP) {
    if (connectedInterfaces.isEmpty()) {
      Iterator<ProtocolProviderService> iter=needsReconnection.iterator();
      while (iter.hasNext()) {
        ProtocolProviderService pp=iter.next();
        if (currentlyReconnecting.containsKey(pp)) {
          currentlyReconnecting.remove(pp).cancel();
        }
        reconnect(pp);
      }
      needsReconnection.clear();
    }
    connectedInterfaces.add(iface.getName());
  }
 else   if (event.getType() == ChangeEvent.IFACE_DOWN) {
    connectedInterfaces.remove(iface.getName());
    if (connectedInterfaces.size() > 0) {
      Iterator<Map.Entry<ProtocolProviderService,List<String>>> iter=autoReconnEnabledProviders.entrySet().iterator();
      while (iter.hasNext()) {
        Map.Entry<ProtocolProviderService,List<String>> entry=iter.next();
        if (entry.getValue().contains(iface.getName())) {
          ProtocolProviderService pp=entry.getKey();
          if (currentlyReconnecting.containsKey(pp)) {
            currentlyReconnecting.remove(pp).cancel();
          }
          reconnect(pp);
        }
      }
    }
 else {
      needsReconnection.addAll(autoReconnEnabledProviders.keySet());
      needsReconnection.addAll(currentlyReconnecting.keySet());
      Iterator<ProtocolProviderService> iter=needsReconnection.iterator();
      while (iter.hasNext()) {
        ProtocolProviderService pp=iter.next();
        if (currentlyReconnecting.containsKey(pp)) {
          currentlyReconnecting.remove(pp).cancel();
        }
        unregister(pp);
      }
      connectedInterfaces.clear();
      if (logger.isTraceEnabled())       logger.trace("Network is down!");
      notify("","plugin.reconnectplugin.NETWORK_DOWN",new String[0]);
    }
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Event received " + event + " src="+ event.getSource());
    traceCurrentPPState();
  }
}
