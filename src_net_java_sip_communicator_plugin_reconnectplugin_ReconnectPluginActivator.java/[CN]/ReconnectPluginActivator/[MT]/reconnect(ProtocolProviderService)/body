{
  long delay;
  if (currentlyReconnecting.containsKey(pp)) {
    delay=currentlyReconnecting.get(pp).delay;
    delay=Math.min(delay * 2,MAX_RECONNECT_DELAY * 1000);
  }
 else {
    delay=(long)(RECONNECT_DELAY_MIN + Math.random() * RECONNECT_DELAY_MAX) * 1000;
  }
  final ReconnectTask task=new ReconnectTask(pp);
  task.delay=delay;
  RegistrationStateChangeListener listener=new RegistrationStateChangeListener(){
    public void registrationStateChanged(    RegistrationStateChangeEvent evt){
      if (evt.getSource() instanceof ProtocolProviderService) {
        if (evt.getNewState().equals(RegistrationState.UNREGISTERED) || evt.getNewState().equals(RegistrationState.CONNECTION_FAILED)) {
synchronized (this) {
            pp.removeRegistrationStateChangeListener(this);
            if (timer == null)             return;
            currentlyReconnecting.put(pp,task);
            if (logger.isTraceEnabled())             logger.trace("Reconnect " + pp + " after "+ task.delay+ " ms.");
            timer.schedule(task,task.delay);
          }
        }
 else         if (evt.getNewState().equals(RegistrationState.REGISTERED)) {
          pp.removeRegistrationStateChangeListener(this);
        }
      }
    }
  }
;
  pp.addRegistrationStateChangeListener(listener);
  unregister(pp,true,listener,task);
}
