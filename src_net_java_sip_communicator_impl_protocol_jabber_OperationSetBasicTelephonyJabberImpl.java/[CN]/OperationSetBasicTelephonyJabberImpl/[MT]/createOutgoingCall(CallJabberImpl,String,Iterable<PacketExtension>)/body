{
  if (logger.isInfoEnabled())   logger.info("Creating outgoing call to " + calleeAddress);
  if (protocolProvider.getConnection() == null || call == null) {
    throw new OperationFailedException("Failed to create OutgoingJingleSession." + " We don't have a valid XMPPConnection.",OperationFailedException.INTERNAL_ERROR);
  }
  boolean isGoogle=protocolProvider.isGmailOrGoogleAppsAccount();
  boolean isGoogleVoice=false;
  if (isGoogle) {
    if (!calleeAddress.contains("@")) {
      calleeAddress+="@" + GOOGLE_VOICE_DOMAIN;
      isGoogleVoice=true;
    }
 else     if (calleeAddress.endsWith(GOOGLE_VOICE_DOMAIN)) {
      isGoogleVoice=true;
    }
  }
  AccountID accountID=getProtocolProvider().getAccountID();
  if (calleeAddress.indexOf('@') == -1) {
    String phoneSuffix=accountID.getAccountPropertyString("OVERRIDE_PHONE_SUFFIX");
    String serviceName=null;
    if ((phoneSuffix == null) || (phoneSuffix.length() == 0))     serviceName=StringUtils.parseServer(accountID.getUserID());
 else     serviceName=phoneSuffix;
    calleeAddress=calleeAddress + "@" + serviceName;
  }
  String bypassDomain=accountID.getAccountPropertyString("TELEPHONY_BYPASS_GTALK_CAPS");
  boolean alwaysCallGtalk=((bypassDomain != null) && bypassDomain.equals(calleeAddress.substring(calleeAddress.indexOf('@') + 1))) || isGoogleVoice;
  String fullCalleeURI=null;
  DiscoverInfo di=null;
  int bestPriority=-1;
  if (!getProtocolProvider().getConnection().getRoster().contains(StringUtils.parseBareAddress(calleeAddress)) && !alwaysCallGtalk) {
    throw new OperationFailedException(calleeAddress + " does not belong to our contact list",OperationFailedException.NOT_FOUND);
  }
  Iterator<Presence> it=getProtocolProvider().getConnection().getRoster().getPresences(calleeAddress);
  String calleeURI=null;
  boolean isGingle=false;
  String gingleURI=null;
  PresenceStatus jabberStatus=null;
  while (it.hasNext()) {
    Presence presence=it.next();
    int priority=(presence.getPriority() == Integer.MIN_VALUE) ? 0 : presence.getPriority();
    calleeURI=presence.getFrom();
    DiscoverInfo discoverInfo=null;
    try {
      discoverInfo=protocolProvider.getDiscoveryManager().discoverInfo(calleeURI);
    }
 catch (    XMPPException ex) {
      logger.warn("could not retrieve info for " + fullCalleeURI,ex);
    }
    boolean hasGtalkCaps=getProtocolProvider().isExtFeatureListSupported(calleeURI,ProtocolProviderServiceJabberImpl.CAPS_GTALK_WEB_VOICE);
    if (discoverInfo != null && discoverInfo.containsFeature(ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE)) {
      if (priority > bestPriority) {
        bestPriority=priority;
        di=discoverInfo;
        fullCalleeURI=calleeURI;
        isGingle=false;
        jabberStatus=OperationSetPersistentPresenceJabberImpl.jabberStatusToPresenceStatus(presence,protocolProvider);
      }
 else       if (priority == bestPriority && jabberStatus != null) {
        PresenceStatus tempStatus=OperationSetPersistentPresenceJabberImpl.jabberStatusToPresenceStatus(presence,protocolProvider);
        if (tempStatus.compareTo(jabberStatus) > 0) {
          di=discoverInfo;
          fullCalleeURI=calleeURI;
          isGingle=false;
          jabberStatus=tempStatus;
        }
      }
    }
 else     if (protocolProvider.isGTalkTesting() && (hasGtalkCaps || alwaysCallGtalk)) {
      if (priority > bestPriority) {
        bestPriority=priority;
        isGingle=true;
        gingleURI=calleeURI;
        jabberStatus=OperationSetPersistentPresenceJabberImpl.jabberStatusToPresenceStatus(presence,protocolProvider);
      }
 else       if (priority == bestPriority && jabberStatus != null) {
        PresenceStatus tempStatus=OperationSetPersistentPresenceJabberImpl.jabberStatusToPresenceStatus(presence,protocolProvider);
        if (tempStatus.compareTo(jabberStatus) > 0) {
          isGingle=true;
          gingleURI=calleeURI;
          jabberStatus=OperationSetPersistentPresenceJabberImpl.jabberStatusToPresenceStatus(presence,protocolProvider);
        }
      }
    }
  }
  if (isGingle) {
    if (logger.isInfoEnabled())     logger.info(gingleURI + ": Google Talk dialect supported");
    fullCalleeURI=gingleURI;
  }
 else   if (di != null) {
    if (logger.isInfoEnabled())     logger.info(fullCalleeURI + ": jingle supported ");
  }
 else {
    if (logger.isInfoEnabled())     logger.info(calleeURI + ": jingle and Google Talk not supported?");
    throw new OperationFailedException("Failed to create OutgoingJingleSession.\n" + calleeURI + " does not support jingle or Google Talk",OperationFailedException.INTERNAL_ERROR);
  }
  if (logger.isInfoEnabled())   logger.info("Full JID for outgoing call: " + fullCalleeURI + ", priority "+ bestPriority);
  AbstractCallPeer<?,?> peer=null;
  try {
    if (isGingle) {
      logger.info("initiate Gingle call");
      CallGTalkImpl callGTalk=new CallGTalkImpl(this);
      CallConference conference=call.getConference();
      MediaUseCase useCase=call.getMediaUseCase();
      boolean video=call.isLocalVideoAllowed(useCase);
      call.setConference(null);
      callGTalk.setConference(conference);
      callGTalk.setLocalVideoAllowed(video,useCase);
      peer=callGTalk.initiateGTalkSession(fullCalleeURI,sessionInitiateExtensions);
    }
 else     if (di != null) {
      peer=call.initiateSession(fullCalleeURI,di,sessionInitiateExtensions);
    }
  }
 catch (  Throwable t) {
    if (t instanceof ThreadDeath)     throw (ThreadDeath)t;
 else {
      ProtocolProviderServiceJabberImpl.throwOperationFailedException("Failed to create a call to " + fullCalleeURI,OperationFailedException.INTERNAL_ERROR,t,logger);
    }
  }
  return peer;
}
