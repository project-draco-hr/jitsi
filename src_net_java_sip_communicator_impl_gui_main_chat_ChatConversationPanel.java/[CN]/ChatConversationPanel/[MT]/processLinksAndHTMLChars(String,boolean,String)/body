{
  Matcher m=URL_PATTERN.matcher(message);
  StringBuffer msgBuffer=new StringBuffer();
  int prevEnd=0;
  while (m.find()) {
    final String rawMessage=message.substring(prevEnd,m.start());
    final String fromPrevEndToStart;
    if (processHTMLChars) {
      fromPrevEndToStart=StringEscapeUtils.escapeHtml4(rawMessage);
    }
 else {
      fromPrevEndToStart=rawMessage;
    }
    msgBuffer.append(fromPrevEndToStart);
    prevEnd=m.end();
    String url=m.group().trim();
    msgBuffer.append("<A href=\"");
    if (url.startsWith("www"))     msgBuffer.append("http://");
    msgBuffer.append(url);
    msgBuffer.append("\">");
    msgBuffer.append(StringEscapeUtils.escapeHtml4(url));
    msgBuffer.append("</A>");
  }
  final String rawMessage=message.substring(prevEnd);
  final String fromPrevEndToEnd;
  if (processHTMLChars) {
    fromPrevEndToEnd=StringEscapeUtils.escapeHtml4(rawMessage);
  }
 else {
    fromPrevEndToEnd=rawMessage;
  }
  msgBuffer.append(fromPrevEndToEnd);
  return msgBuffer.toString();
}
