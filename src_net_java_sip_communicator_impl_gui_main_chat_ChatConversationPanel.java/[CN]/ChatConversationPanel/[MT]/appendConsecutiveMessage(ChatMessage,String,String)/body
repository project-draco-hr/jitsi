{
  if (!SwingUtilities.isEventDispatchThread()) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        appendConsecutiveMessage(chatMessage,keyword,contentType);
      }
    }
);
    return;
  }
  Element lastMsgElement=document.getElement(ChatHtmlUtils.MESSAGE_TEXT_ID + lastMessageUID);
  String contactAddress=(String)lastMsgElement.getAttributes().getAttribute(Attribute.NAME);
  String newMessage=ChatHtmlUtils.createMessageTag(chatMessage.getMessageUID(),contactAddress,formatMessage(chatMessage.getMessage(),contentType,keyword),contentType,chatMessage.getDate(),false,isSimpleTheme);
synchronized (scrollToBottomRunnable) {
    try {
      Element parentElement=lastMsgElement.getParentElement();
      document.insertBeforeEnd(parentElement,newMessage);
      replaceMessageDivID(document.getElement(ChatHtmlUtils.MESSAGE_DIV_ID + lastMessageUID),lastMessageUID,chatMessage.getMessageUID());
      lastMessageUID=chatMessage.getMessageUID();
      SwingUtilities.invokeLater(scrollToBottomRunnable);
    }
 catch (    BadLocationException ex) {
      logger.error("Could not replace chat message",ex);
    }
catch (    IOException ex) {
      logger.error("Could not replace chat message",ex);
    }
  }
  finishMessageAdd(newMessage,contentType);
}
