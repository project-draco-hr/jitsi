{
  StringWriter msgDivWriter=new StringWriter();
  try {
    editorKit.write(msgDivWriter,document,0,document.getLength());
    String msgDivString=msgDivWriter.toString();
    String newMsgDivString=msgDivString.replaceFirst(ChatHtmlUtils.MESSAGE_DIV_ID + lastMessageUID,ChatHtmlUtils.MESSAGE_DIV_ID + newMessageUID);
    int msgStartIndex=newMsgDivString.indexOf("<div id=\"" + ChatHtmlUtils.MESSAGE_DIV_ID + newMessageUID);
    int msgEndIndex;
    int nextDivIndex=newMsgDivString.indexOf("<div id=\"" + ChatHtmlUtils.MESSAGE_DIV_ID,msgStartIndex + 1);
    if (nextDivIndex > 0) {
      msgEndIndex=newMsgDivString.substring(msgStartIndex,nextDivIndex).lastIndexOf("</div>");
    }
 else     msgEndIndex=newMsgDivString.lastIndexOf("</div>");
    document.setOuterHTML(messageDivElement,newMsgDivString.substring(msgStartIndex,msgEndIndex + 6));
  }
 catch (  IOException e) {
    e.printStackTrace();
  }
catch (  BadLocationException e) {
    e.printStackTrace();
  }
}
