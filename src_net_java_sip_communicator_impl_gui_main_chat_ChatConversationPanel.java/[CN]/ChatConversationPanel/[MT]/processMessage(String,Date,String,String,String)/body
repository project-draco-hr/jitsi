{
  if (!isHistory && (messageType.equals(Constants.HISTORY_INCOMING_MESSAGE) || messageType.equals(Constants.HISTORY_OUTGOING_MESSAGE)) && (date.compareTo(pageFirstMsgTimestamp) < 0)) {
    pageFirstMsgTimestamp=date;
  }
  if (!isHistory && (messageType.equals(Constants.HISTORY_INCOMING_MESSAGE) || messageType.equals(Constants.HISTORY_OUTGOING_MESSAGE)) && (date.compareTo(pageLastMsgTimestamp) > 0)) {
    pageLastMsgTimestamp=date;
  }
  String dateString=DateFormat.getDateTimeInstance(DateFormat.LONG,DateFormat.LONG).format(date);
  String chatString="";
  String endHeaderTag="";
  String timeString="";
  String startDivTag="<DIV id=\"message\">";
  String startHistoryDivTag="<DIV id=\"message\" style=\"color:#707070;\">";
  String endDivTag="</DIV>";
  String startPlainTextTag;
  String endPlainTextTag;
  if (contentType.equals(HTML_CONTENT_TYPE)) {
    startPlainTextTag="";
    endPlainTextTag="";
  }
 else {
    startPlainTextTag="<PLAINTEXT>";
    endPlainTextTag="</PLAINTEXT>";
  }
  Calendar calendar=Calendar.getInstance();
  calendar.setTime(date);
  if (GuiUtils.compareDates(date,new Date(System.currentTimeMillis())) < 0) {
    timeString=GuiUtils.formatDate(date) + " ";
  }
  if (messageType.equals(Constants.INCOMING_MESSAGE)) {
    this.lastIncomingMsgTimestamp=new Date();
    chatString="<h2 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h2>";
    chatString+=timeString + contactName + " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ startDivTag+ startPlainTextTag+ formatMessage(message,contentType)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Constants.OUTGOING_MESSAGE)) {
    chatString="<h3 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h3>";
    chatString+=timeString + Messages.getI18NString("me").getText() + " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ startDivTag+ startPlainTextTag+ formatMessage(message,contentType)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Constants.SYSTEM_MESSAGE)) {
    chatString="<h4 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h4>";
    chatString+=GuiUtils.formatTime(date) + " " + contactName+ " "+ message+ endHeaderTag;
  }
 else   if (messageType.equals(Constants.ERROR_MESSAGE)) {
    chatString="<h6 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h6>";
    String errorIcon="<IMG SRC='" + ImageLoader.getImagePath(ImageLoader.getImage(ImageLoader.EXCLAMATION_MARK)) + "' </IMG>";
    chatString+=errorIcon + Messages.getI18NString("msgDeliveryFailure").getText() + endHeaderTag+ "<h5>"+ message+ "</h5>";
  }
 else   if (messageType.equals(Constants.HISTORY_INCOMING_MESSAGE)) {
    chatString="<h2 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h2>";
    chatString+=timeString + contactName + " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ startHistoryDivTag+ startPlainTextTag+ formatMessage(message,contentType)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Constants.HISTORY_OUTGOING_MESSAGE)) {
    chatString="<h3 id=\"header\" date=\"" + dateString + "\">";
    endHeaderTag="</h3>";
    chatString+=timeString + Messages.getI18NString("me").getText() + " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ startHistoryDivTag+ startPlainTextTag+ formatMessage(message,contentType)+ endPlainTextTag+ endDivTag;
  }
  messagesPerPage++;
  return chatString;
}
