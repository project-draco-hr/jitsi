{
  String contactName=chatMessage.getContactName();
  String contactDisplayName=chatMessage.getContactDisplayName();
  if (contactDisplayName == null || contactDisplayName.trim().length() <= 0)   contactDisplayName=contactName;
  String contentType=chatMessage.getContentType();
  long date=chatMessage.getDate();
  String messageType=chatMessage.getMessageType();
  String messageTitle=chatMessage.getMessageTitle();
  String message=chatMessage.getMessage();
  String messageUID=chatMessage.getMessageUID();
  String msgID="message";
  String msgHeaderID="messageHeader";
  String chatString="";
  String endHeaderTag="";
  String dateString=getDateString(date);
  String idAttr=messageUID == null ? "" : " id='" + messageUID + "'";
  String dateAttr=" date='" + date + "'";
  String editedAtTag=generateEditedAtTag(messageUID,-1);
  String startDivTag="<DIV identifier=\"" + msgID + "\""+ idAttr+ ">";
  String startHistoryDivTag="<DIV identifier=\"" + msgID + "\" style=\"color:#707070;\">";
  String startSystemDivTag="<DIV identifier=\"systemMessage\" style=\"color:#627EB7;\">";
  String endDivTag="</DIV>";
  String startPlainTextTag;
  String endPlainTextTag;
  if (HTML_CONTENT_TYPE.equals(contentType)) {
    startPlainTextTag="";
    endPlainTextTag="";
  }
 else {
    startPlainTextTag=START_PLAINTEXT_TAG;
    endPlainTextTag=END_PLAINTEXT_TAG;
  }
  if (messageType.equals(Chat.INCOMING_MESSAGE)) {
    this.lastIncomingMsgTimestamp=System.currentTimeMillis();
    chatString="<h2 identifier=\"" + msgHeaderID + "\""+ dateAttr+ ">"+ "<a style=\"color:#ef7b1e;"+ "font-weight:bold;"+ "text-decoration:none;\" "+ "href=\""+ contactName+ "\">";
    endHeaderTag="</a></h2>";
    chatString+=dateString + contactDisplayName + " at "+ GuiUtils.formatTime(date)+ editedAtTag+ endHeaderTag+ startDivTag+ startPlainTextTag+ formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Chat.SMS_MESSAGE)) {
    chatString="<h2 identifier=\"" + msgHeaderID + "\" date=\""+ date+ "\">";
    endHeaderTag="</h2>";
    chatString+="SMS: " + dateString + contactName+ " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ startDivTag+ startPlainTextTag+ formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Chat.OUTGOING_MESSAGE)) {
    chatString="<h3 identifier=\"" + msgHeaderID + "\""+ dateAttr+ ">"+ "<a style=\"color:#2e538b;"+ "font-weight:bold;"+ "text-decoration:none;\" "+ "href=\""+ contactName+ "\">";
    endHeaderTag="</a></h3>";
    chatString+=dateString + contactDisplayName + " at "+ GuiUtils.formatTime(date)+ editedAtTag+ endHeaderTag+ startDivTag+ startPlainTextTag+ formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Chat.STATUS_MESSAGE)) {
    chatString="<h4 identifier=\"statusMessage\" date=\"" + date + "\">";
    endHeaderTag="</h4>";
    chatString+=GuiUtils.formatTime(date) + " " + contactName+ " "+ message+ endHeaderTag;
  }
 else   if (messageType.equals(Chat.ACTION_MESSAGE)) {
    chatString="<p identifier=\"actionMessage\" date=\"" + date + "\">";
    endHeaderTag="</p>";
    chatString+="* " + GuiUtils.formatTime(date) + " "+ contactName+ " "+ message+ endHeaderTag;
  }
 else   if (messageType.equals(Chat.SYSTEM_MESSAGE)) {
    chatString+=startSystemDivTag + startPlainTextTag + formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Chat.ERROR_MESSAGE)) {
    chatString="<h6 identifier=\"" + msgHeaderID + "\" date=\""+ date+ "\">";
    endHeaderTag="</h6>";
    String errorIcon="<IMG SRC='" + ImageLoader.getImageUri(ImageLoader.EXCLAMATION_MARK) + "' </IMG>";
    chatString+=errorIcon + messageTitle + endHeaderTag+ "<h5>"+ message+ "</h5>";
  }
 else   if (messageType.equals(Chat.HISTORY_INCOMING_MESSAGE)) {
    chatString="<h2 identifier=\"" + msgHeaderID + "\""+ dateAttr+ ">"+ "<a style=\"color:#ef7b1e;"+ "font-weight:bold;"+ "text-decoration:none;\" "+ "href=\""+ contactName+ "\">";
    endHeaderTag="</a></h2>";
    chatString+=dateString + contactDisplayName + " at "+ GuiUtils.formatTime(date)+ endHeaderTag+ editedAtTag+ startHistoryDivTag+ startPlainTextTag+ formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
 else   if (messageType.equals(Chat.HISTORY_OUTGOING_MESSAGE)) {
    chatString="<h3 identifier=\"" + msgHeaderID + "\""+ dateAttr+ ">"+ "<a style=\"color:#2e538b;"+ "font-weight:bold;"+ "text-decoration:none;\" "+ "href=\""+ contactName+ "\">";
    endHeaderTag="</h3>";
    chatString+=dateString + contactDisplayName + " at "+ GuiUtils.formatTime(date)+ editedAtTag+ endHeaderTag+ startHistoryDivTag+ startPlainTextTag+ formatMessage(message,contentType,keyword)+ endPlainTextTag+ endDivTag;
  }
  return chatString;
}
