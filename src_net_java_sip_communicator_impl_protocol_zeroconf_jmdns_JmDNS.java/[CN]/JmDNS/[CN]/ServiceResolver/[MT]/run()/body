{
  try {
    if (state == DNSState.ANNOUNCED) {
      if (count++ < 3) {
        logger.debug("run() JmDNS querying service");
        long now=System.currentTimeMillis();
        DNSOutgoing out=new DNSOutgoing(DNSConstants.FLAGS_QR_QUERY);
        out.addQuestion(new DNSQuestion(type,DNSConstants.TYPE_PTR,DNSConstants.CLASS_IN));
        for (Iterator s=services.values().iterator(); s.hasNext(); ) {
          final ServiceInfo info=(ServiceInfo)s.next();
          try {
            out.addAnswer(new DNSRecord.Pointer(info.type,DNSConstants.TYPE_PTR,DNSConstants.CLASS_IN,DNSConstants.DNS_TTL,info.getQualifiedName()),now);
          }
 catch (          IOException ee) {
            break;
          }
        }
        send(out);
      }
 else {
        this.cancel();
      }
    }
 else {
      if (state == DNSState.CANCELED) {
        this.cancel();
      }
    }
  }
 catch (  Throwable e) {
    logger.log(Level.WARNING,"run() exception ",e);
    recover();
  }
}
