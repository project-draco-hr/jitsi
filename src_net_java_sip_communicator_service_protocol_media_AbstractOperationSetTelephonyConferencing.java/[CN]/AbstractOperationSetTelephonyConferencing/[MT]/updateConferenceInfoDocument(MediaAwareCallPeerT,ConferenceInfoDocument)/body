{
  ConferenceInfoDocument ourDocument=callPeer.getLastConferenceInfoReceived();
  ConferenceInfoDocument newDocument;
  ConferenceInfoDocument.State usersState=diff.getUsersState();
  if (usersState == ConferenceInfoDocument.State.FULL) {
    newDocument=diff;
    newDocument.setState(ConferenceInfoDocument.State.FULL);
  }
 else   if (usersState == ConferenceInfoDocument.State.DELETED) {
    try {
      newDocument=new ConferenceInfoDocument();
    }
 catch (    XMLException e) {
      logger.warn("Could not create a new ConferenceInfoDocument",e);
      return -1;
    }
    newDocument.setVersion(diff.getVersion());
    newDocument.setEntity(diff.getEntity());
    newDocument.setUserCount(diff.getUserCount());
  }
 else {
    newDocument=ourDocument;
    newDocument.setVersion(diff.getVersion());
    newDocument.setEntity(diff.getEntity());
    newDocument.setUserCount(diff.getUserCount());
    for (    ConferenceInfoDocument.User user : diff.getUsers()) {
      ConferenceInfoDocument.State userState=user.getState();
      if (userState == ConferenceInfoDocument.State.FULL) {
        newDocument.removeUser(user.getEntity());
        ConferenceInfoDocument.User newUser=newDocument.addNewUser(user.getEntity());
        for (        ConferenceInfoDocument.Endpoint endpoint : user.getEndpoints()) {
          ConferenceInfoDocument.Endpoint newEndpoint=newUser.addNewEndpoint(endpoint.getEntity());
          newEndpoint.setStatus(endpoint.getStatus());
          for (          ConferenceInfoDocument.Media media : endpoint.getMedias()) {
            ConferenceInfoDocument.Media newMedia=newEndpoint.addNewMedia(media.getId());
            newMedia.setStatus(media.getStatus());
            newMedia.setSrcId(media.getSrcId());
            newMedia.setType(media.getType());
          }
        }
      }
 else       if (userState == ConferenceInfoDocument.State.DELETED) {
        newDocument.removeUser(user.getEntity());
      }
 else {
        ConferenceInfoDocument.User ourUser=newDocument.getUser(user.getEntity());
        for (        ConferenceInfoDocument.Endpoint endpoint : user.getEndpoints()) {
          ConferenceInfoDocument.State endpointState=endpoint.getState();
          if (endpointState == ConferenceInfoDocument.State.FULL) {
            ourUser.removeEndpoint(endpoint.getEntity());
            ConferenceInfoDocument.Endpoint newEndpoint=ourUser.addNewEndpoint(endpoint.getEntity());
            newEndpoint.setStatus(endpoint.getStatus());
            for (            ConferenceInfoDocument.Media media : endpoint.getMedias()) {
              ConferenceInfoDocument.Media newMedia=newEndpoint.addNewMedia(media.getId());
              newMedia.setStatus(media.getStatus());
              newMedia.setSrcId(media.getSrcId());
              newMedia.setType(media.getType());
            }
          }
 else           if (endpointState == ConferenceInfoDocument.State.DELETED) {
            ourUser.removeEndpoint(endpoint.getEntity());
          }
 else {
            ConferenceInfoDocument.Endpoint ourEndpoint=ourUser.getEndpoint(endpoint.getEntity());
            for (            ConferenceInfoDocument.Media media : endpoint.getMedias()) {
              ConferenceInfoDocument.Media newMedia=ourEndpoint.addNewMedia(media.getId());
              newMedia.setStatus(media.getStatus());
              newMedia.setSrcId(media.getSrcId());
              newMedia.setType(media.getType());
            }
          }
        }
      }
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Applied a partial conference-info notification. " + " Base: " + ourDocument + "\nDiff: "+ diff+ "\nResult:"+ newDocument);
  }
  return setConferenceInfoDocument(callPeer,newDocument);
}
