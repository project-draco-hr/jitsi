{
  RegistrationState newState=evt.getNewState();
  if (RegistrationState.UNREGISTERED.equals(newState)) {
    if (!FacebookStatusEnum.OFFLINE.equals(presenceStatus)) {
      PresenceStatus oldValue=presenceStatus;
      presenceStatus=FacebookStatusEnum.OFFLINE;
      fireProviderStatusChangeEvent(oldValue,presenceStatus);
    }
  }
 else   if (!newState.equals(RegistrationState.AUTHENTICATION_FAILED) && !newState.equals(RegistrationState.CONNECTION_FAILED))   return;
  Iterator<ContactGroup> groupsIter=getServerStoredContactListRoot().subgroups();
  while (groupsIter.hasNext()) {
    ContactGroup group=groupsIter.next();
    Iterator<Contact> contactsIter=group.contacts();
    while (contactsIter.hasNext()) {
      ContactFacebookImpl contact=(ContactFacebookImpl)contactsIter.next();
      PresenceStatus oldContactStatus=contact.getPresenceStatus();
      if (!oldContactStatus.isOnline())       continue;
      contact.setPresenceStatus(FacebookStatusEnum.OFFLINE);
      fireContactPresenceStatusChangeEvent(contact,contact.getParentContactGroup(),oldContactStatus);
    }
  }
}
