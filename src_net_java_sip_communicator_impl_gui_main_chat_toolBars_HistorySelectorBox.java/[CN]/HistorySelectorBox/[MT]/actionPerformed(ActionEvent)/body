{
  String menuItemName=((JMenuItem)e.getSource()).getName();
  ChatPanel chatPanel=chatContainer.getCurrentChat();
  if (menuItemName.equals("history")) {
    HistoryWindow history;
    HistoryWindowManager historyWindowManager=GuiActivator.getUIService().getHistoryWindowManager();
    ChatSession chatSession=chatPanel.getChatSession();
    if (historyWindowManager.containsHistoryWindowForContact(chatSession.getDescriptor())) {
      history=historyWindowManager.getHistoryWindowForContact(chatSession.getDescriptor());
      if (history.getState() == JFrame.ICONIFIED)       history.setState(JFrame.NORMAL);
      history.toFront();
    }
 else {
      history=new HistoryWindow(chatPanel.getChatSession().getDescriptor());
      history.setVisible(true);
      historyWindowManager.addHistoryWindowForContact(chatSession.getDescriptor(),history);
    }
  }
 else   if (menuItemName.equals("toggleAllHistory")) {
    boolean isHistoryEnabled=ConfigurationUtils.isHistoryLoggingEnabled();
    ConfigurationUtils.setHistoryLoggingEnabled(!isHistoryEnabled);
  }
 else   if (menuItemName.equals("toggleHistoryPerContact")) {
    Object desc=chatPanel.getChatSession().getDescriptor();
    if (desc instanceof MetaContact) {
      MetaContact currentContact=(MetaContact)desc;
      boolean isHistoryEnabled=ConfigurationUtils.isHistoryLoggingEnabled(currentContact);
      ConfigurationUtils.setHistoryLoggingEnabled(!isHistoryEnabled,currentContact);
    }
  }
 else   if (menuItemName.equals("eraseHistoryPerContact")) {
    Object desc=chatPanel.getChatSession().getDescriptor();
    if (!(desc instanceof MetaContact))     return;
    MetaContact contact=(MetaContact)desc;
    MessageDialog dialog=new MessageDialog(null,GuiActivator.getResources().getI18NString("service.gui.WARNING"),GuiActivator.getResources().getI18NString("service.gui.HISTORY_REMOVE_PER_CONTACT_WARNING",new String[]{contact.getDisplayName()}),GuiActivator.getResources().getI18NString("service.gui.OK"),false);
    if (dialog.showDialog() == MessageDialog.OK_RETURN_CODE) {
      try {
        ServiceUtils.getService(GuiActivator.bundleContext,MessageHistoryService.class).eraseLocallyStoredHistory(contact);
      }
 catch (      IOException ex) {
        logger.error("Error removing history",ex);
        chatPanel.addErrorMessage(contact.getDisplayName(),GuiActivator.getResources().getI18NString("service.gui.HISTORY_REMOVE_ERROR"),ex.getLocalizedMessage());
      }
    }
  }
 else   if (menuItemName.equals("eraseAllHistory")) {
    MessageDialog dialog=new MessageDialog(null,GuiActivator.getResources().getI18NString("service.gui.WARNING"),GuiActivator.getResources().getI18NString("service.gui.HISTORY_REMOVE_ALL_WARNING"),GuiActivator.getResources().getI18NString("service.gui.OK"),false);
    if (dialog.showDialog() == MessageDialog.OK_RETURN_CODE) {
      try {
        ServiceUtils.getService(GuiActivator.bundleContext,MessageHistoryService.class).eraseLocallyStoredHistory();
      }
 catch (      IOException ex) {
        logger.error("Error removing history",ex);
        chatPanel.addErrorMessage("all",GuiActivator.getResources().getI18NString("service.gui.HISTORY_REMOVE_ERROR"),ex.getLocalizedMessage());
      }
    }
  }
}
