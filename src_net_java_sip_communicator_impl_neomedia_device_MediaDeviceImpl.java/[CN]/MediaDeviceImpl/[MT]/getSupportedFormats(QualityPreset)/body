{
  EncodingConfiguration encodingConfiguration=NeomediaActivator.getMediaServiceImpl().getEncodingConfiguration();
  MediaFormat[] supportedEncodings=encodingConfiguration.getSupportedEncodings(getMediaType());
  List<MediaFormat> supportedFormats=new ArrayList<MediaFormat>();
  if (supportedEncodings != null)   for (  MediaFormat supportedEncoding : supportedEncodings)   supportedFormats.add(supportedEncoding);
  if (preset != null) {
    MediaFormat customFormat=null;
    MediaFormat toRemove=null;
    for (    MediaFormat f : supportedFormats) {
      if ("h264".equalsIgnoreCase(f.getEncoding())) {
        Map<String,String> h264AdvancedAttributes=f.getAdvancedAttributes();
        if (h264AdvancedAttributes == null)         h264AdvancedAttributes=new HashMap<String,String>();
        h264AdvancedAttributes.put("imageattr",MediaUtils.createImageAttr(null,preset.getResolution()));
        customFormat=NeomediaActivator.getMediaServiceImpl().getFormatFactory().createMediaFormat(f.getEncoding(),f.getClockRate(),f.getFormatParameters(),h264AdvancedAttributes);
        toRemove=f;
      }
    }
    if (toRemove != null && customFormat != null) {
      supportedFormats.remove(toRemove);
      supportedFormats.add(customFormat);
    }
  }
  return supportedFormats;
}
