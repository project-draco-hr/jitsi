{
  if (!(packet instanceof org.jivesoftware.smack.packet.Message))   return;
  PacketExtension ext=packet.getExtension(WhiteboardObjectPacketExtensionImpl.ELEMENT_NAME,WhiteboardObjectPacketExtensionImpl.NAMESPACE);
  org.jivesoftware.smack.packet.Message msg=(org.jivesoftware.smack.packet.Message)packet;
  if (ext == null)   return;
  String fromUserID=StringUtils.parseBareAddress(msg.getFrom());
  if (logger.isDebugEnabled()) {
    logger.debug("Received from " + fromUserID + " the message "+ msg.toXML());
  }
  OperationSetPersistentPresenceJabberImpl presenceOpSet=(OperationSetPersistentPresenceJabberImpl)jabberProvider.getOperationSet(OperationSetPresence.class);
  if (presenceOpSet == null)   return;
  Contact sourceContact=presenceOpSet.findContactByID(fromUserID);
  if (!wbParticipants.containsKey(sourceContact.getAddress()))   return;
  WhiteboardObjectPacketExtensionImpl newMessage=(WhiteboardObjectPacketExtensionImpl)ext;
  if (msg.getType() == org.jivesoftware.smack.packet.Message.Type.error) {
    logger.info("WBObject error received from " + fromUserID);
    int errorCode=packet.getError().getCode();
    int errorResultCode=WhiteboardObjectDeliveryFailedEvent.UNKNOWN_ERROR;
    if (errorCode == 503) {
      org.jivesoftware.smackx.packet.MessageEvent msgEvent=(org.jivesoftware.smackx.packet.MessageEvent)packet.getExtension("x","jabber:x:event");
      if (msgEvent != null && msgEvent.isOffline()) {
        errorResultCode=WhiteboardObjectDeliveryFailedEvent.OFFLINE_MESSAGES_NOT_SUPPORTED;
      }
    }
    WhiteboardObjectDeliveryFailedEvent evt=new WhiteboardObjectDeliveryFailedEvent(WhiteboardSessionJabberImpl.this,newMessage.getWhiteboardObject(),sourceContact,errorResultCode,new Date());
    fireMessageEvent(evt);
    return;
  }
  if (newMessage.getAction().equals(WhiteboardObjectPacketExtensionImpl.ACTION_DELETE)) {
    WhiteboardObjectDeletedEvent msgDeletedEvt=new WhiteboardObjectDeletedEvent(WhiteboardSessionJabberImpl.this,newMessage.getWhiteboardObjectID(),sourceContact,new Date());
    fireMessageEvent(msgDeletedEvt);
  }
 else   if (newMessage.getAction().equals(WhiteboardObjectPacketExtensionImpl.ACTION_DRAW)) {
    WhiteboardObjectReceivedEvent msgReceivedEvt=new WhiteboardObjectReceivedEvent(WhiteboardSessionJabberImpl.this,newMessage.getWhiteboardObject(),sourceContact,new Date());
    fireMessageEvent(msgReceivedEvt);
  }
}
