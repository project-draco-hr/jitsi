{
  BundleContext bundleContext=getBundleContext();
  if (bundleContext == null)   throw new NullPointerException("The specified BundleContext was null");
  if (accountProperties == null)   throw new NullPointerException("The specified property map was null");
  String userID=(String)accountProperties.get(USER_ID);
  if (userID == null)   throw new NullPointerException("The account properties contained no user id.");
  String protocolName=getProtocolName();
  if (!accountProperties.containsKey(PROTOCOL))   accountProperties.put(PROTOCOL,protocolName);
  AccountID accountID=createAccountID(userID,accountProperties);
  ProtocolProviderService service=createService(userID,accountID);
  Dictionary<String,String> properties=new Hashtable<String,String>();
  properties.put(PROTOCOL,protocolName);
  properties.put(USER_ID,userID);
  ServiceRegistration serviceRegistration=bundleContext.registerService(ProtocolProviderService.class.getName(),service,properties);
synchronized (registeredAccounts) {
    registeredAccounts.put(accountID,serviceRegistration);
  }
  return accountID;
}
