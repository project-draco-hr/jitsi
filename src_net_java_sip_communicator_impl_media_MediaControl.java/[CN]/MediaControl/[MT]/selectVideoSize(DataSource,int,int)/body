{
  FormatControl formatControl=(FormatControl)videoDS.getControl(FormatControl.class.getName());
  if (formatControl == null)   return null;
  Format[] formats=formatControl.getSupportedFormats();
  final int count=formats.length;
  if (count < 1)   return null;
  Format selectedFormat=null;
  if (count == 1)   selectedFormat=formats[0];
 else {
class FormatInfo {
      public final VideoFormat format;
      public final double difference;
      public FormatInfo(      VideoFormat format){
        this.format=format;
        Dimension size=format.getSize();
        int width=size.width;
        double xScale=(width == preferredWidth) ? 1 : (preferredWidth / (double)width);
        int height=size.height;
        double yScale=(height == preferredHeight) ? 1 : preferredHeight / (double)height;
        difference=Math.abs(1 - Math.min(xScale,yScale));
      }
    }
    FormatInfo[] infos=new FormatInfo[count];
    for (int i=0; i < count; i++) {
      FormatInfo info=infos[i]=new FormatInfo((VideoFormat)formats[i]);
      if (info.difference == 0) {
        selectedFormat=info.format;
        break;
      }
    }
    if (selectedFormat == null) {
      Arrays.sort(infos,new Comparator<FormatInfo>(){
        public int compare(        FormatInfo info0,        FormatInfo info1){
          return Double.compare(info0.difference,info1.difference);
        }
      }
);
      selectedFormat=infos[0].format;
    }
  }
  formatControl.setFormat(selectedFormat);
  return ((VideoFormat)selectedFormat).getSize();
}
