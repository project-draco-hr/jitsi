{
  if (isConnected() == false)   throw new IllegalStateException("Please connect to an IRC server first");
  if (chatroom == null)   throw new IllegalArgumentException("chatroom cannot be null");
  if (password == null)   throw new IllegalArgumentException("password cannot be null");
  if (this.joined.containsKey(chatroom.getIdentifier()) || chatroom.isPrivate()) {
    return;
  }
  LOGGER.trace("Start joining channel " + chatroom.getIdentifier());
  final Exception[] joinSignal=new Exception[1];
synchronized (joinSignal) {
    try {
      LOGGER.trace("Issue join channel command to IRC library and wait for join operation to complete (un)successfully.");
      this.irc.joinChannel(chatroom.getIdentifier(),password,new Callback<IRCChannel>(){
        @Override public void onSuccess(        IRCChannel channel){
          ChatRoomIrcImpl actualChatRoom=chatroom;
synchronized (joinSignal) {
            try {
              if (channel.getName().equals(actualChatRoom.getIdentifier()) == false) {
                actualChatRoom=new ChatRoomIrcImpl(channel.getName(),IrcStack.this.provider);
                MessageIrcImpl message=new MessageIrcImpl("Forwarding to channel " + channel.getName(),"text/plain","UTF-8",null);
                IrcStack.this.provider.getMUC().registerChatRoomInstance(actualChatRoom);
                chatroom.fireMessageReceivedEvent(message,null,new Date(),MessageReceivedEvent.SYSTEM_MESSAGE_RECEIVED);
              }
              IrcStack.this.joined.put(actualChatRoom.getIdentifier(),actualChatRoom);
              IrcStack.this.irc.addListener(new ChatRoomListener(actualChatRoom));
              IRCTopic topic=channel.getTopic();
              actualChatRoom.updateSubject(topic.getValue());
              for (              IRCUser user : channel.getUsers()) {
                ChatRoomMemberRole role=ChatRoomMemberRole.SILENT_MEMBER;
                Set<IRCUserStatus> statuses=channel.getStatusesForUser(user);
                for (                IRCUserStatus status : statuses) {
                  role=convertMemberMode(status.getChanModeType().charValue());
                }
                if (IrcStack.this.getNick().equals(user.getNick())) {
                  actualChatRoom.prepUserRole(role);
                }
 else {
                  ChatRoomMemberIrcImpl member=new ChatRoomMemberIrcImpl(IrcStack.this.provider,actualChatRoom,user.getNick(),role);
                  actualChatRoom.addChatRoomMember(member.getContactAddress(),member);
                }
              }
            }
  finally {
              IrcStack.this.provider.getMUC().fireLocalUserPresenceEvent(actualChatRoom,LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_JOINED,null);
              LOGGER.trace("Finished successful join callback. Waking up original thread.");
              joinSignal.notifyAll();
            }
          }
        }
        @Override public void onFailure(        Exception e){
synchronized (joinSignal) {
            try {
              joinSignal[0]=e;
              MessageIrcImpl message=new MessageIrcImpl("Failed to join channel " + chatroom.getIdentifier() + " ("+ e.getMessage()+ ")","text/plain","UTF-8","Failed to join");
              chatroom.fireMessageReceivedEvent(message,null,new Date(),MessageReceivedEvent.SYSTEM_MESSAGE_RECEIVED);
            }
  finally {
              LOGGER.trace("Finished unsuccessful join callback. Waking up original thread.");
              joinSignal.notifyAll();
            }
          }
        }
      }
);
      joinSignal.wait();
      LOGGER.trace("Finished waiting for join operation to complete.");
    }
 catch (    InterruptedException e) {
      e.printStackTrace();
    }
    if (joinSignal[0] != null) {
      throw new OperationFailedException(joinSignal[0].getMessage(),OperationFailedException.CHAT_ROOM_NOT_JOINED,joinSignal[0]);
    }
  }
}
