{
  for (  ProtocolProviderFactory providerFactory : GuiActivator.getProtocolProviderFactories().values()) {
    ServiceReference serRef;
    ProtocolProviderService protocolProvider;
    for (    AccountID accountID : providerFactory.getRegisteredAccounts()) {
      boolean isHidden=(accountID.getAccountProperty(ProtocolProviderFactory.IS_PROTOCOL_HIDDEN) != null);
      if (isHidden)       continue;
      serRef=providerFactory.getProviderForAccount(accountID);
      protocolProvider=(ProtocolProviderService)GuiActivator.bundleContext.getService(serRef);
      protocolProvider.addRegistrationStateChangeListener(this);
      OperationSetPresence presence=protocolProvider.getOperationSet(OperationSetPresence.class);
      if (presence != null) {
        presence.addProviderPresenceStatusListener(this);
      }
      accountListModel.addAccount(new Account(protocolProvider));
    }
  }
}
