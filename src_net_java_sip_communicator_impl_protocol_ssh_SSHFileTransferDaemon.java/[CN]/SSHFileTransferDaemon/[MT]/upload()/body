{
  fileInputStream=new FileInputStream(file);
  byte[] buffer=new byte[1024];
  int result, bytesRead;
  if ((result=checkAck(scpInputStream)) != 0)   throw new OperationFailedException("Error in Ack",result);
  long filesize=file.length();
  String command="C0644 " + filesize + " ";
  command+=file.getName() + "\n";
  if (logger.isTraceEnabled())   logger.trace(command);
  scpOutputStream.write(command.getBytes());
  scpOutputStream.flush();
  if ((result=checkAck(scpInputStream)) != 0)   throw new OperationFailedException("Error in Ack",result);
  while (true) {
    bytesRead=fileInputStream.read(buffer,0,buffer.length);
    if (bytesRead <= 0)     break;
    scpOutputStream.write(buffer,0,bytesRead);
  }
  fileInputStream.close();
  fileInputStream=null;
  buffer[0]=0;
  scpOutputStream.write(buffer,0,1);
  scpOutputStream.flush();
  if ((result=checkAck(scpInputStream)) != 0)   throw new OperationFailedException("Error in Ack",result);
  scpInputStream.close();
  scpOutputStream.close();
  fileTransferChannel.disconnect();
  instantMessaging.deliverMessage(instantMessaging.createMessage(file.getName() + " uploaded to Server"),sshContact);
}
