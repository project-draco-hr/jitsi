{
  Hashtable<String,String> accountProperties=new Hashtable<String,String>();
  if (registration.isRememberPassword()) {
    accountProperties.put(ProtocolProviderFactory.PASSWORD,passwd);
  }
  String serverAddress=null;
  if (registration.getServerAddress() != null)   serverAddress=registration.getServerAddress();
 else   serverAddress=getServerFromUserName(userName);
  if (serverAddress != null)   accountProperties.put(ProtocolProviderFactory.SERVER_ADDRESS,serverAddress);
  accountProperties.put(ProtocolProviderFactory.SERVER_PORT,registration.getServerPort());
  String proxyAddress=null;
  if (registration.getProxy() != null)   proxyAddress=registration.getProxy();
 else   proxyAddress=getServerFromUserName(userName);
  if (proxyAddress != null)   accountProperties.put(ProtocolProviderFactory.PROXY_ADDRESS,proxyAddress);
  accountProperties.put(ProtocolProviderFactory.PROXY_PORT,registration.getProxyPort());
  accountProperties.put(ProtocolProviderFactory.PREFERRED_TRANSPORT,registration.getPreferredTransport());
  accountProperties.put(ProtocolProviderFactory.IS_PRESENCE_ENABLED,Boolean.toString(registration.isEnablePresence()));
  accountProperties.put(ProtocolProviderFactory.FORCE_P2P_MODE,Boolean.toString(registration.isForceP2PMode()));
  accountProperties.put(ProtocolProviderFactory.DEFAULT_ENCRYPTION,Boolean.toString(registration.isDefaultEncryption()));
  accountProperties.put(ProtocolProviderFactory.POLLING_PERIOD,registration.getPollingPeriod());
  accountProperties.put(ProtocolProviderFactory.SUBSCRIPTION_EXPIRATION,registration.getSubscriptionExpiration());
  accountProperties.put("KEEP_ALIVE_METHOD",registration.getKeepAliveMethod());
  accountProperties.put("KEEP_ALIVE_INTERVAL",registration.getKeepAliveInterval());
  if (isModification) {
    providerFactory.modifyAccount(protocolProvider,accountProperties);
    this.isModification=false;
    return protocolProvider;
  }
  try {
    AccountID accountID=providerFactory.installAccount(userName,accountProperties);
    ServiceReference serRef=providerFactory.getProviderForAccount(accountID);
    protocolProvider=(ProtocolProviderService)SIPAccRegWizzActivator.bundleContext.getService(serRef);
  }
 catch (  IllegalArgumentException exc) {
    SIPAccRegWizzActivator.getUIService().getPopupDialog().showMessagePopupDialog(exc.getMessage(),Resources.getString("service.gui.ERROR"),PopupDialog.ERROR_MESSAGE);
  }
catch (  IllegalStateException exc) {
    SIPAccRegWizzActivator.getUIService().getPopupDialog().showMessagePopupDialog(exc.getMessage(),Resources.getString("service.gui.ERROR"),PopupDialog.ERROR_MESSAGE);
  }
  return protocolProvider;
}
