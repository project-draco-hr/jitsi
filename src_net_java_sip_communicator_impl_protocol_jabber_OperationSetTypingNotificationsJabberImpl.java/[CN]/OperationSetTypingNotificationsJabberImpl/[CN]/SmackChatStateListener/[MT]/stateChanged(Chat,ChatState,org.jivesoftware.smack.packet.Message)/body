{
  if (logger.isTraceEnabled())   logger.trace(chat.getParticipant() + " entered the " + state.name()+ " state.");
  String fromID=StringUtils.parseBareAddress(chat.getParticipant());
  Contact sourceContact=opSetPersPresence.findContactByID(fromID);
  if (sourceContact == null) {
    sourceContact=opSetPersPresence.createVolatileContact(chat.getParticipant());
  }
  int evtCode=STATE_UNKNOWN;
  if (ChatState.composing.equals(state)) {
    evtCode=STATE_TYPING;
  }
 else   if (ChatState.paused.equals(state) || ChatState.active.equals(state)) {
    evtCode=STATE_PAUSED;
  }
 else   if (ChatState.inactive.equals(state) || ChatState.gone.equals(state)) {
    evtCode=STATE_STOPPED;
  }
  if (message.getError() != null)   fireTypingNotificationsDeliveryFailedEvent(sourceContact,evtCode);
 else   if (evtCode != STATE_UNKNOWN)   fireTypingNotificationsEvent(sourceContact,evtCode);
 else   logger.warn("Unknown typing state!");
}
