{
  logger.debug("The provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERED) {
    opSetPersPresence=(OperationSetPersistentPresenceJabberImpl)jabberProvider.getSupportedOperationSets().get(OperationSetPersistentPresence.class.getName());
    messageEventManager=new MessageEventManager(jabberProvider.getConnection());
    messageEventManager.addMessageEventRequestListener(new JabberMessageEventRequestListener());
    messageEventManager.addMessageEventNotificationListener(new IncomingMessageEventsListener());
    ChatStateManager.getInstance(jabberProvider.getConnection());
    if (smackChatManagerListener == null)     smackChatManagerListener=new SmackChatManagerListener();
    jabberProvider.getConnection().getChatManager().addChatListener(smackChatManagerListener);
  }
}
