{
  ArrayList smiliesList=ImageLoader.getDefaultSmiliesPack();
  String regexp="";
  for (int i=0; i < smiliesList.size(); i++) {
    Smily smily=(Smily)smiliesList.get(i);
    String[] smilyStrings=smily.getSmilyStrings();
    for (int j=0; j < smilyStrings.length; j++) {
      regexp+=StringUtils.replaceSpecialRegExpChars(smilyStrings[j]) + "|";
    }
  }
  regexp=regexp.substring(0,regexp.length() - 1);
  Pattern p=Pattern.compile(regexp);
  Matcher m=p.matcher(message);
  StringBuffer msgBuffer=new StringBuffer();
  boolean matchSuccessfull=false;
  while (m.find()) {
    if (!matchSuccessfull)     matchSuccessfull=true;
    String matchGroup=m.group().trim();
    String replacement="<IMG SRC='" + ImageLoader.getSmily(matchGroup).getImagePath() + "' ALT='"+ matchGroup+ "'></IMG>";
    m.appendReplacement(msgBuffer,replacement);
  }
  m.appendTail(msgBuffer);
  return msgBuffer.toString();
}
