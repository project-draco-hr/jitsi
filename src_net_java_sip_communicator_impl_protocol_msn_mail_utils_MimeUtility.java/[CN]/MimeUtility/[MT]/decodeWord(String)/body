{
  if (!text.startsWith("=?")) {
    throw new Exception();
  }
  int start=2;
  int end=text.indexOf('?',start);
  if (end < 0) {
    throw new Exception();
  }
  String charset=text.substring(start,end);
  int si=charset.indexOf('*');
  if (si != -1) {
    charset=charset.substring(0,si);
  }
  start=end + 1;
  end=text.indexOf('?',start);
  if (end < 0) {
    throw new Exception();
  }
  String encoding=text.substring(start,end);
  start=end + 1;
  end=text.indexOf("?=",start);
  if (end < 0) {
    throw new Exception();
  }
  text=text.substring(start,end);
  InputStream is=null;
  try {
    char[] chars=text.toCharArray();
    int len=chars.length;
    byte[] bytes=new byte[len];
    for (int i=0; i < len; i++) {
      bytes[i]=(byte)chars[i];
    }
    ByteArrayInputStream bis=new ByteArrayInputStream(bytes);
    if (encoding.equalsIgnoreCase("B")) {
      is=new Base64InputStream(bis);
    }
 else     if (encoding.equalsIgnoreCase("Q")) {
      is=new QInputStream(bis);
    }
 else {
      throw new UnsupportedEncodingException("Unknown encoding: " + encoding);
    }
    len=bis.available();
    bytes=new byte[len];
    len=is.read(bytes,0,len);
    String ret=new String(bytes,0,len,charset);
    if (text.length() > end + 2)     ret=ret + text.substring(end + 2);
    return ret;
  }
 catch (  IOException e) {
    throw new Exception();
  }
catch (  IllegalArgumentException e) {
    throw new UnsupportedEncodingException();
  }
 finally {
    if (is != null)     is.close();
  }
}
