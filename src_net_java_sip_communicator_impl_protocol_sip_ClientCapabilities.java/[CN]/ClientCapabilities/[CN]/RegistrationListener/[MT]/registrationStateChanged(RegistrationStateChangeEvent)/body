{
  if (evt.getNewState() == RegistrationState.UNREGISTERING || evt.getNewState() == RegistrationState.CONNECTION_FAILED) {
    if (keepAliveTimer != null) {
      keepAliveTimer.cancel();
      keepAliveTimer=null;
    }
  }
 else   if (evt.getNewState().equals(RegistrationState.REGISTERED)) {
    String keepAliveMethod=provider.getAccountID().getAccountPropertyString(ProtocolProviderServiceSipImpl.KEEP_ALIVE_METHOD);
    if (logger.isTraceEnabled())     logger.trace("Keep alive method " + keepAliveMethod);
    if (keepAliveMethod == null || !keepAliveMethod.equalsIgnoreCase("options"))     return;
    int keepAliveInterval=provider.getAccountID().getAccountPropertyInt(ProtocolProviderServiceSipImpl.KEEP_ALIVE_INTERVAL,-1);
    if (logger.isTraceEnabled())     logger.trace("Keep alive inerval is " + keepAliveInterval);
    if (keepAliveInterval > 0 && !provider.getRegistrarConnection().isRegistrarless()) {
      if (keepAliveTimer == null)       keepAliveTimer=new Timer();
      if (logger.isDebugEnabled())       logger.debug("Scheduling OPTIONS keep alives");
      keepAliveTimer.schedule(new KeepAliveTask(),0,keepAliveInterval * 1000);
    }
  }
}
