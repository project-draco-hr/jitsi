{
  logger.debug("The provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERED) {
    opSetPersPresence=(OperationSetPersistentPresenceJabberImpl)jabberProvider.getOperationSet(OperationSetPersistentPresence.class);
    jabberProvider.getConnection().addPacketListener(new SmackMessageListener(),new AndFilter(new PacketFilter[]{new GroupMessagePacketFilter(),new PacketTypeFilter(org.jivesoftware.smack.packet.Message.class)}));
    boolean enableGmailNotifications=Boolean.parseBoolean(jabberProvider.getAccountID().getAccountPropertyString("GMAIL_NOTIFICATIONS_ENABLED"));
    if (enableGmailNotifications)     subscribeForGmailNotifications();
    if (keepAliveSendTask == null && keepAliveEnabled) {
      jabberProvider.getConnection().addPacketListener(new KeepalivePacketListener(),new PacketTypeFilter(KeepAliveEvent.class));
      keepAliveSendTask=new KeepAliveSendTask();
      keepAliveTimer.scheduleAtFixedRate(keepAliveSendTask,KEEPALIVE_INTERVAL,KEEPALIVE_INTERVAL);
    }
  }
}
