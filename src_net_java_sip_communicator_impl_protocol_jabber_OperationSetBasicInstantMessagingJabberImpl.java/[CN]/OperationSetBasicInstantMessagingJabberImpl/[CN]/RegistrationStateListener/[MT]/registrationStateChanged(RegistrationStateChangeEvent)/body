{
  if (logger.isDebugEnabled())   logger.debug("The provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERING) {
    opSetPersPresence=(OperationSetPersistentPresenceJabberImpl)jabberProvider.getOperationSet(OperationSetPersistentPresence.class);
    if (smackMessageListener == null) {
      smackMessageListener=new SmackMessageListener();
    }
 else {
      jabberProvider.getConnection().removePacketListener(smackMessageListener);
    }
    jabberProvider.getConnection().addPacketListener(smackMessageListener,new AndFilter(new PacketFilter[]{new GroupMessagePacketFilter(),new PacketTypeFilter(org.jivesoftware.smack.packet.Message.class)}));
  }
 else   if (evt.getNewState() == RegistrationState.REGISTERED) {
    boolean enableGmailNotifications=jabberProvider.getAccountID().getAccountPropertyBoolean("GMAIL_NOTIFICATIONS_ENABLED",false);
    if (enableGmailNotifications)     subscribeForGmailNotifications();
    if ((keepAliveSendTask == null || keepAliveTimer == null) && keepAliveEnabled) {
      jabberProvider.getConnection().addPacketListener(new KeepalivePacketListener(),new PacketTypeFilter(KeepAliveEvent.class));
      keepAliveSendTask=new KeepAliveSendTask();
      keepAliveTimer=new Timer("Jabber keepalive timer for <" + evt.getProvider().getAccountID() + ">",true);
      keepAliveTimer.scheduleAtFixedRate(keepAliveSendTask,KEEPALIVE_INTERVAL,KEEPALIVE_INTERVAL);
    }
  }
 else   if (evt.getNewState() == RegistrationState.UNREGISTERED || evt.getNewState() == RegistrationState.CONNECTION_FAILED || evt.getNewState() == RegistrationState.AUTHENTICATION_FAILED) {
    if (jabberProvider.getConnection() != null) {
      if (smackMessageListener != null)       jabberProvider.getConnection().removePacketListener(smackMessageListener);
    }
    if (keepAliveSendTask != null) {
      keepAliveSendTask.cancel();
      keepAliveSendTask=null;
    }
    if (keepAliveTimer != null) {
      keepAliveTimer.cancel();
      keepAliveTimer=null;
    }
    smackMessageListener=null;
  }
}
