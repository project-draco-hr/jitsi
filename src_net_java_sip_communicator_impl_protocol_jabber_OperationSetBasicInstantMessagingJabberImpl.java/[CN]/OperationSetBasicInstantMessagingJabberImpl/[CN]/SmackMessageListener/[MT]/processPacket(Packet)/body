{
  if (!(packet instanceof org.jivesoftware.smack.packet.Message))   return;
  org.jivesoftware.smack.packet.Message msg=(org.jivesoftware.smack.packet.Message)packet;
  if (msg.getBody() == null)   return;
  String fromUserID=StringUtils.parseBareAddress(msg.getFrom());
  if (logger.isDebugEnabled()) {
    logger.debug("Received from " + fromUserID + " the message "+ msg.toXML());
  }
  Message newMessage=createMessage(msg.getBody());
  PacketExtension ext=msg.getExtension("http://jabber.org/protocol/xhtml-im");
  if (ext != null) {
    XHTMLExtension xhtmlExt=(XHTMLExtension)ext;
    Iterator bodies=xhtmlExt.getBodies();
    StringBuffer messageBuff=new StringBuffer();
    while (bodies.hasNext()) {
      String body=(String)bodies.next();
      messageBuff.append(body);
    }
    if (messageBuff.length() > 0) {
      String receivedMessage=messageBuff.toString().replaceAll("\\<[bB][oO][dD][yY].*?>","").replaceAll("\\</[bB][oO][dD][yY].*?>","");
      newMessage=createMessage(receivedMessage,HTML_MIME_TYPE);
    }
  }
  Contact sourceContact=opSetPersPresence.findContactByID(fromUserID);
  if (msg.getType() == org.jivesoftware.smack.packet.Message.Type.error) {
    logger.info("Message error received from " + fromUserID);
    int errorCode=packet.getError().getCode();
    int errorResultCode=MessageDeliveryFailedEvent.UNKNOWN_ERROR;
    if (errorCode == 503) {
      org.jivesoftware.smackx.packet.MessageEvent msgEvent=(org.jivesoftware.smackx.packet.MessageEvent)packet.getExtension("x","jabber:x:event");
      if (msgEvent != null && msgEvent.isOffline()) {
        errorResultCode=MessageDeliveryFailedEvent.OFFLINE_MESSAGES_NOT_SUPPORTED;
      }
    }
    MessageDeliveryFailedEvent ev=new MessageDeliveryFailedEvent(newMessage,sourceContact,errorResultCode);
    OperationSetInstantMessageTransformJabberImpl messageTransform=(OperationSetInstantMessageTransformJabberImpl)jabberProvider.getOperationSet(OperationSetInstantMessageTransform.class);
    for (    Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
      for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
        TransformLayer transformLayer=(TransformLayer)iterator.next();
        if (ev != null)         ev=transformLayer.messageDeliveryFailed(ev);
      }
    }
    if (ev != null)     fireMessageEvent(ev);
    return;
  }
  if (sourceContact == null) {
    logger.debug("received a message from an unknown contact: " + fromUserID);
    sourceContact=opSetPersPresence.createVolatileContact(fromUserID);
  }
  MessageReceivedEvent msgReceivedEvt=new MessageReceivedEvent(newMessage,sourceContact,System.currentTimeMillis());
  OperationSetInstantMessageTransformJabberImpl messageTransform=(OperationSetInstantMessageTransformJabberImpl)jabberProvider.getOperationSet(OperationSetInstantMessageTransform.class);
  for (  Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
    for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
      TransformLayer transformLayer=(TransformLayer)iterator.next();
      if (msgReceivedEvt != null)       msgReceivedEvt=transformLayer.messageReceived(msgReceivedEvt);
    }
  }
  if (msgReceivedEvt != null)   fireMessageEvent(msgReceivedEvt);
}
