{
  final VerifyCertificateDialog dialog=new VerifyCertificateDialog(chain,toHost,toPort);
  try {
    SwingUtilities.invokeAndWait(new Runnable(){
      public void run(){
        dialog.setVisible(true);
      }
    }
);
  }
 catch (  Exception e) {
    logger.error("Cannot show certificate verification dialog",e);
    return DO_NOT_TRUST;
  }
  if (!dialog.isTrusted)   return DO_NOT_TRUST;
 else   if (dialog.alwaysTrustCheckBox.isSelected()) {
    try {
      KeyStore kStore=getKeyStore();
synchronized (kStore) {
        for (        X509Certificate c : chain)         kStore.setCertificateEntry(String.valueOf(System.currentTimeMillis()),c);
        kStore.store(new FileOutputStream(getKeyStoreLocation()),defaultPassword);
      }
    }
 catch (    Throwable e) {
      logger.error("Error saving keystore.",e);
    }
    return TRUST_ALWAYS;
  }
 else {
    for (    X509Certificate c : chain)     temporalyAllowed.add(c);
    return TRUST_THIS_SESSION_ONLY;
  }
}
