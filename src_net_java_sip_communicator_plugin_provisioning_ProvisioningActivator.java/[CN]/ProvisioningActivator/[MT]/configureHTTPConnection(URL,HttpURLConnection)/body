{
  try {
    connection.setRequestMethod(method);
    if (method.equals("POST")) {
      connection.setRequestProperty("Content-Type","application/x-www-form-urlencoded");
    }
    if (connection instanceof HttpsURLConnection) {
      CertificateVerificationService vs=getCertificateVerificationService();
      int port=url.getPort();
      if (port == -1) {
        if (url.getProtocol().equals("http")) {
          port=80;
        }
 else         if (url.getProtocol().equals("https")) {
          port=443;
        }
      }
      ((HttpsURLConnection)connection).setSSLSocketFactory(vs.getSSLContext(url.getHost(),port).getSocketFactory());
    }
  }
 catch (  Exception e) {
    logger.warn("Failed to initialize secure connection",e);
  }
  Authenticator.setDefault(new Authenticator(){
    protected PasswordAuthentication getPasswordAuthentication(){
      ConfigurationService config=getConfigurationService();
      CredentialsStorageService credStorage=getCredentialsStorageService();
      String uName=(String)config.getProperty(PROPERTY_PROVISIONING_USERNAME);
      if (uName != null) {
        String pass=credStorage.loadPassword(PROPERTY_PROVISIONING_PASSWORD);
        if (pass != null)         return new PasswordAuthentication(uName,pass.toCharArray());
      }
      if (userCredentials != null) {
        return new PasswordAuthentication(userCredentials.getUserName(),userCredentials.getPassword());
      }
 else {
        return null;
      }
    }
  }
);
}
