{
  File tmpFile=null;
  try {
    String arg=null;
    String args[]=null;
    final File temp=File.createTempFile("provisioning",".properties");
    tmpFile=temp;
    if (url.contains("?")) {
      if ((url.indexOf('?') + 1) != url.length()) {
        arg=url.substring(url.indexOf('?') + 1);
        args=arg.split("&");
      }
      url=url.substring(0,url.indexOf('?'));
    }
    URL u=new URL(url);
    InetAddress ipaddr=getNetworkAddressManagerService().getLocalHost(InetAddress.getByName(u.getHost()));
    String[] paramNames=null;
    String[] paramValues=null;
    int usernameIx=-1;
    int passwordIx=-1;
    if (args != null && args.length > 0) {
      paramNames=new String[args.length];
      paramValues=new String[args.length];
      for (int i=0; i < args.length; i++) {
        String s=args[i];
        if (s.equals("username=$username") || s.equals("username")) {
          paramNames[i]="username";
          paramValues[i]="";
          usernameIx=i;
        }
 else         if (s.equals("password=$password") || s.equals("password")) {
          paramNames[i]="password";
          paramValues[i]="";
          passwordIx=i;
        }
 else         if (s.equals("osname=$osname") || s.equals("osname")) {
          paramNames[i]="osname";
          paramValues[i]=System.getProperty("os.name");
        }
 else         if (s.equals("build=$build") || s.equals("build")) {
          paramNames[i]="build";
          paramValues[i]=System.getProperty("sip-communicator.version");
        }
 else         if (s.equals("ipaddr=$ipaddr") || s.equals("ipaddr")) {
          paramNames[i]="ipaddr";
          paramValues[i]=ipaddr.getHostAddress();
        }
 else         if (s.equals("hwaddr=$hwaddr") || s.equals("hwaddr")) {
          paramNames[i]="hwaddr";
          if (ipaddr != null) {
            Enumeration<NetworkInterface> en=NetworkInterface.getNetworkInterfaces();
            while (en.hasMoreElements()) {
              NetworkInterface iface=en.nextElement();
              Enumeration<InetAddress> enInet=iface.getInetAddresses();
              while (enInet.hasMoreElements()) {
                InetAddress inet=enInet.nextElement();
                if (inet.equals(ipaddr)) {
                  byte hw[]=getNetworkAddressManagerService().getHardwareAddress(iface);
                  StringBuffer buf=new StringBuffer();
                  for (                  byte h : hw) {
                    int hi=h >= 0 ? h : h + 256;
                    String t=new String((hi <= 0xf) ? "0" : "");
                    t+=Integer.toHexString(hi);
                    buf.append(t);
                    buf.append(":");
                  }
                  buf.deleteCharAt(buf.length() - 1);
                  paramValues[i]=buf.toString();
                  break;
                }
              }
            }
          }
        }
 else {
          paramNames[i]="";
          paramValues[i]="";
        }
      }
    }
    HttpUtils.HTTPResponseResult res=HttpUtils.postForm(url,PROPERTY_PROVISIONING_USERNAME,PROPERTY_PROVISIONING_PASSWORD,paramNames,paramValues,usernameIx,passwordIx);
    if (res == null)     return null;
    InputStream in=res.getContent();
    final ProgressMonitorInputStream pin=new ProgressMonitorInputStream(null,u.toString(),in);
    ProgressMonitor pm=pin.getProgressMonitor();
    pm.setMaximum((int)res.getContentLength());
    final BufferedOutputStream bout=new BufferedOutputStream(new FileOutputStream(temp));
    try {
      int read=-1;
      byte[] buff=new byte[1024];
      while ((read=pin.read(buff)) != -1) {
        bout.write(buff,0,read);
      }
      pin.close();
      bout.flush();
      bout.close();
      return temp;
    }
 catch (    Exception e) {
      logger.error("Error saving",e);
      try {
        pin.close();
        bout.close();
      }
 catch (      Exception e1) {
      }
      return null;
    }
  }
 catch (  Exception e) {
    if (logger.isInfoEnabled())     logger.info("Error retrieving provisioning file!",e);
    tmpFile.delete();
    return null;
  }
}
