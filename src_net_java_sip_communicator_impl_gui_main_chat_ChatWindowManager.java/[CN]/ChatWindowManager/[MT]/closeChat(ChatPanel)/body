{
  if (!SwingUtilities.isEventDispatchThread()) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        closeChat(chatPanel);
      }
    }
);
    return;
  }
synchronized (chatSyncRoot) {
    if (containsChat(chatPanel)) {
      long lastMsgTimestamp=chatPanel.getChatConversationPanel().getLastIncomingMsgTimestamp();
      if (!chatPanel.isWriteAreaEmpty()) {
        SIPCommMsgTextArea msgText=new SIPCommMsgTextArea(GuiActivator.getResources().getI18NString("service.gui.NON_EMPTY_CHAT_WINDOW_CLOSE"));
        int answer=JOptionPane.showConfirmDialog(null,msgText,GuiActivator.getResources().getI18NString("service.gui.WARNING"),JOptionPane.OK_CANCEL_OPTION,JOptionPane.WARNING_MESSAGE);
        if (answer == JOptionPane.OK_OPTION)         closeChatPanel(chatPanel);
      }
 else       if (System.currentTimeMillis() - lastMsgTimestamp < 2 * 1000) {
        SIPCommMsgTextArea msgText=new SIPCommMsgTextArea(GuiActivator.getResources().getI18NString("service.gui.CLOSE_CHAT_AFTER_NEW_MESSAGE"));
        int answer=JOptionPane.showConfirmDialog(null,msgText,GuiActivator.getResources().getI18NString("service.gui.WARNING"),JOptionPane.OK_CANCEL_OPTION,JOptionPane.WARNING_MESSAGE);
        if (answer == JOptionPane.OK_OPTION)         closeChatPanel(chatPanel);
      }
 else       if (chatPanel.containsActiveFileTransfers()) {
        SIPCommMsgTextArea msgText=new SIPCommMsgTextArea(GuiActivator.getResources().getI18NString("service.gui.CLOSE_CHAT_ACTIVE_FILE_TRANSFER"));
        int answer=JOptionPane.showConfirmDialog(null,msgText,GuiActivator.getResources().getI18NString("service.gui.WARNING"),JOptionPane.OK_CANCEL_OPTION,JOptionPane.WARNING_MESSAGE);
        if (answer == JOptionPane.OK_OPTION) {
          chatPanel.cancelActiveFileTransfers();
          closeChatPanel(chatPanel);
        }
      }
 else       if (chatPanel.getChatSession() instanceof AdHocConferenceChatSession) {
        AdHocConferenceChatSession adHocSession=(AdHocConferenceChatSession)chatPanel.getChatSession();
        GuiActivator.getUIService().getConferenceChatManager().leaveChatRoom((AdHocChatRoomWrapper)adHocSession.getDescriptor());
        closeChatPanel(chatPanel);
      }
 else {
        closeChatPanel(chatPanel);
      }
    }
  }
}
