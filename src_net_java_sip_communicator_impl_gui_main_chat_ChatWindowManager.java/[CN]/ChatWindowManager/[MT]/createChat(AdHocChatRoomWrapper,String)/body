{
  ChatWindow chatWindow;
  if (ConfigurationManager.isMultiChatWindowEnabled()) {
    Iterator<ChatPanel> chatPanelsIter=chatPanels.iterator();
    if (chatPanelsIter.hasNext()) {
      chatWindow=chatPanelsIter.next().getChatWindow();
    }
 else {
      chatWindow=new ChatWindow();
      GuiActivator.getUIService().registerExportedWindow(chatWindow);
    }
  }
 else {
    chatWindow=new ChatWindow();
  }
  ChatPanel chatPanel=new ChatPanel(chatWindow);
  AdHocConferenceChatSession chatSession=new AdHocConferenceChatSession(chatPanel,chatRoomWrapper);
  chatPanel.setChatSession(chatSession);
synchronized (chatPanels) {
    this.chatPanels.add(chatPanel);
  }
  if (ConfigurationManager.isHistoryShown())   chatPanel.loadHistory(escapedMessageID);
  return chatPanel;
}
