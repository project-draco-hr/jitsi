{
  ChatWindow chatWindow;
  if (ConfigurationManager.isMultiChatWindowEnabled()) {
    if (chats.keys().hasMoreElements()) {
      chatWindow=((ChatPanel)chats.keys().nextElement()).getChatWindow();
    }
 else {
      chatWindow=new ChatWindow(mainFrame);
      GuiActivator.getUIService().registerExportedWindow(chatWindow);
    }
  }
 else {
    chatWindow=new ChatWindow(mainFrame);
  }
  ConferenceChatPanel chatPanel=new ConferenceChatPanel(chatWindow,chatRoomWrapper);
synchronized (chats) {
    this.chats.put(chatRoomWrapper,chatPanel);
  }
  if (ConfigurationManager.isHistoryShown()) {
    if (escapedMessageID != null)     chatPanel.loadHistory(escapedMessageID);
 else     chatPanel.loadHistory();
  }
  return chatPanel;
}
