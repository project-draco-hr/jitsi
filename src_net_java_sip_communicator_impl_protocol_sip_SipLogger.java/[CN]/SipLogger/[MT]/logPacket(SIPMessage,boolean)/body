{
  try {
    PacketLoggingService packetLogging=SipActivator.getPacketLogging();
    if (packetLogging == null || !packetLogging.isLoggingEnabled(PacketLoggingService.ProtocolName.SIP))     return;
    boolean isTransportUDP=message.getTopmostVia().getTransport().equalsIgnoreCase("UDP");
    byte[] srcAddr;
    int srcPort;
    byte[] dstAddr;
    int dstPort;
    if (sender) {
      srcPort=message.getLocalPort();
      if (message.getLocalAddress() != null)       srcAddr=message.getLocalAddress().getAddress();
 else       if (message.getRemoteAddress() != null)       srcAddr=new byte[message.getRemoteAddress().getAddress().length];
 else       srcAddr=new byte[4];
      dstPort=message.getRemotePort();
      if (message.getRemoteAddress() != null)       dstAddr=message.getRemoteAddress().getAddress();
 else       dstAddr=new byte[srcAddr.length];
    }
 else {
      dstPort=message.getLocalPort();
      if (message.getLocalAddress() != null)       dstAddr=message.getLocalAddress().getAddress();
 else       if (message.getRemoteAddress() != null)       dstAddr=new byte[message.getRemoteAddress().getAddress().length];
 else       dstAddr=new byte[4];
      srcPort=message.getRemotePort();
      if (message.getRemoteAddress() != null)       srcAddr=message.getRemoteAddress().getAddress();
 else       srcAddr=new byte[dstAddr.length];
    }
    byte[] msg=message.toString().getBytes("UTF-8");
    packetLogging.logPacket(PacketLoggingService.ProtocolName.SIP,srcAddr,srcPort,dstAddr,dstPort,isTransportUDP ? PacketLoggingService.TransportName.UDP : PacketLoggingService.TransportName.TCP,sender,msg);
  }
 catch (  UnsupportedEncodingException e) {
    logger.error("Cannot obtain message body",e);
  }
}
