{
  if (evt.getNewState() == RegistrationState.UNREGISTERING) {
    cancelTimer();
    try {
      publishPresenceStatus(sipStatusEnum.getStatus(SipStatusEnum.OFFLINE),"");
    }
 catch (    OperationFailedException e) {
      logger.error("can't set the offline mode",e);
    }
    for (byte i=0; i < 10; i++) {
synchronized (waitedCallIds) {
        if (waitedCallIds.size() == 0) {
          break;
        }
      }
synchronized (this) {
        try {
          wait(500);
        }
 catch (        InterruptedException e) {
          if (logger.isDebugEnabled())           logger.debug("abnormal behavior, may cause " + "unnecessary CPU use",e);
        }
      }
    }
  }
 else   if (evt.getNewState().equals(RegistrationState.REGISTERED)) {
    if (logger.isDebugEnabled())     logger.debug("enter registered state");
    if ((presenceEnabled == false) || (pollingTask != null)) {
      return;
    }
    Iterator<ContactGroup> groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroup group=groupsIter.next();
      Iterator<Contact> contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)contactsIter.next();
        if (contact.isResolved()) {
          if (logger.isDebugEnabled())           logger.debug("contact " + contact + " already resolved");
          continue;
        }
        forcePollContact(contact);
      }
    }
    pollingTask=new PollOfflineContactsTask();
    timer.schedule(pollingTask,pollingTaskPeriod,pollingTaskPeriod);
  }
 else   if (evt.getNewState() == RegistrationState.CONNECTION_FAILED) {
    Iterator<ContactGroup> groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroup group=groupsIter.next();
      Iterator<Contact> contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)contactsIter.next();
        PresenceStatus oldContactStatus=contact.getPresenceStatus();
        contact.setResolved(false);
        if (subscriber != null)         try {
          subscriber.removeSubscription(getAddress(contact));
        }
 catch (        OperationFailedException ex) {
          if (logger.isDebugEnabled())           logger.debug("Failed to remove subscription to contact " + contact);
        }
        if (!oldContactStatus.isOnline())         continue;
        contact.setPresenceStatus(sipStatusEnum.getStatus(SipStatusEnum.OFFLINE));
        fireContactPresenceStatusChangeEvent(contact,contact.getParentContactGroup(),oldContactStatus);
      }
    }
    cancelTimer();
    waitedCallIds.clear();
  }
}
