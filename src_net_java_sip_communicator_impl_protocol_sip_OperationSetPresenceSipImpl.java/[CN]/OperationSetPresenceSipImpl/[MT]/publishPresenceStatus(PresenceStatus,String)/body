{
  PresenceStatus oldStatus=this.presenceStatus;
  this.presenceStatus=status;
  String oldMessage=this.statusMessage;
  this.statusMessage=statusMsg;
  this.fireProviderStatusChangeEvent(oldStatus);
  this.fireProviderMsgStatusChangeEvent(oldMessage);
  if (this.presenceEnabled == false) {
    return;
  }
  if (!status.equals(SipStatusEnum.OFFLINE)) {
    assertConnected();
  }
  if (this.useDistantPA) {
    Request req=null;
    if (status.equals(SipStatusEnum.OFFLINE)) {
      req=createPublish(0,false);
synchronized (this.waitedCallIds) {
        this.waitedCallIds.add(((CallIdHeader)req.getHeader(CallIdHeader.NAME)).getCallId());
      }
    }
 else {
      req=createPublish(this.subscriptionDuration,true);
    }
    ClientTransaction transac=null;
    try {
      transac=this.parentProvider.getDefaultJainSipProvider().getNewClientTransaction(req);
    }
 catch (    TransactionUnavailableException e) {
      logger.error("can't create the client transaction",e);
      throw new OperationFailedException("can't create the client transaction",OperationFailedException.NETWORK_FAILURE);
    }
    try {
      transac.sendRequest();
    }
 catch (    SipException e) {
      logger.error("can't send the PUBLISH request",e);
      throw new OperationFailedException("can't send the PUBLISH request",OperationFailedException.NETWORK_FAILURE);
    }
  }
 else {
synchronized (this.ourWatchers) {
      Iterator iter=this.ourWatchers.iterator();
      ContactSipImpl me=(ContactSipImpl)getLocalContact();
      while (iter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)iter.next();
        if (!contact.isResolved()) {
          continue;
        }
        ClientTransaction transac=null;
        try {
          if (status.equals(SipStatusEnum.OFFLINE)) {
            transac=createNotify(contact,getPidfPresenceStatus(me),SubscriptionStateHeader.TERMINATED,SubscriptionStateHeader.PROBATION);
synchronized (this.waitedCallIds) {
              this.waitedCallIds.add(transac.getDialog().getCallId().getCallId());
            }
          }
 else {
            transac=createNotify(contact,getPidfPresenceStatus(me),SubscriptionStateHeader.ACTIVE,null);
          }
        }
 catch (        OperationFailedException e) {
          logger.error("failed to create the new notify",e);
          return;
        }
        try {
          contact.getServerDialog().sendRequest(transac);
        }
 catch (        Exception e) {
          logger.error("Can't send the request",e);
          return;
        }
      }
      if (status.equals(SipStatusEnum.OFFLINE)) {
        this.ourWatchers.removeAllElements();
      }
    }
  }
  if (status.equals(SipStatusEnum.OFFLINE)) {
    unsubscribeToAllContact();
  }
}
