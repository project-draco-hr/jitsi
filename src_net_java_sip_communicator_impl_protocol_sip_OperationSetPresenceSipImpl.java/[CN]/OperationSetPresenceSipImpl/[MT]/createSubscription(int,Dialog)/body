{
  Request req=null;
  try {
    req=dialog.createRequest(Request.SUBSCRIBE);
  }
 catch (  SipException e) {
    logger.error("Can't create the SUBSCRIBE message",e);
    throw new OperationFailedException("An unexpected error occurred while" + "constructing the SUBSCRIBE request",OperationFailedException.INTERNAL_ERROR,e);
  }
  Address toAddress=dialog.getRemoteTarget();
  if (toAddress == null) {
    toAddress=dialog.getRemoteParty();
  }
  MaxForwardsHeader maxForwards=this.parentProvider.getMaxForwardsHeader();
  EventHeader evHeader=null;
  try {
    evHeader=this.parentProvider.getHeaderFactory().createEventHeader("presence");
  }
 catch (  ParseException e) {
    logger.error("An unexpected error occurred while" + "constructing the EventHeader",e);
    throw new OperationFailedException("An unexpected error occurred while" + "constructing the EventHeader",OperationFailedException.INTERNAL_ERROR,e);
  }
  ContactHeader contactHeader=this.parentProvider.getContactHeader(toAddress);
  AcceptHeader accept=null;
  try {
    accept=this.parentProvider.getHeaderFactory().createAcceptHeader("application",PIDF_XML);
  }
 catch (  ParseException e) {
    logger.error("wrong accept header");
    throw new OperationFailedException("An unexpected error occurred while" + "constructing the AcceptHeader",OperationFailedException.INTERNAL_ERROR,e);
  }
  ExpiresHeader expHeader=null;
  try {
    expHeader=this.parentProvider.getHeaderFactory().createExpiresHeader(expires);
  }
 catch (  InvalidArgumentException e) {
    logger.error("Invalid expires value: " + expires,e);
    throw new OperationFailedException("An unexpected error occurred while" + "constructing the ExpiresHeader",OperationFailedException.INTERNAL_ERROR,e);
  }
  req.setHeader(expHeader);
  req.setHeader(accept);
  req.setHeader(maxForwards);
  req.setHeader(evHeader);
  req.setHeader(contactHeader);
  CallIdHeader call=(CallIdHeader)req.getHeader(CallIdHeader.NAME);
  String callid=call.getCallId();
  AuthorizationHeader authorization=parentProvider.getSipSecurityManager().getCachedAuthorizationHeader(callid);
  if (authorization != null)   req.addHeader(authorization);
  ClientTransaction transac=null;
  try {
    transac=this.parentProvider.getDefaultJainSipProvider().getNewClientTransaction(req);
  }
 catch (  TransactionUnavailableException ex) {
    logger.error("Failed to create subscriptionTransaction.\n" + "This is most probably a network connection error.",ex);
    throw new OperationFailedException("Failed to create the subscription transaction",OperationFailedException.NETWORK_FAILURE);
  }
  ArrayList<ViaHeader> viaHeaders=this.parentProvider.getLocalViaHeaders(toAddress);
  req.setHeader((Header)viaHeaders.get(0));
  UserAgentHeader userAgentHeader=parentProvider.getSipCommUserAgentHeader();
  if (userAgentHeader != null)   req.addHeader(userAgentHeader);
  return transac;
}
