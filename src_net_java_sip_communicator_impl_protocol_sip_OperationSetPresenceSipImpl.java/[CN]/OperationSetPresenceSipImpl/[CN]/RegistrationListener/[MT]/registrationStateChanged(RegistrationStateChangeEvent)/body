{
  if (evt.getNewState() == RegistrationState.UNREGISTERING) {
    timer.cancel();
    try {
      publishPresenceStatus(SipStatusEnum.OFFLINE,"");
    }
 catch (    OperationFailedException e) {
      logger.error("can't set the offline mode",e);
    }
    for (byte i=0; i < 10; i++) {
synchronized (waitedCallIds) {
        if (waitedCallIds.size() == 0) {
          break;
        }
      }
synchronized (this) {
        try {
          wait(500);
        }
 catch (        InterruptedException e) {
          logger.debug("abnormal behavior, may cause " + "unnecessary CPU use",e);
        }
      }
    }
    PresenceStatus oldStatus=presenceStatus;
    presenceStatus=SipStatusEnum.OFFLINE;
    fireProviderStatusChangeEvent(oldStatus);
  }
 else   if (evt.getNewState().equals(RegistrationState.REGISTERED)) {
    logger.debug("enter registered state");
    Iterator groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroupSipImpl group=(ContactGroupSipImpl)groupsIter.next();
      Iterator contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)contactsIter.next();
        if (contact.isResolved()) {
          logger.debug("contact " + contact + " already resolved");
          continue;
        }
        forcePollContact(contact);
      }
    }
    timer=new Timer(true);
    pollingTask=new PollOfflineContactsTask();
    timer.schedule(pollingTask,POLLING_TASK_PERIOD,POLLING_TASK_PERIOD);
  }
}
