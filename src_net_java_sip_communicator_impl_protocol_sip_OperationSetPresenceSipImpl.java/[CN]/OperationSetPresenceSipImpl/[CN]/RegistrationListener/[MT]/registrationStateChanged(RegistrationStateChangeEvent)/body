{
  if (evt.getNewState() == RegistrationState.UNREGISTERING) {
    if (timer != null) {
      timer.cancel();
    }
    try {
      publishPresenceStatus(sipStatusEnum.getStatus(SipStatusEnum.OFFLINE),"");
    }
 catch (    OperationFailedException e) {
      logger.error("can't set the offline mode",e);
    }
    for (byte i=0; i < 10; i++) {
synchronized (waitedCallIds) {
        if (waitedCallIds.size() == 0) {
          break;
        }
      }
synchronized (this) {
        try {
          wait(500);
        }
 catch (        InterruptedException e) {
          logger.debug("abnormal behavior, may cause " + "unnecessary CPU use",e);
        }
      }
    }
  }
 else   if (evt.getNewState().equals(RegistrationState.REGISTERED)) {
    logger.debug("enter registered state");
    if (presenceEnabled == false) {
      return;
    }
    Iterator groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroupSipImpl group=(ContactGroupSipImpl)groupsIter.next();
      Iterator contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)contactsIter.next();
        if (contact.isResolved()) {
          logger.debug("contact " + contact + " already resolved");
          continue;
        }
        forcePollContact(contact);
      }
    }
    timer=new Timer(true);
    pollingTask=new PollOfflineContactsTask();
    timer.schedule(pollingTask,pollingTaskPeriod,pollingTaskPeriod);
  }
 else   if (evt.getNewState() == RegistrationState.CONNECTION_FAILED) {
    Iterator groupsIter=getServerStoredContactListRoot().subgroups();
    while (groupsIter.hasNext()) {
      ContactGroupSipImpl group=(ContactGroupSipImpl)groupsIter.next();
      Iterator contactsIter=group.contacts();
      while (contactsIter.hasNext()) {
        ContactSipImpl contact=(ContactSipImpl)contactsIter.next();
        PresenceStatus oldContactStatus=contact.getPresenceStatus();
        contact.setResolved(false);
        contact.setClientDialog(null);
        if (!oldContactStatus.isOnline())         continue;
        contact.setPresenceStatus(sipStatusEnum.getStatus(SipStatusEnum.OFFLINE));
        fireContactPresenceStatusChangeEvent(contact,contact.getParentContactGroup(),oldContactStatus);
      }
    }
    if (timer != null) {
      timer.cancel();
    }
    waitedCallIds.clear();
  }
}
