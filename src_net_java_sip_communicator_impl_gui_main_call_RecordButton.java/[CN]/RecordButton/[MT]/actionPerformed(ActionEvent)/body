{
  if (call != null) {
    OperationSetBasicTelephony<?> telephony=call.getProtocolProvider().getOperationSet(OperationSetBasicTelephony.class);
    boolean isRecordSelected=isSelected();
    if (isRecordSelected) {
      if (!isCallDirSet) {
        File selectedFile=callFileChooser.getFileFromDialog();
        if (selectedFile != null) {
          callFilename=selectedFile.getAbsolutePath();
          configuration.setProperty(Recorder.CALL_FORMAT,SoundFileUtils.getExtension(selectedFile));
        }
 else {
          setSelected(false);
          return;
        }
      }
 else       callFilename=createDefaultFilename();
      telephony.startRecording(call,callFilename);
    }
 else {
      telephony.stopRecording(call);
      NotificationManager.fireNotification(NotificationManager.CALL_SAVED,resources.getI18NString("plugin.callrecordingconfig.CALL_SAVED"),resources.getI18NString("plugin.callrecordingconfig.CALL_SAVED_TO",new String[]{callFilename}));
    }
  }
}
