{
  if (event.getServiceReference().getBundle().getState() == Bundle.STOPPING) {
    return;
  }
  Object sourceService=GuiActivator.bundleContext.getService(event.getServiceReference());
  if (!(sourceService instanceof ProtocolProviderService)) {
    return;
  }
  ProtocolProviderService pps=(ProtocolProviderService)sourceService;
  if (event.getType() == ServiceEvent.REGISTERED) {
    String pName=pps.getProtocolName();
    Image protocolImage=null;
    try {
      protocolImage=ImageIO.read(new ByteArrayInputStream(pps.getProtocolIcon().getIcon(ProtocolIcon.ICON_SIZE_16x16)));
    }
 catch (    IOException e) {
      logger.error("Could not read image.",e);
    }
    JLabel protocolLabel=new JLabel();
    protocolLabel.setText(pName);
    protocolLabel.setIcon(new ImageIcon(protocolImage));
    tableModel.addRow(new Object[]{pps,protocolLabel,pps.getAccountID().getUserID()});
  }
 else   if (event.getType() == ServiceEvent.UNREGISTERING) {
    ProtocolProviderFactory sourceFactory=null;
    ServiceReference[] allBundleServices=event.getServiceReference().getBundle().getRegisteredServices();
    for (int i=0; i < allBundleServices.length; i++) {
      Object service=GuiActivator.bundleContext.getService(allBundleServices[i]);
      if (service instanceof ProtocolProviderFactory) {
        sourceFactory=(ProtocolProviderFactory)service;
        break;
      }
    }
    if (sourceFactory.getRegisteredAccounts().contains(pps.getAccountID())) {
      return;
    }
    tableModel.removeRow(tableModel.rowIndexOf(pps));
  }
}
