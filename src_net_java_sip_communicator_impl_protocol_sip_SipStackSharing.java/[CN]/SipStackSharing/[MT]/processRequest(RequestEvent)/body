{
  try {
    Request request=event.getRequest();
    logger.trace("received request: " + request.getMethod());
    if (event.getServerTransaction() == null) {
      try {
        if (request.getHeader(MaxForwardsHeader.NAME) == null) {
          if (Request.INVITE.equals(request.getMethod())) {
            MaxForwardsHeader maxForwards=SipFactory.getInstance().createHeaderFactory().createMaxForwardsHeader(70);
            request.setHeader(maxForwards);
          }
 else {
            logger.trace("Ignoring request without Max-Forwards header: " + event);
            return;
          }
        }
        SipProvider source=(SipProvider)event.getSource();
        ServerTransaction transaction=source.getNewServerTransaction(request);
        event=new RequestEvent(source,transaction,transaction.getDialog(),request);
      }
 catch (      SipException ex) {
        logger.error("couldn't create transaction, please report " + "this to dev@sip-communicator.dev.java.net",ex);
      }
    }
    ProtocolProviderServiceSipImpl service=getServiceData(event.getServerTransaction());
    if (service != null) {
      service.processRequest(event);
    }
 else {
      service=findTargetFor(request);
      if (service == null) {
        logger.error("couldn't find a ProtocolProviderServiceSipImpl " + "to dispatch to");
      }
 else {
        Object container=event.getDialog();
        if (container == null)         container=request;
        SipApplicationData.setApplicationData(container,SipApplicationData.KEY_SERVICE,service);
        service.processRequest(event);
      }
    }
  }
 catch (  Throwable exc) {
    this.logApplicationException(DialogTerminatedEvent.class,exc);
    if (exc instanceof ThreadDeath)     throw (ThreadDeath)exc;
  }
}
