{
  ProtocolProviderServiceJabberImpl provider=getCallPeer().getProtocolProvider();
  NetworkAddressManagerService namSer=getNetAddrMgr();
  Agent agent=namSer.createIceAgent();
  JabberAccountID accID=(JabberAccountID)provider.getAccountID();
  if (accID.isStunServerDiscoveryEnabled()) {
    String username=provider.getOurJID();
    String password=JabberActivator.getProtocolProviderFactory().loadPassword(accID);
    StunCandidateHarvester autoHarvester=null;
    try {
      autoHarvester=namSer.discoverStunServer(accID.getService(),username.getBytes("UTF-8"),password.getBytes("UTF-8"));
      logger.info("Auto discovered harvester is " + autoHarvester);
    }
 catch (    UnsupportedEncodingException exc) {
    }
    if (autoHarvester != null)     agent.addCandidateHarvester(autoHarvester);
  }
  for (  StunServerDescriptor desc : accID.getStunServers()) {
    TransportAddress addr=new TransportAddress(desc.getAddress(),desc.getPort(),Transport.UDP);
    StunCandidateHarvester harvester;
    if (desc.isTurnSupported()) {
      harvester=new TurnCandidateHarvester(addr,new LongTermCredential(desc.getUsername(),desc.getPassword()));
    }
 else {
      harvester=new StunCandidateHarvester(addr);
    }
    logger.info("Adding pre-conficugred harvester " + harvester);
    agent.addCandidateHarvester(harvester);
  }
  return agent;
}
