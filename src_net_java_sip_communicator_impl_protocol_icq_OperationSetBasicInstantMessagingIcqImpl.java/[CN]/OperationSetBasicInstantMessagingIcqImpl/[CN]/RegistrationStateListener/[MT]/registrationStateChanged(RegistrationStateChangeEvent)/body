{
  logger.debug("The ICQ provider changed state from: " + evt.getOldState() + " to: "+ evt.getNewState());
  if (evt.getNewState() == RegistrationState.REGISTERED) {
    logger.debug("adding a Bos Service Listener");
    icqProvider.getAimConnection().getIcbmService().addIcbmListener(joustSimIcbmListener);
    opSetPersPresence=(OperationSetPersistentPresenceIcqImpl)icqProvider.getSupportedOperationSets().get(OperationSetPersistentPresence.class.getName());
    icqProvider.getAimConnection().getIcbmService().getOscarConnection().getSnacProcessor().getCmdFactoryMgr().getDefaultFactoryList().registerAll(channelFourCmdFactory);
    retreiveOfflineMessages();
    if (keepAliveSendTask == null)     keepAliveSendTask=new KeepAliveSendTask();
    keepAliveTimer.scheduleAtFixedRate(keepAliveSendTask,KEEPALIVE_INTERVAL,KEEPALIVE_INTERVAL);
  }
}
