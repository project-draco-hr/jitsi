{
  MediaType mediaType=device.getMediaType();
  MediaStream stream=getStream(mediaType);
  if (stream == null) {
    if (logger.isTraceEnabled() && (mediaType != format.getMediaType()))     logger.trace("The media types of device and format differ.");
    MediaService mediaService=ProtocolMediaActivator.getMediaService();
    SrtpControl control=srtpControls.size() > 0 ? srtpControls.get(new MediaTypeSrtpControl(mediaType,srtpControls.firstKey().srtpControlType)) : null;
    if (control == null) {
      stream=mediaService.createMediaStream(connector,device);
    }
 else {
      stream=mediaService.createMediaStream(connector,device,control);
    }
  }
 else {
  }
  return configureStream(device,format,target,direction,rtpExtensions,stream,masterStream);
}
