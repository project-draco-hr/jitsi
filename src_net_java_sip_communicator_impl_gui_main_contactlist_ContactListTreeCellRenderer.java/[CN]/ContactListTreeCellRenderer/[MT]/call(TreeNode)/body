{
  List<UIContactDetail> telephonyContacts=((ContactNode)treeNode).getContactDescriptor().getContactDetailsForOperationSet(OperationSetBasicTelephony.class);
  ContactNode n=(ContactNode)treeNode;
  MetaContact metaContact=null;
  if (n.getContactDescriptor().getDescriptor() instanceof MetaContact) {
    metaContact=(MetaContact)n.getContactDescriptor().getDescriptor();
    Iterator<Contact> contacts=metaContact.getContacts();
    while (contacts.hasNext()) {
      Contact contact=contacts.next();
      OperationSetServerStoredContactInfo infoOpSet=contact.getProtocolProvider().getOperationSet(OperationSetServerStoredContactInfo.class);
      Iterator<GenericDetail> details=null;
      ArrayList<String> phones=new ArrayList<String>();
      if (infoOpSet != null) {
        details=infoOpSet.getAllDetailsForContact(contact);
        while (details.hasNext()) {
          GenericDetail d=details.next();
          if (d instanceof PhoneNumberDetail) {
            PhoneNumberDetail pnd=(PhoneNumberDetail)d;
            if (pnd.getNumber() != null && pnd.getNumber().length() > 0) {
              phones.add(pnd.getNumber());
              UIContactDetail cd=new UIContactDetail(pnd.getNumber(),pnd.getNumber(),null,new ArrayList<String>(),null,null,null){
                public PresenceStatus getPresenceStatus(){
                  return null;
                }
              }
;
              telephonyContacts.add(cd);
            }
          }
        }
      }
    }
  }
  ChooseCallAccountPopupMenu chooseAccountDialog=null;
  if (telephonyContacts.size() == 1) {
    UIContactDetail detail=telephonyContacts.get(0);
    ProtocolProviderService preferredProvider=detail.getPreferredProtocolProvider(OperationSetBasicTelephony.class);
    List<ProtocolProviderService> providers=GuiActivator.getOpSetRegisteredProviders(OperationSetBasicTelephony.class,preferredProvider,detail.getPreferredProtocol(OperationSetBasicTelephony.class));
    if (providers != null) {
      int providersCount=providers.size();
      if (providersCount <= 0) {
        new ErrorDialog(null,GuiActivator.getResources().getI18NString("service.gui.CALL_FAILED"),GuiActivator.getResources().getI18NString("service.gui.NO_ONLINE_TELEPHONY_ACCOUNT")).showDialog();
      }
 else       if (providersCount == 1) {
        CallManager.createCall(providers.get(0),detail.getAddress());
      }
 else       if (providersCount > 1)       chooseAccountDialog=new ChooseCallAccountPopupMenu(tree,detail.getAddress(),providers);
    }
  }
 else   if (telephonyContacts.size() > 1) {
    chooseAccountDialog=new ChooseCallAccountPopupMenu(tree,telephonyContacts);
  }
  if (chooseAccountDialog != null) {
    Point location=new Point(callButton.getX(),callButton.getY() + callButton.getHeight());
    SwingUtilities.convertPointToScreen(location,tree);
    location.y=location.y + tree.getPathBounds(tree.getSelectionPath()).y;
    chooseAccountDialog.showPopupMenu(location.x + 8,location.y - 8);
  }
}
