{
  UIContactImpl contactDescriptor=((ContactNode)treeNode).getContactDescriptor();
  List<UIContactDetail> desktopContacts=contactDescriptor.getContactDetailsForOperationSet(OperationSetDesktopSharingServer.class);
  if (ConfigurationUtils.isRouteVideoAndDesktopUsingPhoneNumberEnabled() && contactDescriptor.getDescriptor() instanceof MetaContact) {
    desktopContacts.addAll(CallManager.getAdditionalNumbers((MetaContact)contactDescriptor.getDescriptor()));
  }
  ChooseCallAccountPopupMenu chooseAccountDialog=null;
  if (desktopContacts.size() == 1) {
    UIContactDetail detail=desktopContacts.get(0);
    ProtocolProviderService preferredProvider=detail.getPreferredProtocolProvider(OperationSetDesktopSharingServer.class);
    List<ProtocolProviderService> providers=null;
    String protocolName=null;
    if (preferredProvider != null) {
      if (preferredProvider.isRegistered())       shareDesktop(preferredProvider,detail.getAddress());
 else {
        protocolName=preferredProvider.getProtocolName();
        providers=AccountUtils.getRegisteredProviders(protocolName,OperationSetDesktopSharingServer.class);
      }
    }
 else {
      protocolName=detail.getPreferredProtocol(OperationSetDesktopSharingServer.class);
      if (protocolName != null)       providers=AccountUtils.getRegisteredProviders(protocolName,OperationSetDesktopSharingServer.class);
 else       providers=AccountUtils.getRegisteredProviders(OperationSetDesktopSharingServer.class);
    }
    if (providers != null) {
      int providersCount=providers.size();
      if (providersCount <= 0) {
        new ErrorDialog(null,GuiActivator.getResources().getI18NString("service.gui.CALL_FAILED"),GuiActivator.getResources().getI18NString("service.gui.NO_ONLINE_TELEPHONY_ACCOUNT",new String[]{protocolName})).showDialog();
      }
 else       if (providersCount == 1) {
        shareDesktop(providers.get(0),detail.getAddress());
      }
 else       if (providersCount > 1)       chooseAccountDialog=new ChooseCallAccountPopupMenu(treeContactList,detail.getAddress(),providers,OperationSetDesktopSharingServer.class);
    }
  }
 else   if (desktopContacts.size() > 1) {
    chooseAccountDialog=new ChooseCallAccountPopupMenu(treeContactList,desktopContacts,OperationSetDesktopSharingServer.class);
  }
  if (chooseAccountDialog != null) {
    Point location=new Point(desktopSharingButton.getX(),desktopSharingButton.getY() + desktopSharingButton.getHeight());
    SwingUtilities.convertPointToScreen(location,treeContactList);
    location.y=location.y + treeContactList.getPathBounds(treeContactList.getSelectionPath()).y;
    chooseAccountDialog.showPopupMenu(location.x + 8,location.y - 8);
  }
}
