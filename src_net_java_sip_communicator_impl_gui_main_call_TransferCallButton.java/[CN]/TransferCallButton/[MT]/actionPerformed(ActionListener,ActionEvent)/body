{
  final Call call=callParticipant.getCall();
  if (call != null) {
    OperationSetAdvancedTelephony telephony=(OperationSetAdvancedTelephony)call.getProtocolProvider().getOperationSet(OperationSetAdvancedTelephony.class);
    if (telephony != null) {
      final TransferCallDialog dialog=new TransferCallDialog(getFrame(this));
      CallChangeListener callChangeListener=new CallChangeAdapter(){
        public void callStateChanged(        CallChangeEvent evt){
          if (!CallState.CALL_IN_PROGRESS.equals(call.getCallState())) {
            dialog.setVisible(false);
            dialog.dispose();
          }
        }
      }
;
      call.addCallChangeListener(callChangeListener);
      try {
        dialog.setModal(true);
        dialog.pack();
        dialog.setVisible(true);
      }
  finally {
        call.removeCallChangeListener(callChangeListener);
      }
      String target=dialog.getTarget();
      if ((target != null) && (target.length() > 0)) {
        try {
          CallPeer targetParticipant=findCallParticipant(target);
          if (targetParticipant == null) {
            telephony.transfer(callParticipant,target);
          }
 else {
            telephony.transfer(callParticipant,targetParticipant);
          }
        }
 catch (        OperationFailedException ex) {
          logger.error("Failed to transfer call " + call + " to "+ target,ex);
        }
      }
    }
  }
}
