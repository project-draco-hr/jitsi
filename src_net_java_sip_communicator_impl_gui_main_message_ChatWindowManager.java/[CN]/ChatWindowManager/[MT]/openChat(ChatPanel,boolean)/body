{
synchronized (syncChat) {
    ChatWindow chatWindow=chatPanel.getChatWindow();
    boolean isChatVisible=chatPanel.isWindowVisible();
    if (!isChatVisible)     chatWindow.addChat(chatPanel);
    if (chatWindow.isVisible()) {
      if ((ConfigurationManager.isAutoPopupNewMessage() && chatWindow.getExtendedState() != JFrame.ICONIFIED) || setSelected) {
        if (chatWindow.getState() == JFrame.ICONIFIED)         chatWindow.setExtendedState(JFrame.NORMAL);
        chatWindow.toFront();
        chatWindow.setCurrentChatPanel(chatPanel);
      }
 else {
        if (chatWindow.getState() == JFrame.ICONIFIED && !chatWindow.getTitle().startsWith("*")) {
          chatWindow.setTitle("*" + chatWindow.getTitle());
        }
      }
    }
 else {
      chatWindow.setVisible(true);
      chatWindow.setCurrentChatPanel(chatPanel);
    }
    chatPanel.setCaretToEnd();
    if (!chatWindow.getCurrentChatPanel().equals(chatPanel) && chatWindow.getChatTabCount() > 0) {
      chatPanel.getChatWindow().highlightTab(chatPanel);
    }
  }
}
