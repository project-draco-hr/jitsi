{
  if (!(original instanceof MessageIrcImpl)) {
    LOGGER.error("Invalid class of Message implementation received. " + "Not sending message.");
    return;
  }
  final MessageDeliveredEvent[] msgDeliveryPendingEvts=messageDeliveryPendingTransform(new MessageDeliveredEvent(original,to));
  try {
    for (    MessageDeliveredEvent event : msgDeliveryPendingEvts) {
      if (event == null) {
        continue;
      }
      String transformedContent=event.getSourceMessage().getContent();
      MessageIrcImpl message=this.createMessage(transformedContent,original.getContentType(),original.getEncoding(),"");
      final IrcConnection connection=this.provider.getIrcStack().getConnection();
      try {
        if (!event.isMessageEncrypted() && message.isCommand()) {
          try {
            connection.getMessageManager().command(to,message);
            fireMessageDelivered(original,to);
          }
 catch (          final UnsupportedCommandException e) {
            fireMessageDeliveryFailed(message,to,MessageDeliveryFailedEvent.UNSUPPORTED_OPERATION);
          }
        }
 else {
          connection.getMessageManager().message(to,message);
          fireMessageDelivered(original,to);
        }
      }
 catch (      RuntimeException e) {
        LOGGER.debug("Failed to deliver (raw) message: " + message);
        throw e;
      }
    }
  }
 catch (  RuntimeException e) {
    LOGGER.warn("Failed to deliver message: " + original,e);
    fireMessageDeliveryFailed(original,to,MessageDeliveryFailedEvent.NETWORK_FAILURE);
  }
}
