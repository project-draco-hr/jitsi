{
  if (newState.equals(RegistrationState.REGISTERED)) {
    try {
      boolean enableXCap=accountID.getAccountPropertyBoolean(XCAP_ENABLE,true);
      boolean useSipCredetials=accountID.getAccountPropertyBoolean(XCAP_USE_SIP_CREDETIALS,true);
      String serverUri=accountID.getAccountPropertyString(XCAP_SERVER_URI);
      String username=accountID.getAccountPropertyString(ProtocolProviderFactory.USER_ID);
      Address userAddress=parseAddressString(username);
      String password;
      if (useSipCredetials) {
        username=((SipUri)userAddress.getURI()).getUser();
        password=SipActivator.getProtocolProviderFactory().loadPassword(accountID);
      }
 else {
        username=accountID.getAccountPropertyString(XCAP_USER);
        password=accountID.getAccountPropertyString(XCAP_PASSWORD);
      }
      if (enableXCap && serverUri != null) {
        URI uri=new URI(serverUri.trim());
        if (uri.getHost() != null && uri.getPath() != null) {
          xCapClient.connect(uri,userAddress,username,password);
        }
      }
    }
 catch (    Exception e) {
      logger.error("Error while connecting to XCAP server. " + "Contact list won't be saved",e);
    }
  }
 else   if (newState.equals(RegistrationState.UNREGISTERING) || newState.equals(RegistrationState.CONNECTION_FAILED)) {
    xCapClient.disconnect();
  }
  super.fireRegistrationStateChanged(oldState,newState,reasonCode,reason);
}
