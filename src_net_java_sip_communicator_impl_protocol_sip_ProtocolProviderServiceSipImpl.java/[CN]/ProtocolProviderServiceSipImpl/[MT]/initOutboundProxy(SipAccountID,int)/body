{
  String proxyAddressStr=accountID.getAccountPropertyString(ProtocolProviderFactory.PROXY_ADDRESS);
  boolean proxyAddressAndPortEntered=false;
  if (proxyAddressStr == null || proxyAddressStr.trim().length() == 0) {
    proxyAddressStr=accountID.getAccountPropertyString(ProtocolProviderFactory.SERVER_ADDRESS);
    if (proxyAddressStr == null || proxyAddressStr.trim().length() == 0) {
      return;
    }
  }
 else {
    if (accountID.getAccountProperty(ProtocolProviderFactory.PROXY_PORT) != null) {
      proxyAddressAndPortEntered=true;
    }
  }
  InetAddress proxyAddress=null;
  int proxyPort=ListeningPoint.PORT_5060;
  String proxyTransport=accountID.getAccountPropertyString(ProtocolProviderFactory.PREFERRED_TRANSPORT);
  if (proxyTransport != null && proxyTransport.length() > 0) {
    if (!proxyTransport.equals(ListeningPoint.UDP) && !proxyTransport.equals(ListeningPoint.TCP) && !proxyTransport.equals(ListeningPoint.TLS)) {
      throw new IllegalArgumentException(proxyTransport + " is not a valid transport protocol. Transport must be " + "left blank or set to TCP, UDP or TLS.");
    }
  }
 else {
    proxyTransport=getDefaultTransport();
  }
  try {
    proxyPort=accountID.getAccountPropertyInt(ProtocolProviderFactory.PROXY_PORT,proxyPort);
    if (proxyPort > NetworkUtils.MAX_PORT_NUMBER) {
      throw new IllegalArgumentException(proxyPort + " is larger than " + NetworkUtils.MAX_PORT_NUMBER+ " and does not therefore represent a valid port number.");
    }
    InetSocketAddress proxySocketAddress=null;
    if (accountID.getAccountPropertyBoolean(ProtocolProviderFactory.PROXY_AUTO_CONFIG,false)) {
      ArrayList<InetSocketAddress> proxySocketAddressesList=new ArrayList<InetSocketAddress>();
      ArrayList<String> proxyTransportsList=new ArrayList<String>();
      resolveSipAddress(proxyAddressStr,proxyTransport,proxySocketAddressesList,proxyTransportsList,true);
      proxyTransport=proxyTransportsList.get(ix);
      proxySocketAddress=proxySocketAddressesList.get(ix);
    }
 else {
      if (proxyAddressAndPortEntered) {
        ArrayList<InetSocketAddress> addresses=new ArrayList<InetSocketAddress>();
        resolveAddresses(proxyAddressStr,addresses,checkPreferIPv6Addresses(),proxyPort);
        if (addresses.size() > ix)         proxySocketAddress=addresses.get(ix);
      }
 else {
        ArrayList<InetSocketAddress> proxySocketAddressesList=new ArrayList<InetSocketAddress>();
        ArrayList<String> proxyTransportsList=new ArrayList<String>();
        resolveSipAddress(proxyAddressStr,proxyTransport,proxySocketAddressesList,proxyTransportsList,false);
        proxyTransport=proxyTransportsList.get(ix);
        proxySocketAddress=proxySocketAddressesList.get(ix);
      }
    }
    if (proxySocketAddress == null)     throw new UnknownHostException();
    proxyAddress=proxySocketAddress.getAddress();
    proxyPort=proxySocketAddress.getPort();
    proxyAddressStr=proxyAddress.getHostName();
    if (logger.isTraceEnabled())     logger.trace("Setting proxy address = " + proxyAddressStr);
    accountID.putAccountProperty(ProtocolProviderFactory.PROXY_ADDRESS_VALIDATED,Boolean.toString(true));
  }
 catch (  UnknownHostException ex) {
    logger.error(proxyAddressStr + " appears to be an either invalid" + " or inaccessible address.",ex);
    boolean isProxyValidated=accountID.getAccountPropertyBoolean(ProtocolProviderFactory.PROXY_ADDRESS_VALIDATED,false);
    if (!isProxyValidated) {
      throw new IllegalArgumentException(proxyAddressStr + " appears to be an either invalid or" + " inaccessible address.",ex);
    }
  }
  if (proxyAddressStr == null || proxyAddressStr.length() == 0 || proxyAddress == null) {
    return;
  }
  StringBuilder proxyStringBuffer=new StringBuilder(proxyAddress.getHostAddress());
  if (proxyAddress instanceof Inet6Address) {
    proxyStringBuffer.insert(0,'[');
    proxyStringBuffer.append(']');
  }
  proxyStringBuffer.append(':');
  proxyStringBuffer.append(Integer.toString(proxyPort));
  proxyStringBuffer.append('/');
  proxyStringBuffer.append(proxyTransport);
  this.outboundProxyString=proxyStringBuffer.toString();
  this.outboundProxySocketAddress=new InetSocketAddress(proxyAddress,proxyPort);
  this.outboundProxyTransport=proxyTransport;
}
