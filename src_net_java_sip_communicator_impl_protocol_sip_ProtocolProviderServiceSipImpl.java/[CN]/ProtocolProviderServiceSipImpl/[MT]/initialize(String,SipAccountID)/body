{
synchronized (initializationLock) {
    String logDir=SipActivator.getConfigurationService().getScHomeDirLocation() + System.getProperty("file.separator") + SipActivator.getConfigurationService().getScHomeDirName()+ System.getProperty("file.separator");
    if (!NSPVALUE_DEBUG_LOG.startsWith(logDir)) {
      NSPVALUE_DEBUG_LOG=logDir + NSPVALUE_DEBUG_LOG;
    }
    if (!NSPVALUE_SERVER_LOG.startsWith(logDir)) {
      NSPVALUE_SERVER_LOG=logDir + NSPVALUE_SERVER_LOG;
    }
    this.accountID=accountID;
    String protocolIconPath=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.PROTOCOL_ICON_PATH);
    if (protocolIconPath == null)     protocolIconPath="resources/images/protocol/sip";
    this.protocolIcon=new ProtocolIconSipImpl(protocolIconPath);
    this.sipStatusEnum=new SipStatusEnum(protocolIconPath);
    sipFactory=SipFactory.getInstance();
    sipFactory.setPathName("gov.nist");
    this.jainSipStackProperties=new Properties();
    initOutboundProxy(accountID,jainSipStackProperties);
    jainSipStackProperties.setProperty(JSPNAME_STACK_NAME,"SIP Communicator:" + getAccountID().getAccountUniqueID());
    jainSipStackProperties.setProperty(NSPNAME_DEBUG_LOG,NSPVALUE_DEBUG_LOG);
    jainSipStackProperties.setProperty(NSPNAME_SERVER_LOG,NSPVALUE_SERVER_LOG);
    jainSipStackProperties.setProperty(NSPNAME_CACHE_CLIENT_CONNECTIONS,NSPVALUE_CACHE_CLIENT_CONNECTIONS);
    jainSipStackProperties.setProperty(NSPNAME_TRACE_LEVEL,NSPVALUE_TRACE_LEVEL);
    jainSipStackProperties.setProperty(NSPNAME_DELIVER_UNSOLICITED_NOTIFY,NSPVALUE_DELIVER_UNSOLICITED_NOTIFY);
    try {
      jainSipStack=new SipStackImpl(jainSipStackProperties);
      logger.debug("Created stack: " + jainSipStack);
    }
 catch (    PeerUnavailableException exc) {
      logger.fatal("Failed to initialize SIP Stack.",exc);
      throw new OperationFailedException("Failed to create sip stack",OperationFailedException.INTERNAL_ERROR,exc);
    }
    int preferredSipPort=ListeningPoint.PORT_5060;
    String proxyPortStr=SipActivator.getConfigurationService().getString(PREFERRED_SIP_PORT);
    if (proxyPortStr != null && proxyPortStr.length() > 0) {
      try {
        preferredSipPort=Integer.parseInt(proxyPortStr);
      }
 catch (      NumberFormatException ex) {
        logger.error(proxyPortStr + " is not a valid port value. Expected an integer",ex);
      }
      if (preferredSipPort > NetworkUtils.MAX_PORT_NUMBER) {
        logger.error(preferredSipPort + " is larger than " + NetworkUtils.MAX_PORT_NUMBER+ " and does not "+ "therefore represent a valid port nubmer.");
      }
    }
    initListeningPoints(preferredSipPort);
    String enablePresenceObj=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.IS_PRESENCE_ENABLED);
    boolean enablePresence=true;
    if (enablePresenceObj != null) {
      enablePresence=Boolean.valueOf(enablePresenceObj).booleanValue();
    }
    String forceP2PObj=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.FORCE_P2P_MODE);
    boolean forceP2P=true;
    if (forceP2PObj != null) {
      forceP2P=Boolean.valueOf(forceP2PObj).booleanValue();
    }
    int pollingValue=30;
    try {
      String pollingString=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.POLLING_PERIOD);
      if (pollingString != null) {
        pollingValue=Integer.parseInt(pollingString);
      }
 else {
        logger.warn("no polling value found, using default value" + " (" + pollingValue + ")");
      }
    }
 catch (    NumberFormatException e) {
      logger.error("wrong polling value stored",e);
    }
    int subscriptionExpiration=3600;
    try {
      String subscriptionString=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.SUBSCRIPTION_EXPIRATION);
      if (subscriptionString != null) {
        subscriptionExpiration=Integer.parseInt(subscriptionString);
      }
 else {
        logger.warn("no expiration value found, using default value" + " (" + subscriptionExpiration + ")");
      }
    }
 catch (    NumberFormatException e) {
      logger.error("wrong expiration value stored",e);
    }
    headerFactory=new HeaderFactoryImpl();
    addressFactory=new AddressFactoryImpl();
    messageFactory=new MessageFactoryImpl();
    initRegistrarConnection(accountID);
    OperationSetAdvancedTelephony opSetAdvancedTelephony=new OperationSetBasicTelephonySipImpl(this);
    this.supportedOperationSets.put(OperationSetBasicTelephony.class.getName(),opSetAdvancedTelephony);
    this.supportedOperationSets.put(OperationSetAdvancedTelephony.class.getName(),opSetAdvancedTelephony);
    this.supportedOperationSets.put(OperationSetSecureTelephony.class.getName(),opSetAdvancedTelephony);
    OperationSetPersistentPresence opSetPersPresence=new OperationSetPresenceSipImpl(this,enablePresence,forceP2P,pollingValue,subscriptionExpiration);
    this.supportedOperationSets.put(OperationSetPersistentPresence.class.getName(),opSetPersPresence);
    this.supportedOperationSets.put(OperationSetPresence.class.getName(),opSetPersPresence);
    OperationSetBasicInstantMessagingSipImpl opSetBasicIM=new OperationSetBasicInstantMessagingSipImpl(this);
    this.supportedOperationSets.put(OperationSetBasicInstantMessaging.class.getName(),opSetBasicIM);
    OperationSetTypingNotificationsSipImpl opSetTyping=new OperationSetTypingNotificationsSipImpl(this,opSetBasicIM);
    this.supportedOperationSets.put(OperationSetTypingNotifications.class.getName(),opSetTyping);
    OperationSetDTMF opSetDTMF=new OperationSetDTMFSipImpl(this);
    this.supportedOperationSets.put(OperationSetDTMF.class.getName(),opSetDTMF);
    ClientCapabilities capabilities=new ClientCapabilities(this);
    ourDisplayName=(String)accountID.getAccountProperties().get(ProtocolProviderFactory.DISPLAY_NAME);
    if (ourDisplayName == null || ourDisplayName.trim().length() == 0) {
      ourDisplayName=accountID.getUserID();
    }
    this.sipSecurityManager=new SipSecurityManager(accountID);
    sipSecurityManager.setHeaderFactory(headerFactory);
    isInitialized=true;
  }
}
