{
  OperationSetPresence presence=protocolProvider.getOperationSet(OperationSetPresence.class);
  LoginManager loginManager=GuiActivator.getUIService().getLoginManager();
  RegistrationState registrationState=protocolProvider.getRegistrationState();
  if (registrationState == RegistrationState.REGISTERED && presence != null && !presence.getPresenceStatus().equals(status)) {
    if (status.isOnline()) {
      new PublishPresenceStatusThread(protocolProvider,presence,status).start();
    }
 else {
      loginManager.setManuallyDisconnected(true);
      GuiActivator.getUIService().getLoginManager().logoff(protocolProvider);
    }
  }
 else   if (registrationState != RegistrationState.REGISTERED && registrationState != RegistrationState.REGISTERING && registrationState != RegistrationState.AUTHENTICATING && status.isOnline()) {
    GuiActivator.getUIService().getLoginManager().login(protocolProvider);
  }
 else   if (!status.isOnline() && !(registrationState == RegistrationState.UNREGISTERING)) {
    loginManager.setManuallyDisconnected(true);
    GuiActivator.getUIService().getLoginManager().logoff(protocolProvider);
  }
  if (rememberStatus)   saveStatusInformation(protocolProvider,status.getStatusName());
}
