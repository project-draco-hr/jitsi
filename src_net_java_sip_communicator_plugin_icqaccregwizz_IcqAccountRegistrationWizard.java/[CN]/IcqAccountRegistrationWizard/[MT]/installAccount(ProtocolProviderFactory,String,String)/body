{
  Hashtable accountProperties=new Hashtable();
  if (registration.isRememberPassword()) {
    accountProperties.put(ProtocolProviderFactory.PASSWORD,passwd);
  }
  if (registration.getProxyType() != null) {
    accountProperties.put(ProtocolProviderFactory.PROXY_ADDRESS,registration.getProxy());
    accountProperties.put(ProtocolProviderFactory.PROXY_PORT,registration.getProxyPort());
    accountProperties.put(ProtocolProviderFactory.PROXY_TYPE,registration.getProxyType());
    accountProperties.put(ProtocolProviderFactory.PROXY_USERNAME,registration.getProxyUsername());
    accountProperties.put(ProtocolProviderFactory.PROXY_PASSWORD,registration.getProxyPassword());
  }
  if (isModification) {
    providerFactory.uninstallAccount(protocolProvider.getAccountID());
    this.protocolProvider=null;
  }
  try {
    AccountID accountID=providerFactory.installAccount(user,accountProperties);
    ServiceReference serRef=providerFactory.getProviderForAccount(accountID);
    protocolProvider=(ProtocolProviderService)IcqAccRegWizzActivator.bundleContext.getService(serRef);
  }
 catch (  IllegalArgumentException e) {
    new ErrorDialog(null,e.getMessage(),e).showDialog();
  }
catch (  IllegalStateException e) {
    new ErrorDialog(null,e.getMessage(),e).showDialog();
  }
  return protocolProvider;
}
