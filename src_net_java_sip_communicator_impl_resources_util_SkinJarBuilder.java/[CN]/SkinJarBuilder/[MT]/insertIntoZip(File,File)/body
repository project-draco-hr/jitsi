{
  File tempFile=File.createTempFile(jar.getName(),null);
  tempFile.delete();
  boolean renameOk=jar.renameTo(tempFile);
  if (!renameOk) {
    throw new IOException("Error moving file " + jar.getAbsolutePath() + " to "+ tempFile.getAbsolutePath());
  }
  byte[] buf=new byte[8192];
  ZipInputStream zin=new ZipInputStream(new FileInputStream(tempFile));
  ZipOutputStream out=new ZipOutputStream(new FileOutputStream(jar));
  ZipEntry entry=zin.getNextEntry();
  while (entry != null) {
    String name=entry.getName();
    out.putNextEntry(new ZipEntry(name));
    int len;
    while ((len=zin.read(buf)) > 0) {
      out.write(buf,0,len);
    }
    entry=zin.getNextEntry();
  }
  zin.close();
  tempFile.delete();
  zipDir(tmpDir.getAbsolutePath(),out);
  out.close();
}
