{
  Request req;
  try {
    req=dialog.createRequest(Request.SUBSCRIBE);
  }
 catch (  SipException e) {
    logger.error("Can't create the SUBSCRIBE message",e);
    throw new OperationFailedException("An unexpected error occurred while" + "constructing the SUBSCRIBE request",OperationFailedException.INTERNAL_ERROR,e);
  }
  Address toAddress=dialog.getRemoteTarget();
  if (toAddress == null)   toAddress=dialog.getRemoteParty();
  MaxForwardsHeader maxForwards=protocolProvider.getMaxForwardsHeader();
  req.setHeader(maxForwards);
  ClientTransaction transac=null;
  try {
    transac=protocolProvider.getDefaultJainSipProvider().getNewClientTransaction(req);
  }
 catch (  TransactionUnavailableException ex) {
    logger.error("Failed to create subscriptionTransaction.\n" + "This is most probably a network connection error.",ex);
    throw new OperationFailedException("Failed to create the subscription transaction",OperationFailedException.NETWORK_FAILURE);
  }
  List<ViaHeader> viaHeaders=protocolProvider.getLocalViaHeaders(toAddress);
  req.setHeader((Header)viaHeaders.get(0));
  populateSubscribeRequest(req,subscription,expires);
  return transac;
}
