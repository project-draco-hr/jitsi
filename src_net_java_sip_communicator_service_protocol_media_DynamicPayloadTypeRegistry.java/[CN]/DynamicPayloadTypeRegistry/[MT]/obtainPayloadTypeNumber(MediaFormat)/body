{
  MediaType mediaType=format.getMediaType();
  String encoding=format.getEncoding();
  double clockRate=format.getClockRate();
  int channels=MediaType.AUDIO.equals(mediaType) ? ((AudioMediaFormat)format).getChannels() : MediaFormatFactory.CHANNELS_NOT_SPECIFIED;
  Byte payloadType=null;
  Map<String,String> formatParameters=format.getFormatParameters();
  for (  Map.Entry<MediaFormat,Byte> payloadTypeMapping : payloadTypeMappings.entrySet()) {
    if (AbstractMediaStream.matches(payloadTypeMapping.getKey(),mediaType,encoding,clockRate,channels,formatParameters)) {
      payloadType=payloadTypeMapping.getValue();
      break;
    }
  }
  if (payloadType == null) {
    Byte preferredPT=getPreferredDynamicPayloadType(format);
    if (preferredPT != null && findFormat(preferredPT) == null) {
      payloadType=preferredPT;
    }
 else {
      payloadType=nextPayloadTypeNumber();
    }
    payloadTypeMappings.put(format,payloadType);
  }
  return payloadType;
}
