{
  Map supportedOperationSets=protocolProvider.getSupportedOperationSets();
  this.protocolSupportedOperationSets.put(protocolProvider,supportedOperationSets);
  String ppOpSetClassName=OperationSetPersistentPresence.class.getName();
  String pOpSetClassName=OperationSetPresence.class.getName();
  if (supportedOperationSets.containsKey(ppOpSetClassName) || supportedOperationSets.containsKey(pOpSetClassName)) {
    OperationSetPresence presence=(OperationSetPresence)supportedOperationSets.get(ppOpSetClassName);
    if (presence == null) {
      presence=(OperationSetPresence)supportedOperationSets.get(pOpSetClassName);
    }
    this.protocolPresenceSets.put(protocolProvider,presence);
    presence.addProviderPresenceStatusListener(new ProviderPresenceStatusAdapter());
    presence.addContactPresenceStatusListener(new ContactPresenceStatusAdapter());
    presence.setAuthorizationHandler(new AuthorizationHandlerImpl());
    try {
      presence.publishPresenceStatus(IcqStatusEnum.ONLINE,"");
    }
 catch (    OperationFailedException e) {
      logger.error("Publish presence status failed.",e);
    }
    this.getStatusPanel().stopConnecting(protocolProvider);
    this.statusPanel.setSelectedStatus(protocolProvider,Constants.ONLINE_STATUS);
    this.tabbedPane.getContactListPanel().getContactList().requestFocus();
  }
  String imOpSetClassName=OperationSetBasicInstantMessaging.class.getName();
  if (supportedOperationSets.containsKey(imOpSetClassName)) {
    OperationSetBasicInstantMessaging im=(OperationSetBasicInstantMessaging)supportedOperationSets.get(imOpSetClassName);
    this.imOperationSets.put(protocolProvider,im);
    im.addMessageListener(this.getTabbedPane().getContactListPanel());
  }
  String tnOpSetClassName=OperationSetTypingNotifications.class.getName();
  if (supportedOperationSets.containsKey(tnOpSetClassName)) {
    OperationSetTypingNotifications tn=(OperationSetTypingNotifications)supportedOperationSets.get(tnOpSetClassName);
    this.tnOperationSets.put(protocolProvider,tn);
    tn.addTypingNotificationsListener(this.getTabbedPane().getContactListPanel());
  }
  String wciOpSetClassName=OperationSetWebContactInfo.class.getName();
  if (supportedOperationSets.containsKey(wciOpSetClassName)) {
    OperationSetWebContactInfo wContactInfo=(OperationSetWebContactInfo)supportedOperationSets.get(wciOpSetClassName);
    this.webContactInfoOperationSets.put(protocolProvider,wContactInfo);
  }
}
