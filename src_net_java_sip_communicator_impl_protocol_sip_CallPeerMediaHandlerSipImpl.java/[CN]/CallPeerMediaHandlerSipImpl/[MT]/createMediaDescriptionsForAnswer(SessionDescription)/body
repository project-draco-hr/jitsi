{
  List<MediaDescription> remoteDescriptions=SdpUtils.extractMediaDescriptions(offer);
  Vector<MediaDescription> answerDescriptions=new Vector<MediaDescription>(remoteDescriptions.size());
  this.setCallInfoURL(SdpUtils.getCallInfoURL(offer));
  boolean atLeastOneValidDescription=false;
  for (  MediaDescription mediaDescription : remoteDescriptions) {
    MediaType mediaType=SdpUtils.getMediaType(mediaDescription);
    List<MediaFormat> remoteFormats=SdpUtils.extractFormats(mediaDescription,getDynamicPayloadTypes());
    MediaDevice dev=getDefaultDevice(mediaType);
    MediaDirection devDirection=(dev == null) ? MediaDirection.INACTIVE : dev.getDirection();
    devDirection=devDirection.and(getDirectionUserPreference(mediaType));
    MediaDirection remoteDirection=SdpUtils.getDirection(mediaDescription);
    MediaDirection direction=devDirection.getDirectionForAnswer(remoteDirection);
    List<MediaFormat> mutuallySupportedFormats=intersectFormats(remoteFormats,dev.getSupportedFormats());
    List<RTPExtension> offeredRTPExtensions=SdpUtils.extractRTPExtensions(mediaDescription,this.getRtpExtensionsRegistry());
    List<RTPExtension> supportedExtensions=getExtensionsForType(mediaType);
    List<RTPExtension> rtpExtensions=intersectRTPExtensions(offeredRTPExtensions,supportedExtensions);
    MediaStreamTarget target=SdpUtils.extractDefaultTarget(mediaDescription,offer);
    int targetDataPort=target.getDataAddress().getPort();
    if (mutuallySupportedFormats.isEmpty() || (devDirection == MediaDirection.INACTIVE) || (targetDataPort == 0)) {
      answerDescriptions.add(SdpUtils.createDisablingAnswer(mediaDescription));
      closeStream(mediaType);
      continue;
    }
    StreamConnector connector=getTransportManager().getStreamConnector(mediaType);
    MediaFormat fmt=findMediaFormat(remoteFormats,mutuallySupportedFormats.get(0));
    initStream(connector,dev,fmt,target,direction,rtpExtensions);
    MediaDescription md=createMediaDescription(mutuallySupportedFormats,connector,direction,rtpExtensions);
    updateMediaDescriptionForZrtp(mediaType,md);
    answerDescriptions.add(md);
    atLeastOneValidDescription=true;
  }
  if (!atLeastOneValidDescription)   throw new OperationFailedException("Offer contained no valid " + "media descriptions.",OperationFailedException.ILLEGAL_ARGUMENT);
  return answerDescriptions;
}
