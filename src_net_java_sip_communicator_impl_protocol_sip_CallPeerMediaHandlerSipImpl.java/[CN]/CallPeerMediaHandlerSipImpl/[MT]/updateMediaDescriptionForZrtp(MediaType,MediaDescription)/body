{
  MediaAwareCallPeer<?,?,?> peer=getPeer();
  if (peer.getProtocolProvider().getAccountID().getAccountPropertyBoolean(ProtocolProviderFactory.DEFAULT_ENCRYPTION,true) && peer.getProtocolProvider().getAccountID().isEncryptionProtocolEnabled("ZRTP") && peer.getCall().isSipZrtpAttribute()) {
    try {
      Map<MediaTypeSrtpControl,SrtpControl> srtpControls=getSrtpControls();
      MediaTypeSrtpControl key=new MediaTypeSrtpControl(mediaType,SrtpControlType.ZRTP);
      SrtpControl scontrol=srtpControls.get(key);
      if (scontrol == null) {
        scontrol=SipActivator.getMediaService().createZrtpControl();
        srtpControls.put(key,scontrol);
      }
      ZrtpControl zcontrol=(ZrtpControl)scontrol;
      int versionIndex=zcontrol.getNumberSupportedVersions();
      boolean zrtpHashSet=false;
      for (int i=0; i < versionIndex; i++) {
        String helloHash=zcontrol.getHelloHash(i);
        if (helloHash != null && helloHash.length() > 0) {
          md.setAttribute(SdpUtils.ZRTP_HASH_ATTR,helloHash);
          zrtpHashSet=true;
        }
      }
      return zrtpHashSet;
    }
 catch (    SdpException ex) {
      logger.error("Cannot add zrtp-hash to sdp",ex);
    }
  }
  return false;
}
