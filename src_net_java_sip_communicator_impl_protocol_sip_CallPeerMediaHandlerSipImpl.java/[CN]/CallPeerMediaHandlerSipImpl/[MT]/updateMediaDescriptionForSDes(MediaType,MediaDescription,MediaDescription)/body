{
{
    SrtpControl scontrol=getZrtpControls().get(mediaType);
    if (scontrol == null || !(scontrol instanceof SDesControl)) {
      scontrol=SipActivator.getMediaService().createSDesControl();
      getZrtpControls().put(mediaType,scontrol);
    }
    SDesControl sdcontrol=(SDesControl)scontrol;
    if (peerMd == null) {
      Vector<Attribute> atts=localMd.getAttributes(true);
      for (      String ca : sdcontrol.getInitiatorCryptoAttributes()) {
        Attribute a=SdpUtils.createAttribute("crypto",ca);
        atts.add(a);
      }
    }
 else {
      Vector<Attribute> atts=peerMd.getAttributes(true);
      List<String> peerAttributes=new LinkedList<String>();
      for (      Attribute a : atts) {
        try {
          if (a.getName().equals("crypto")) {
            peerAttributes.add(a.getValue());
          }
        }
 catch (        SdpParseException e) {
          logger.error("received an uparsable sdp attribute",e);
        }
      }
      if (peerAttributes.size() > 0) {
        String localAttr=sdcontrol.responderSelectAttribute(peerAttributes.toArray(new String[peerAttributes.size()]));
        if (localAttr != null) {
          try {
            localMd.setAttribute("crypto",localAttr);
          }
 catch (          SdpException e) {
            logger.error("unable to add crypto to answer",e);
          }
        }
      }
    }
  }
}
