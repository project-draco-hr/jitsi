{
  AccountID accountID=getPeer().getProtocolProvider().getAccountID();
  if (!accountID.getAccountPropertyBoolean(ProtocolProviderFactory.SDES_ENABLED,false) || !accountID.getAccountPropertyBoolean(ProtocolProviderFactory.DEFAULT_ENCRYPTION,true)) {
    return false;
  }
  Map<MediaTypeSrtpControl,SrtpControl> srtpControls=getSrtpControls();
  MediaTypeSrtpControl key=new MediaTypeSrtpControl(mediaType,SrtpControlType.SDES);
  SrtpControl scontrol=srtpControls.get(key);
  if (scontrol == null) {
    scontrol=SipActivator.getMediaService().createSDesControl();
    srtpControls.put(key,scontrol);
  }
  SDesControl sdcontrol=(SDesControl)scontrol;
  String ciphers=accountID.getAccountPropertyString(ProtocolProviderFactory.SDES_CIPHER_SUITES);
  if (ciphers == null) {
    ciphers=SipActivator.getResources().getSettingsString(SDesControl.SDES_CIPHER_SUITES);
  }
  sdcontrol.setEnabledCiphers(Arrays.asList(ciphers.split(",")));
  if (remoteMd == null) {
    @SuppressWarnings("unchecked") Vector<Attribute> atts=localMd.getAttributes(true);
    for (    String ca : sdcontrol.getInitiatorCryptoAttributes())     atts.add(SdpUtils.createAttribute("crypto",ca));
    return true;
  }
 else {
    @SuppressWarnings("unchecked") Vector<Attribute> atts=remoteMd.getAttributes(true);
    List<String> peerAttributes=new LinkedList<String>();
    for (    Attribute a : atts) {
      try {
        if (a.getName().equals("crypto"))         peerAttributes.add(a.getValue());
      }
 catch (      SdpParseException e) {
        logger.error("received an uparsable sdp attribute",e);
      }
    }
    if (peerAttributes.size() > 0) {
      String localAttr=sdcontrol.responderSelectAttribute(peerAttributes);
      if (localAttr != null) {
        try {
          localMd.setAttribute("crypto",localAttr);
          return true;
        }
 catch (        SdpException e) {
          logger.error("unable to add crypto to answer",e);
        }
      }
 else {
        sdcontrol.cleanup();
        srtpControls.remove(key);
        logger.warn("Received unsupported sdes crypto attribute " + peerAttributes);
      }
    }
 else {
      sdcontrol.cleanup();
      srtpControls.remove(key);
    }
    return false;
  }
}
