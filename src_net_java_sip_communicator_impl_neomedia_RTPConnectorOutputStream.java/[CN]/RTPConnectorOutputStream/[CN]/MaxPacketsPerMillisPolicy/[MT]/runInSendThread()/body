{
  try {
    while (sendRun) {
      RawPacket packet=null;
      while (true) {
        try {
          packet=packetQueue.take();
          break;
        }
 catch (        InterruptedException iex) {
          continue;
        }
      }
      if (!sendRun)       break;
      long time=System.nanoTime();
      long millisRemainingTime=time - millisStartTime;
      if ((perNanos < 1) || (millisRemainingTime >= perNanos)) {
        millisStartTime=time;
        packetsSentInMillis=0;
      }
 else       if ((maxPackets > 0) && (packetsSentInMillis >= maxPackets)) {
        while (true) {
          millisRemainingTime=System.nanoTime() - millisStartTime;
          if (millisRemainingTime >= perNanos)           break;
          LockSupport.parkNanos(millisRemainingTime);
        }
        millisStartTime=System.nanoTime();
        packetsSentInMillis=0;
      }
      send(packet);
      packetsSentInMillis++;
    }
  }
  finally {
    packetQueue.clear();
synchronized (packetQueue) {
      if (Thread.currentThread().equals(sendThread))       sendThread=null;
    }
  }
}
