{
  if (maxPacketsPerMillisPolicy != null) {
    byte[] newBuffer=new byte[length];
    System.arraycopy(buffer,offset,newBuffer,0,length);
    buffer=newBuffer;
    offset=0;
  }
  RawPacket packet=createRawPacket(buffer,offset,length);
  if (packet != null) {
    if (maxPacketsPerMillisPolicy == null) {
      if (!send(packet))       return -1;
    }
 else     maxPacketsPerMillisPolicy.write(packet);
  }
  return length;
}
