{
  if (!SwingUtilities.isEventDispatchThread()) {
    SwingUtilities.invokeLater(new Runnable(){
      @Override public void run(){
        localUserPresenceChanged(evt);
      }
    }
);
    return;
  }
  ChatRoom sourceChatRoom=evt.getChatRoom();
  ChatRoomWrapper chatRoomWrapper=GuiActivator.getMUCService().findChatRoomWrapperFromChatRoom(sourceChatRoom);
  String eventType=evt.getEventType();
  if (LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_JOINED.equals(eventType)) {
    if (chatRoomWrapper != null) {
      GuiActivator.getMUCService().fireChatRoomListChangedEvent(chatRoomWrapper,ChatRoomListChangeEvent.CHAT_ROOM_CHANGED);
      MessageHistoryService mhs=GuiActivator.getMessageHistoryService();
      boolean createWindow=false;
      if (!mhs.isHistoryLoggingEnabled() || !mhs.isHistoryLoggingEnabled(sourceChatRoom.getIdentifier()))       createWindow=true;
      ChatWindowManager chatWindowManager=GuiActivator.getUIService().getChatWindowManager();
      ChatPanel chatPanel=chatWindowManager.getMultiChat(chatRoomWrapper,createWindow);
      if (chatPanel != null) {
        chatPanel.setChatIcon(chatPanel.getChatSession().getChatStatusIcon());
        if (chatPanel.isShown()) {
          ((ConferenceChatSession)chatPanel.getChatSession()).loadChatRoom(sourceChatRoom);
        }
 else {
          chatWindowManager.openChat(chatPanel,true);
        }
      }
    }
    if (sourceChatRoom.isSystem()) {
      ChatRoomProviderWrapper serverWrapper=GuiActivator.getMUCService().findServerWrapperFromProvider(sourceChatRoom.getParentProvider());
      serverWrapper.setSystemRoom(sourceChatRoom);
    }
    sourceChatRoom.addMessageListener(this);
    sourceChatRoom.addLocalUserRoleListener(this);
  }
 else   if (LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_JOIN_FAILED.equals(eventType)) {
    GuiActivator.getAlertUIService().showAlertPopup(GuiActivator.getResources().getI18NString("service.gui.ERROR"),GuiActivator.getResources().getI18NString("service.gui.FAILED_TO_JOIN_CHAT_ROOM",new String[]{sourceChatRoom.getName()}) + evt.getReason());
  }
 else   if (LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_LEFT.equals(eventType) || LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_KICKED.equals(eventType) || LocalUserChatRoomPresenceChangeEvent.LOCAL_USER_DROPPED.equals(eventType)) {
    if (chatRoomWrapper != null) {
      GuiActivator.getUIService().closeChatRoomWindow(chatRoomWrapper);
      GuiActivator.getMUCService().fireChatRoomListChangedEvent(chatRoomWrapper,ChatRoomListChangeEvent.CHAT_ROOM_CHANGED);
    }
    sourceChatRoom.removeMessageListener(this);
    sourceChatRoom.removelocalUserRoleListener(this);
  }
}
