{
  EventHeader eventHeader=(EventHeader)notifyRequest.getHeader(EventHeader.NAME);
  if ((eventHeader == null) || !"refer".equals(eventHeader.getEventType())) {
    return false;
  }
  SubscriptionStateHeader ssHeader=(SubscriptionStateHeader)notifyRequest.getHeader(SubscriptionStateHeader.NAME);
  if (ssHeader == null) {
    logger.error("NOTIFY of refer event type with no Subscription-State header.");
    return false;
  }
  Dialog dialog=serverTransaction.getDialog();
  CallParticipantSipImpl participant=activeCallsRepository.findCallParticipant(dialog);
  if (participant == null) {
    logger.debug("Received a stray refer NOTIFY request.");
    return false;
  }
  Response ok;
  try {
    ok=createOKResponse(notifyRequest,dialog);
  }
 catch (  ParseException ex) {
    String message="Failed to create OK response to refer NOTIFY request.";
    logger.error(message,ex);
    participant.setState(CallParticipantState.DISCONNECTED,message);
    return false;
  }
  try {
    serverTransaction.sendResponse(ok);
  }
 catch (  Exception ex) {
    String message="Failed to send OK response to refer NOTIFY request.";
    logger.error(message,ex);
    participant.setState(CallParticipantState.DISCONNECTED,message);
    return false;
  }
  if (SubscriptionStateHeader.TERMINATED.equals(ssHeader.getState()) && (DialogUtils.removeSubscriptionThenIsDialogAlive(dialog,"refer") == false)) {
    participant.setState(CallParticipantState.DISCONNECTED);
  }
  if ((CallParticipantState.DISCONNECTED.equals(participant.getState()) == false) && (DialogUtils.isByeProcessed(dialog) == false)) {
    boolean dialogIsAlive;
    try {
      dialogIsAlive=sayBye(participant);
    }
 catch (    OperationFailedException ex) {
      logger.error("Failed to send BYE in response to refer NOTIFY request.",ex);
      dialogIsAlive=false;
    }
    if (dialogIsAlive == false) {
      participant.setState(CallParticipantState.DISCONNECTED);
    }
  }
  return true;
}
