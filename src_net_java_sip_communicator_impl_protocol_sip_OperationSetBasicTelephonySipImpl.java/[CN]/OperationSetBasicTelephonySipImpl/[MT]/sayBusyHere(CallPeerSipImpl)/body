{
  Request request=callPeer.getFirstTransaction().getRequest();
  Response busyHere=null;
  try {
    busyHere=protocolProvider.getMessageFactory().createResponse(Response.BUSY_HERE,request);
    busyHere.setHeader(protocolProvider.getSipCommUserAgentHeader());
    protocolProvider.attachToTag(busyHere,callPeer.getDialog());
  }
 catch (  ParseException ex) {
    ProtocolProviderServiceSipImpl.throwOperationFailedException("Failed to create the BUSY_HERE response!",OperationFailedException.INTERNAL_ERROR,ex,logger);
  }
  if (!callPeer.getDialog().isServer()) {
    logger.error("Cannot send BUSY_HERE in a client transaction");
    throw new OperationFailedException("Cannot send BUSY_HERE in a client transaction",OperationFailedException.INTERNAL_ERROR);
  }
  ServerTransaction serverTransaction=(ServerTransaction)callPeer.getFirstTransaction();
  try {
    serverTransaction.sendResponse(busyHere);
    logger.debug("sent response:\n" + busyHere);
  }
 catch (  Exception ex) {
    ProtocolProviderServiceSipImpl.throwOperationFailedException("Failed to send the BUSY_HERE response",OperationFailedException.NETWORK_FAILURE,ex,logger);
  }
}
