{
  if (!protocolProvider.isRegistered()) {
    throw new OperationFailedException("The protocol provider should be registered " + "before placing an outgoing call.",OperationFailedException.PROVIDER_NOT_REGISTERED);
  }
  Request invite=createInviteRequest(calleeAddress);
  ContentTypeHeader contentTypeHeader=null;
  try {
    contentTypeHeader=protocolProvider.getHeaderFactory().createContentTypeHeader("application","sdp");
  }
 catch (  ParseException ex) {
    logger.error("Failed to create a content type header for the INVITE " + "request",ex);
    throw new OperationFailedException("Failed to create a content type header for the INVITE " + "request",OperationFailedException.INTERNAL_ERROR,ex);
  }
  CallIdHeader call=(CallIdHeader)invite.getHeader(CallIdHeader.NAME);
  String callid=call.getCallId();
  AuthorizationHeader authorization=protocolProvider.getSipSecurityManager().getCachedAuthorizationHeader(callid);
  if (authorization != null)   invite.addHeader(authorization);
  ClientTransaction inviteTransaction;
  SipProvider jainSipProvider=protocolProvider.getDefaultJainSipProvider();
  try {
    inviteTransaction=jainSipProvider.getNewClientTransaction(invite);
  }
 catch (  TransactionUnavailableException ex) {
    logger.error("Failed to create inviteTransaction.\n" + "This is most probably a network connection error.",ex);
    throw new OperationFailedException("Failed to create inviteTransaction.\n" + "This is most probably a network connection error.",OperationFailedException.INTERNAL_ERROR,ex);
  }
  CallParticipantSipImpl callParticipant=createCallParticipantFor(inviteTransaction,jainSipProvider);
  try {
    CallSession callSession=SipActivator.getMediaService().createCallSession(callParticipant.getCall());
    ((CallSipImpl)callParticipant.getCall()).setMediaCallSession(callSession);
    javax.sip.address.URI calleeURI=calleeAddress.getURI();
    InetAddress intendedDestination=null;
    if (calleeURI.isSipURI()) {
      String host=((SipURI)calleeURI).getHost();
      try {
        intendedDestination=InetAddress.getByName(host);
        invite.setContent(callSession.createSdpOffer(intendedDestination),contentTypeHeader);
      }
 catch (      UnknownHostException ex) {
        logger.warn("Failed to obtain an InetAddress for " + host,ex);
      }
    }
  }
 catch (  ParseException ex) {
    logger.error("Failed to parse sdp data while creating invite request!",ex);
    throw new OperationFailedException("Failed to parse sdp data while creating invite request!",OperationFailedException.INTERNAL_ERROR,ex);
  }
catch (  MediaException ex) {
    logger.error("Could not access media devices!",ex);
    throw new OperationFailedException("Could not access media devices!",OperationFailedException.INTERNAL_ERROR,ex);
  }
  try {
    inviteTransaction.sendRequest();
    if (logger.isDebugEnabled())     logger.debug("sent request: " + invite);
  }
 catch (  SipException ex) {
    logger.error("An error occurred while sending invite request",ex);
    throw new OperationFailedException("An error occurred while sending invite request",OperationFailedException.NETWORK_FAILURE,ex);
  }
  return (CallSipImpl)callParticipant.getCall();
}
