{
  Dialog dialog=serverTransaction.getDialog();
  CallParticipantSipImpl callParticipant=activeCallsRepository.findCallParticipant(dialog);
  int statusCode;
  if (callParticipant == null) {
    statusCode=Response.RINGING;
    logger.trace("Creating call participant.");
    callParticipant=createCallParticipantFor(serverTransaction,sourceProvider);
    logger.trace("call participant created = " + callParticipant);
  }
 else   statusCode=Response.OK;
  ContentLengthHeader cl=invite.getContentLength();
  if (cl != null && cl.getContentLength() > 0) {
    callParticipant.setSdpDescription(new String(invite.getRawContent()));
  }
  logger.trace("Will verify whether INVITE is properly addressed.");
  javax.sip.address.URI calleeURI=dialog.getLocalParty().getURI();
  if (calleeURI.isSipURI()) {
    boolean assertUserMatch=Boolean.valueOf(SipActivator.getConfigurationService().getString(FAIL_CALLS_ON_DEST_USER_MISMATCH)).booleanValue();
    if (assertUserMatch) {
      String calleeUser=((SipURI)calleeURI).getUser();
      String localUser=protocolProvider.getAccountID().getUserID();
      if (calleeUser != null && !calleeUser.equals(localUser)) {
        callParticipant.setState(CallParticipantState.FAILED,"A call was received here while it appeared " + "destined to someone else. The call was rejected.");
        Response notFound=null;
        try {
          notFound=protocolProvider.getMessageFactory().createResponse(Response.NOT_FOUND,invite);
          protocolProvider.attachToTag(notFound,dialog);
          notFound.setHeader(protocolProvider.getSipCommUserAgentHeader());
        }
 catch (        ParseException ex) {
          logger.error("Error while trying to create a response",ex);
          callParticipant.setState(CallParticipantState.FAILED,"InernalError: " + ex.getMessage());
          return;
        }
        try {
          serverTransaction.sendResponse(notFound);
          logger.debug("sent a not found response: " + notFound);
        }
 catch (        Exception ex) {
          logger.error("Error while trying to send a response",ex);
          callParticipant.setState(CallParticipantState.FAILED,"Internal Error: " + ex.getMessage());
          return;
        }
        return;
      }
    }
  }
  String statusCodeString=(statusCode == Response.RINGING) ? "RINGING" : "OK";
  logger.debug("Invite seems ok, we'll say " + statusCodeString + ".");
  Response response=null;
  try {
    response=protocolProvider.getMessageFactory().createResponse(statusCode,invite);
    protocolProvider.attachToTag(response,dialog);
    response.setHeader(protocolProvider.getSipCommUserAgentHeader());
    ((ToHeader)response.getHeader(ToHeader.NAME)).getAddress().setDisplayName(protocolProvider.getOurDisplayName());
    Address callerAddress=((FromHeader)response.getHeader(FromHeader.NAME)).getAddress();
    response.addHeader(protocolProvider.getContactHeader(callerAddress));
    if (statusCode != Response.RINGING) {
      try {
        processInviteSendingResponse(callParticipant,response);
      }
 catch (      OperationFailedException ex) {
        logger.error("Error while trying to send a request",ex);
        callParticipant.setState(CallParticipantState.FAILED,"Internal Error: " + ex.getMessage());
        return;
      }
    }
  }
 catch (  ParseException ex) {
    logger.error("Error while trying to send a request",ex);
    callParticipant.setState(CallParticipantState.FAILED,"Internal Error: " + ex.getMessage());
    return;
  }
  try {
    logger.trace("will send " + statusCodeString + " response: ");
    serverTransaction.sendResponse(response);
    logger.debug("sent a " + statusCodeString + " response: "+ response);
  }
 catch (  Exception ex) {
    logger.error("Error while trying to send a request",ex);
    callParticipant.setState(CallParticipantState.FAILED,"Internal Error: " + ex.getMessage());
    return;
  }
  if (statusCode != Response.RINGING) {
    try {
      processInviteSentResponse(callParticipant,response);
    }
 catch (    OperationFailedException ex) {
      logger.error("Error after sending a request",ex);
    }
  }
}
