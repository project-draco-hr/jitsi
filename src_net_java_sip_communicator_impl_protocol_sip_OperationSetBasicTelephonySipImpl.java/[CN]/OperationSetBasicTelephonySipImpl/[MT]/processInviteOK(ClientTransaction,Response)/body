{
  Dialog dialog=clientTransaction.getDialog();
  CallPeerSipImpl callPeer=activeCallsRepository.findCallPeer(dialog);
  if (callPeer == null) {
    callPeer=activeCallsRepository.findCallPeer(clientTransaction.getBranchId(),ok.getHeader(CallIdHeader.NAME));
    if (callPeer == null) {
      logger.debug("Received a stray ok response.");
      return;
    }
    callPeer.setDialog(dialog);
  }
  Request ack=null;
  ContentTypeHeader contentTypeHeader=null;
  try {
    CSeqHeader cseq=((CSeqHeader)ok.getHeader(CSeqHeader.NAME));
    ack=clientTransaction.getDialog().createAck(cseq.getSeqNumber());
    contentTypeHeader=protocolProvider.getHeaderFactory().createContentTypeHeader("application","sdp");
  }
 catch (  ParseException ex) {
    logErrorAndFailCallPeer("Failed to create a content type header for the ACK request",ex,callPeer);
    return;
  }
catch (  InvalidArgumentException ex) {
    logErrorAndFailCallPeer("Failed ACK request, problem with the supplied cseq",ex,callPeer);
    return;
  }
catch (  SipException ex) {
    logErrorAndFailCallPeer("Failed to create ACK request!",ex,callPeer);
    return;
  }
  if (!CallPeerState.CONNECTING_WITH_EARLY_MEDIA.equals(callPeer.getState()))   callPeer.setSdpDescription(new String(ok.getRawContent()));
  CallSession callSession=((CallSipImpl)callPeer.getCall()).getMediaCallSession();
  try {
    try {
      if (callSession == null) {
        callSession=SipActivator.getMediaService().createCallSession(callPeer.getCall());
        callSession.setSessionCreatorCallback(callPeer);
        String sdp=callSession.processSdpOffer(callPeer,callPeer.getSdpDescription());
        ack.setContent(sdp,contentTypeHeader);
        callPeer.setCallInfoURL(callSession.getCallInfoURL());
      }
    }
  finally {
      try {
        clientTransaction.getDialog().sendAck(ack);
      }
 catch (      SipException ex) {
        logErrorAndFailCallPeer("Failed to acknowledge call!",ex,callPeer);
        return;
      }
    }
    CallPeerState callPeerState=callPeer.getState();
    if (!CallPeerState.CONNECTING_WITH_EARLY_MEDIA.equals(callPeerState)) {
      callSession.processSdpAnswer(callPeer,callPeer.getSdpDescription());
    }
    callPeer.setCallInfoURL(callSession.getCallInfoURL());
  }
 catch (  Exception exc) {
    logger.error("There was an error parsing the SDP description of " + callPeer.getDisplayName() + "("+ callPeer.getAddress()+ ")",exc);
    try {
      callPeer.setState(CallPeerState.CONNECTED);
      hangupCallPeer(callPeer);
    }
 catch (    Exception e) {
      logger.error(e);
      callPeer.setState(CallPeerState.FAILED,e.getMessage());
    }
    return;
  }
  if (!CallPeerState.isOnHold(callPeer.getState()))   callPeer.setState(CallPeerState.CONNECTED);
}
