{
  new Thread(){
    @Override public void run(){
      AccountManager accountManager=GuiActivator.getAccountManager();
      for (      AccountID accountID : accountManager.getStoredAccounts()) {
        if (accountManager.isAccountLoaded(accountID)) {
          ProtocolProviderService protocolProvider=AccountUtils.getRegisteredProviderForAccount(accountID);
          if (protocolProvider != null && protocolProvider.isRegistered()) {
            OperationSetAvatar opSetAvatar=protocolProvider.getOperationSet(OperationSetAvatar.class);
            if (opSetAvatar != null) {
              byte[] imageByte=null;
              if (image != null) {
                imageByte=ImageUtils.toByteArray(image);
              }
              try {
                opSetAvatar.setAvatar(imageByte);
              }
 catch (              Throwable t) {
                logger.error("Error setting image",t);
              }
            }
          }
        }
      }
    }
  }
.start();
}
