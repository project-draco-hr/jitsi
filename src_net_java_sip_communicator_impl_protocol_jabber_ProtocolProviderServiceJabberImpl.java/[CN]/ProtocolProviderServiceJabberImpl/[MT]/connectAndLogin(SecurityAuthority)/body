{
synchronized (initializationLock) {
    String password=JabberActivator.getProtocolProviderFactory().loadPassword(getAccountID());
    if (password == null) {
      UserCredentials credentials=new UserCredentials();
      credentials.setUserName(getAccountID().getUserID());
      credentials=authority.obtainCredentials(ProtocolNames.JABBER,credentials);
      char[] pass=credentials.getPassword();
      if (pass == null) {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_USER_REQUEST,"");
        return;
      }
      password=new String(pass);
      if (credentials.isPasswordPersistent()) {
        JabberActivator.getProtocolProviderFactory().storePassword(getAccountID(),password);
      }
    }
    try {
      String userID=StringUtils.parseName(getAccountID().getUserID());
      String serviceName=StringUtils.parseServer(getAccountID().getUserID());
      String serverAddress=(String)getAccountID().getAccountProperties().get(ProtocolProviderFactory.SERVER_ADDRESS);
      String serverPort=(String)getAccountID().getAccountProperties().get(ProtocolProviderFactory.SERVER_PORT);
      try {
        String hosts[]=NetworkUtils.getSRVRecords("_xmpp-client._tcp." + serviceName);
        if (hosts != null && hosts.length > 0) {
          logger.trace("Will set server address from SRV records " + hosts[0]);
          serverAddress=hosts[0];
        }
      }
 catch (      ParseException ex1) {
        logger.error("Domain not resolved " + ex1.getMessage());
      }
      Roster.setDefaultSubscriptionMode(Roster.SUBSCRIPTION_MANUAL);
      try {
        connection=new XMPPConnection(serverAddress,Integer.parseInt(serverPort),serviceName);
      }
 catch (      XMPPException exc) {
        logger.error("Failed to establish a Jabber connection for " + getAccountID().getAccountUniqueID(),exc);
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.CONNECTION_FAILED,OperationFailedException.NETWORK_FAILURE,null);
        throw new OperationFailedException("Failed to establish a Jabber connection for " + getAccountID().getAccountUniqueID(),OperationFailedException.NETWORK_FAILURE,exc);
      }
      connection.addConnectionListener(new JabberConnectionListener());
      fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERING,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      connection.login(userID,password,"sip-comm");
      if (connection.isAuthenticated()) {
        this.reconnecting=false;
        connection.getRoster().setSubscriptionMode(Roster.SUBSCRIPTION_MANUAL);
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      }
 else {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      }
    }
 catch (    NumberFormatException ex) {
      throw new OperationFailedException("Wrong port",OperationFailedException.INVALID_ACCOUNT_PROPERTIES,ex);
    }
  }
}
