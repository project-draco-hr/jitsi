{
synchronized (connectAndLoginLock) {
    inConnectAndLogin=true;
  }
synchronized (initializationLock) {
    String password=JabberActivator.getProtocolProviderFactory().loadPassword(getAccountID());
    if (password == null) {
      UserCredentials credentials=new UserCredentials();
      credentials.setUserName(getAccountID().getUserID());
      credentials=authority.obtainCredentials(ProtocolNames.JABBER,credentials,reasonCode);
      if (credentials == null) {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_USER_REQUEST,"");
        return;
      }
      char[] pass=credentials.getPassword();
      if (pass == null) {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_USER_REQUEST,"");
        return;
      }
      password=new String(pass);
      if (credentials.isPasswordPersistent()) {
        JabberActivator.getProtocolProviderFactory().storePassword(getAccountID(),password);
      }
    }
    try {
      String userID=null;
      if (getAccountID().getProtocolDisplayName().equals("Google Talk")) {
        userID=getAccountID().getUserID();
      }
 else {
        userID=StringUtils.parseName(getAccountID().getUserID());
      }
      String serviceName=StringUtils.parseServer(getAccountID().getUserID());
      String serverAddress=getAccountID().getAccountPropertyString(ProtocolProviderFactory.SERVER_ADDRESS);
      String serverPort=getAccountID().getAccountPropertyString(ProtocolProviderFactory.SERVER_PORT);
      String accountResource=getAccountID().getAccountPropertyString(ProtocolProviderFactory.RESOURCE);
      try {
        InetSocketAddress srvAddress=NetworkUtils.getSRVRecord("xmpp-client","tcp",serviceName);
        if (srvAddress != null)         serverAddress=srvAddress.getHostName();
      }
 catch (      ParseException ex1) {
        logger.error("Domain not resolved " + ex1.getMessage());
      }
      Roster.setDefaultSubscriptionMode(Roster.SubscriptionMode.manual);
      proxy=null;
      String globalProxyType=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_TYPE_PROPERTY_NAME);
      if (globalProxyType == null || globalProxyType.equals(ProxyInfo.ProxyType.NONE.name())) {
        proxy=org.jivesoftware.smack.proxy.ProxyInfo.forNoProxy();
      }
 else {
        String globalProxyAddress=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_ADDRESS_PROPERTY_NAME);
        String globalProxyPortStr=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_PORT_PROPERTY_NAME);
        int globalProxyPort;
        try {
          globalProxyPort=Integer.parseInt(globalProxyPortStr);
        }
 catch (        NumberFormatException ex) {
          throw new OperationFailedException("Wrong port",OperationFailedException.INVALID_ACCOUNT_PROPERTIES,ex);
        }
        String globalProxyUsername=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_USERNAME_PROPERTY_NAME);
        String globalProxyPassword=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_PASSWORD_PROPERTY_NAME);
        if (globalProxyAddress == null || globalProxyAddress.length() <= 0) {
          throw new OperationFailedException("Missing Proxy Address",OperationFailedException.INVALID_ACCOUNT_PROPERTIES);
        }
        if (globalProxyType.equals(ProxyInfo.ProxyType.HTTP.name())) {
          proxy=org.jivesoftware.smack.proxy.ProxyInfo.forHttpProxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
        }
 else         if (globalProxyType.equals(ProxyInfo.ProxyType.SOCKS4.name())) {
          proxy=org.jivesoftware.smack.proxy.ProxyInfo.forSocks4Proxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
        }
 else         if (globalProxyType.equals(ProxyInfo.ProxyType.SOCKS5.name())) {
          proxy=org.jivesoftware.smack.proxy.ProxyInfo.forSocks5Proxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
        }
      }
      ConnectionConfiguration confConn=new ConnectionConfiguration(serverAddress,Integer.parseInt(serverPort),serviceName,proxy);
      confConn.setReconnectionAllowed(false);
      if (connection != null) {
        logger.error("Connection is not null and isConnected:" + connection.isConnected(),new Exception("Trace possible duplicate connections"));
      }
      connection=new XMPPConnection(confConn);
      try {
        CertificateVerificationService gvs=getCertificateVerificationService();
        if (gvs != null)         connection.setCustomTrustManager(new HostTrustManager(gvs.getTrustManager(serverAddress,Integer.parseInt(serverPort))));
      }
 catch (      GeneralSecurityException e) {
        logger.error("Error creating custom trust manager",e);
      }
      connection.connect();
      registerServiceDiscoveryManager();
      if (connectionListener == null)       connectionListener=new JabberConnectionListener();
      connection.addConnectionListener(connectionListener);
      if (abortConnecting) {
        abortConnecting=false;
        disconnectAndCleanConnection();
        return;
      }
      fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERING,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      if (accountResource == null || accountResource.equals(""))       accountResource="sip-comm";
      SASLAuthentication.supportSASLMechanism("PLAIN",0);
      SASLAuthentication.unregisterSASLMechanism("DIGEST-MD5");
      SASLAuthentication.registerSASLMechanism("DIGEST-MD5",SASLDigestMD5Mechanism.class);
      SASLAuthentication.supportSASLMechanism("DIGEST-MD5");
      try {
        connection.login(userID,password,accountResource);
      }
 catch (      XMPPException e1) {
        try {
          try {
            connection.disconnect();
          }
 catch (          Exception e) {
          }
          connection.connect();
          connection.addConnectionListener(connectionListener);
          if (abortConnecting) {
            abortConnecting=false;
            disconnectAndCleanConnection();
            return;
          }
          fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERING,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
          connection.login(userID + "@" + serviceName,password,accountResource);
        }
 catch (        XMPPException e2) {
          throw e1;
        }
      }
      if (connection.isAuthenticated()) {
        connection.getRoster().setSubscriptionMode(Roster.SubscriptionMode.manual);
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      }
 else {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
        disconnectAndCleanConnection();
      }
    }
 catch (    NumberFormatException ex) {
      throw new OperationFailedException("Wrong port",OperationFailedException.INVALID_ACCOUNT_PROPERTIES,ex);
    }
  }
synchronized (connectAndLoginLock) {
    if (eventDuringLogin != null) {
      fireRegistrationStateChanged(eventDuringLogin.getOldState(),eventDuringLogin.getNewState(),eventDuringLogin.getReasonCode(),eventDuringLogin.getReason());
      eventDuringLogin=null;
      inConnectAndLogin=false;
      return;
    }
    inConnectAndLogin=false;
  }
}
