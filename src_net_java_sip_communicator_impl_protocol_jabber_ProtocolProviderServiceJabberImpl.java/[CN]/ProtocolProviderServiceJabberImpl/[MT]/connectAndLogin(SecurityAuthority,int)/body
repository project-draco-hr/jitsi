{
synchronized (initializationLock) {
    String serviceName=StringUtils.parseServer(getAccountID().getUserID());
    String password=loadPassword(authority,reasonCode);
    if (password == null)     return;
    loadResource();
    loadProxy();
    Roster.setDefaultSubscriptionMode(Roster.SubscriptionMode.manual);
    ConnectState state;
    boolean isServerOverriden=getAccountID().getAccountPropertyBoolean(ProtocolProviderFactory.IS_SERVER_OVERRIDDEN,false);
    if (!isServerOverriden) {
      state=connectUsingSRVRecords(serviceName,password,serviceName);
      if (state == ConnectState.ABORT_CONNECTING || state == ConnectState.STOP_TRYING)       return;
    }
    String customXMPPDomain=getAccountID().getAccountPropertyString("CUSTOM_XMPP_DOMAIN");
    if (customXMPPDomain != null) {
      state=connectUsingSRVRecords(customXMPPDomain,password,serviceName);
      if (state == ConnectState.ABORT_CONNECTING || state == ConnectState.STOP_TRYING)       return;
    }
    String serverAddressUserSetting=getAccountID().getAccountPropertyString(ProtocolProviderFactory.SERVER_ADDRESS);
    int serverPort=getAccountID().getAccountPropertyInt(ProtocolProviderFactory.SERVER_PORT,5222);
    InetSocketAddress[] addrs=null;
    try {
      addrs=NetworkUtils.getAandAAAARecords(serverAddressUserSetting,serverPort);
    }
 catch (    ParseException e) {
      logger.error("Domain not resolved",e);
    }
    if (addrs == null || addrs.length == 0) {
      fireRegistrationStateChanged(getRegistrationState(),RegistrationState.CONNECTION_FAILED,RegistrationStateChangeEvent.REASON_SERVER_NOT_FOUND,"No server addresses found");
    }
    for (    InetSocketAddress isa : addrs) {
      try {
        state=connectAndLogin(isa,password,serviceName);
        if (state == ConnectState.ABORT_CONNECTING || state == ConnectState.STOP_TRYING)         return;
      }
 catch (      XMPPException ex) {
        disconnectAndCleanConnection();
        if (isAuthenticationFailed(ex))         throw ex;
      }
    }
  }
}
