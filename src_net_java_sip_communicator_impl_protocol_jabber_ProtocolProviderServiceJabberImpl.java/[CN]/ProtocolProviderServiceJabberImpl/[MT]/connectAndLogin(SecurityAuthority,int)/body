{
synchronized (initializationLock) {
    String password=JabberActivator.getProtocolProviderFactory().loadPassword(getAccountID());
    if (password == null) {
      UserCredentials credentials=new UserCredentials();
      credentials.setUserName(getAccountID().getUserID());
      credentials=authority.obtainCredentials(ProtocolNames.JABBER,credentials,reasonCode);
      if (credentials == null) {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_USER_REQUEST,"");
        return;
      }
      char[] pass=credentials.getPassword();
      if (pass == null) {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_USER_REQUEST,"");
        return;
      }
      password=new String(pass);
      if (credentials.isPasswordPersistent()) {
        JabberActivator.getProtocolProviderFactory().storePassword(getAccountID(),password);
      }
    }
    try {
      String userID=StringUtils.parseName(getAccountID().getUserID());
      String serviceName=StringUtils.parseServer(getAccountID().getUserID());
      String serverAddress=getAccountID().getAccountPropertyString(ProtocolProviderFactory.SERVER_ADDRESS);
      String serverPort=getAccountID().getAccountPropertyString(ProtocolProviderFactory.SERVER_PORT);
      String accountResource=getAccountID().getAccountPropertyString(ProtocolProviderFactory.RESOURCE);
      try {
        InetSocketAddress srvAddress=NetworkUtils.getSRVRecord("xmpp-client","tcp",serviceName);
        if (srvAddress != null)         serverAddress=srvAddress.getHostName();
      }
 catch (      ParseException ex1) {
        logger.error("Domain not resolved " + ex1.getMessage());
      }
      Roster.setDefaultSubscriptionMode(Roster.SubscriptionMode.manual);
      try {
        org.jivesoftware.smack.proxy.ProxyInfo proxy=null;
        String globalProxyType=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_TYPE_PROPERTY_NAME);
        if (globalProxyType == null || globalProxyType.equals(ProxyInfo.ProxyType.NONE.name())) {
          proxy=org.jivesoftware.smack.proxy.ProxyInfo.forNoProxy();
        }
 else {
          String globalProxyAddress=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_ADDRESS_PROPERTY_NAME);
          String globalProxyPortStr=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_PORT_PROPERTY_NAME);
          int globalProxyPort;
          try {
            globalProxyPort=Integer.parseInt(globalProxyPortStr);
          }
 catch (          NumberFormatException ex) {
            throw new OperationFailedException("Wrong port",OperationFailedException.INVALID_ACCOUNT_PROPERTIES,ex);
          }
          String globalProxyUsername=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_USERNAME_PROPERTY_NAME);
          String globalProxyPassword=JabberActivator.getConfigurationService().getString(ProxyInfo.CONNECTON_PROXY_PASSWORD_PROPERTY_NAME);
          if (globalProxyAddress == null || globalProxyAddress.length() <= 0) {
            throw new OperationFailedException("Missing Proxy Address",OperationFailedException.INVALID_ACCOUNT_PROPERTIES);
          }
          if (globalProxyType.equals(ProxyInfo.ProxyType.HTTP.name())) {
            proxy=org.jivesoftware.smack.proxy.ProxyInfo.forHttpProxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
          }
 else           if (globalProxyType.equals(ProxyInfo.ProxyType.SOCKS4.name())) {
            proxy=org.jivesoftware.smack.proxy.ProxyInfo.forSocks4Proxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
          }
 else           if (globalProxyType.equals(ProxyInfo.ProxyType.SOCKS5.name())) {
            proxy=org.jivesoftware.smack.proxy.ProxyInfo.forSocks5Proxy(globalProxyAddress,globalProxyPort,globalProxyUsername,globalProxyPassword);
          }
        }
        ConnectionConfiguration confConn=new ConnectionConfiguration(serverAddress,Integer.parseInt(serverPort),serviceName,proxy);
        confConn.setReconnectionAllowed(false);
        connection=new XMPPConnection(confConn);
        connection.connect();
      }
 catch (      XMPPException exc) {
        if (logger.isInfoEnabled()) {
          logger.info("Failed to establish a Jabber connection for " + getAccountID().getAccountUniqueID(),exc);
        }
        throw new OperationFailedException("Failed to establish a Jabber connection for " + getAccountID().getAccountUniqueID(),OperationFailedException.NETWORK_FAILURE,exc);
      }
      connection.addConnectionListener(new JabberConnectionListener());
      fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERING,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      if (accountResource == null || accountResource.equals(""))       accountResource="sip-comm";
      SASLAuthentication.supportSASLMechanism("PLAIN",0);
      SASLAuthentication.unregisterSASLMechanism("DIGEST-MD5");
      SASLAuthentication.registerSASLMechanism("DIGEST-MD5",SASLDigestMD5Mechanism.class);
      SASLAuthentication.supportSASLMechanism("DIGEST-MD5");
      try {
        connection.login(userID,password,accountResource);
      }
 catch (      XMPPException e1) {
        try {
          try {
            connection.disconnect();
          }
 catch (          Exception e) {
          }
          connection.connect();
          connection.addConnectionListener(new JabberConnectionListener());
          connection.login(userID + "@" + serviceName,password,accountResource);
        }
 catch (        XMPPException e2) {
          throw e1;
        }
      }
      if (connection.isAuthenticated()) {
        this.reconnecting=false;
        connection.getRoster().setSubscriptionMode(Roster.SubscriptionMode.manual);
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.REGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      }
 else {
        fireRegistrationStateChanged(getRegistrationState(),RegistrationState.UNREGISTERED,RegistrationStateChangeEvent.REASON_NOT_SPECIFIED,null);
      }
    }
 catch (    NumberFormatException ex) {
      throw new OperationFailedException("Wrong port",OperationFailedException.INVALID_ACCOUNT_PROPERTIES,ex);
    }
  }
  if (getRegistrationState() == RegistrationState.REGISTERED) {
    discoveryManager=ServiceDiscoveryManager.getInstanceFor(connection);
    ServiceDiscoveryManager.setIdentityName("sip-comm");
    ServiceDiscoveryManager.setIdentityType("pc");
    Iterator<String> it=supportedFeatures.iterator();
    discoveryManager.removeFeature("http://jabber.org/protocol/commands");
    while (it.hasNext()) {
      String feature=it.next();
      if (!discoveryManager.includesFeature(feature))       discoveryManager.addFeature(feature);
    }
  }
}
