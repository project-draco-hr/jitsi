{
  String name=System.getProperty("sip-communicator.application.name","SIP Communicator ") + System.getProperty("sip-communicator.version","SVN");
  ServiceDiscoveryManager.setIdentityName(name);
  ServiceDiscoveryManager.setIdentityType("pc");
  discoveryManager=new ScServiceDiscoveryManager(this,connection,new String[]{"http://jabber.org/protocol/commands"},supportedFeatures.toArray(new String[supportedFeatures.size()]));
  boolean isCallingDisabled=JabberActivator.getConfigurationService().getBoolean(IS_CALLING_DISABLED,false);
  boolean isCallingDisabledForAccount=false;
  if (accountID != null && accountID.getAccountPropertyBoolean(ProtocolProviderFactory.IS_CALLING_DISABLED_FOR_ACCOUNT,false))   isCallingDisabled=true;
  if (isGTalkTesting() && !isCallingDisabled && !isCallingDisabledForAccount) {
    discoveryManager.addExtFeature(CAPS_GTALK_WEB_VOICE);
    discoveryManager.addExtFeature(CAPS_GTALK_WEB_VIDEO);
    discoveryManager.addExtFeature(CAPS_GTALK_WEB_CAMERA);
    discoveryManager.addFeature(URN_GOOGLE_VOICE);
    discoveryManager.addFeature(URN_GOOGLE_VIDEO);
    discoveryManager.addFeature(URN_GOOGLE_CAMERA);
  }
  if (opsetContactCapabilities != null)   opsetContactCapabilities.setDiscoveryManager(discoveryManager);
}
