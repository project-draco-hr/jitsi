{
  try {
    final CallPeer peer=ev.getSourceCallPeer();
    Call call=peer.getCall();
    CallPeerState newState=(CallPeerState)ev.getNewValue();
    CallPeerState oldState=(CallPeerState)ev.getOldValue();
    if ((newState == CallPeerState.INITIATING_CALL) || (newState == CallPeerState.CONNECTING)) {
      NotificationData notification=fireNotification(DIALING,new Callable<Boolean>(){
        public Boolean call(){
          CallPeerState state=peer.getState();
          return CallPeerState.INITIATING_CALL.equals(state) || CallPeerState.CONNECTING.equals(state);
        }
      }
);
      if (notification != null)       callNotifications.put(call,notification);
    }
 else {
      stopSound(callNotifications.get(call));
    }
    if (newState == CallPeerState.ALERTING_REMOTE_SIDE && oldState != CallPeerState.CONNECTING_WITH_EARLY_MEDIA) {
      NotificationData notification=fireNotification(OUTGOING_CALL,new Callable<Boolean>(){
        public Boolean call(){
          return CallPeerState.ALERTING_REMOTE_SIDE.equals(peer.getState());
        }
      }
);
      if (notification != null)       callNotifications.put(call,notification);
    }
 else     if (newState == CallPeerState.BUSY) {
      if (!isConference(call)) {
        NotificationData notification=fireNotification(BUSY_CALL,new Callable<Boolean>(){
          public Boolean call(){
            return CallPeerState.BUSY.equals(peer.getState());
          }
        }
);
        if (notification != null)         callNotifications.put(call,notification);
      }
    }
 else     if ((newState == CallPeerState.DISCONNECTED) || (newState == CallPeerState.FAILED)) {
      fireNotification(HANG_UP);
    }
  }
 catch (  Throwable t) {
    logger.error("Error notifying after peer state changed",t);
  }
}
