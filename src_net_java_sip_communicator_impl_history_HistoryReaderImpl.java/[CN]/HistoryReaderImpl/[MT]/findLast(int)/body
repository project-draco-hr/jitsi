{
  Vector<String> filelist=filterFilesByDate(this.historyImpl.getFileList(),null,null);
  TreeSet<HistoryRecord> result=new TreeSet<HistoryRecord>(new HistoryRecordComparator());
  int leftCount=count;
  int currentFile=filelist.size() - 1;
  while (leftCount > 0 && currentFile >= 0) {
    Document doc=this.historyImpl.getDocumentForFile(filelist.get(currentFile));
    if (doc == null) {
      currentFile--;
      continue;
    }
    List<Node> nodes=new ArrayList<Node>();
    NodeList nodesList=doc.getElementsByTagName("record");
    for (int i=0; i < nodesList.getLength(); i++) {
      nodes.add(nodesList.item(i));
    }
    List<Node> lNodes=null;
    if (nodes.size() > leftCount) {
      lNodes=nodes.subList(nodes.size() - leftCount,nodes.size());
      leftCount=0;
    }
 else {
      lNodes=nodes;
      leftCount-=nodes.size();
    }
    Iterator<Node> i=lNodes.iterator();
    while (i.hasNext()) {
      Node node=i.next();
      NodeList propertyNodes=node.getChildNodes();
      String ts=node.getAttributes().getNamedItem("timestamp").getNodeValue();
      long timestamp=Long.parseLong(ts);
      ArrayList<String> nameVals=new ArrayList<String>();
      boolean isRecordOK=true;
      int len=propertyNodes.getLength();
      for (int j=0; j < len; j++) {
        Node propertyNode=propertyNodes.item(j);
        if (propertyNode.getNodeType() == Node.ELEMENT_NODE) {
          Node nodeValue=propertyNode.getFirstChild();
          if (nodeValue != null) {
            nameVals.add(propertyNode.getNodeName());
            nameVals.add(nodeValue.getNodeValue());
          }
 else           isRecordOK=false;
        }
      }
      if (!isRecordOK)       continue;
      String[] propertyNames=new String[nameVals.size() / 2];
      String[] propertyValues=new String[propertyNames.length];
      for (int j=0; j < propertyNames.length; j++) {
        propertyNames[j]=nameVals.get(j * 2);
        propertyValues[j]=nameVals.get(j * 2 + 1);
      }
      HistoryRecord record=new HistoryRecord(propertyNames,propertyValues,timestamp);
      result.add(record);
    }
    currentFile--;
  }
  return new OrderedQueryResultSet<HistoryRecord>(result);
}
