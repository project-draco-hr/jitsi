{
  Presence presence=(Presence)packet;
  if (presence == null || presence.getError() != null)   return;
  MUCUser mucUser=getMUCUserExtension(packet);
  if (mucUser != null) {
    String affiliation=mucUser.getItem().getAffiliation();
    String role=mucUser.getItem().getRole();
    if (mucUser.getStatus() != null && "201".equals(mucUser.getStatus().getCode())) {
      try {
        multiUserChat.sendConfigurationForm(new Form(Form.TYPE_SUBMIT));
      }
 catch (      XMPPException e) {
        logger.error("Failed to send config form.",e);
      }
      opSetMuc.addSmackInvitationRejectionListener(multiUserChat,chatRoom);
      if (affiliation.equalsIgnoreCase(ChatRoomMemberRole.OWNER.getRoleName().toLowerCase())) {
        setLocalUserRole(ChatRoomMemberRole.OWNER);
      }
 else       setLocalUserRole(ChatRoomMemberRole.MODERATOR);
    }
 else {
      if (role != null && role.equalsIgnoreCase(ChatRoomMemberRole.MODERATOR.getRoleName().toLowerCase())) {
        setLocalUserRole(ChatRoomMemberRole.MODERATOR);
      }
      if (affiliation != null) {
        if (affiliation.equalsIgnoreCase(ChatRoomMemberRole.OWNER.getRoleName().toLowerCase())) {
          setLocalUserRole(ChatRoomMemberRole.OWNER);
        }
 else         if (affiliation.equalsIgnoreCase("admin")) {
          setLocalUserRole(ChatRoomMemberRole.ADMINISTRATOR);
        }
      }
    }
    provider.getConnection().removePacketListener(this);
  }
}
