{
  if (!(packet instanceof org.jivesoftware.smack.packet.Message))   return;
  org.jivesoftware.smack.packet.Message msg=(org.jivesoftware.smack.packet.Message)packet;
  String msgBody=msg.getBody();
  if (msgBody == null)   return;
  int messageReceivedEventType=ChatRoomMessageReceivedEvent.CONVERSATION_MESSAGE_RECEIVED;
  String msgFrom=msg.getFrom();
  ChatRoomMember member=null;
  String fromUserName=StringUtils.parseResource(msgFrom);
  if (nickname.equals(getNickName(fromUserName)))   return;
  if (msgFrom.equals(getName())) {
    messageReceivedEventType=ChatRoomMessageReceivedEvent.SYSTEM_MESSAGE_RECEIVED;
    member=new ChatRoomMemberJabberImpl(ChatRoomJabberImpl.this,getName(),getName(),null);
  }
 else {
    member=smackParticipantToScMember(msgFrom);
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Received from " + fromUserName + " the message "+ msg.toXML());
  }
  Message newMessage=createMessage(msgBody);
  if (msg.getType() == org.jivesoftware.smack.packet.Message.Type.error) {
    logger.info("Message error received from " + fromUserName);
    int errorCode=packet.getError().getCode();
    int errorResultCode=ChatRoomMessageDeliveryFailedEvent.UNKNOWN_ERROR;
    if (errorCode == 503) {
      org.jivesoftware.smackx.packet.MessageEvent msgEvent=(org.jivesoftware.smackx.packet.MessageEvent)packet.getExtension("x","jabber:x:event");
      if (msgEvent != null && msgEvent.isOffline()) {
        errorResultCode=ChatRoomMessageDeliveryFailedEvent.OFFLINE_MESSAGES_NOT_SUPPORTED;
      }
    }
    ChatRoomMessageDeliveryFailedEvent evt=new ChatRoomMessageDeliveryFailedEvent(ChatRoomJabberImpl.this,member,errorResultCode,new Date(),newMessage);
    fireMessageEvent(evt);
    return;
  }
  ChatRoomMessageReceivedEvent msgReceivedEvt=new ChatRoomMessageReceivedEvent(ChatRoomJabberImpl.this,member,System.currentTimeMillis(),newMessage,messageReceivedEventType);
  fireMessageEvent(msgReceivedEvt);
}
