{
  if (!this.chatPanel.isWriteAreaEmpty()) {
    OperationSetBasicInstantMessaging im=this.chatPanel.getImOperationSet();
    Message msg=im.createMessage(chatPanel.getTextFromWriteArea());
    this.chatPanel.getChatWindow().getMainFrame().getWaitToBeDeliveredMsgs().put(msg.getMessageUID(),this.chatPanel);
    Contact contact=(Contact)contactSelectorBox.getMenu().getSelectedObject();
    if (chatPanel.getTnOperationSet() != null) {
      chatPanel.stopTypingNotifications();
    }
    chatPanel.requestFocusInWriteArea();
    try {
      im.sendInstantMessage(contact,msg);
    }
 catch (    IllegalStateException ex) {
      chatPanel.refreshWriteArea();
      chatPanel.processMessage(contact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.OUTGOING_MESSAGE,msg.getContent());
      chatPanel.processMessage(contact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.ERROR_MESSAGE,Messages.getI18NString("msgSendConnectionProblem").getText());
    }
  }
}
