{
  if (!(to instanceof ContactSSHImpl))   throw new IllegalArgumentException("The specified contact is not a SSH contact." + to);
  ContactSSH sshContact=(ContactSSH)to;
  if (sshContact.isConnectionInProgress()) {
    deliverMessage(createMessage("A connection attempt is in progress"),(ContactSSHImpl)to);
    return;
  }
  if (!parentProvider.isShellConnected(sshContact)) {
    try {
      parentProvider.connectShell(sshContact,message);
      return;
    }
 catch (    Exception ex) {
      throw new IllegalStateException(ex.getMessage());
    }
  }
  if (wrappedMessage(message.getContent(),sshContact)) {
    fireMessageDelivered(message,to);
    return;
  }
  try {
    sshContact.sendLine(message.getContent());
    sshContact.setCommandSent(true);
  }
 catch (  IOException ex) {
    sshContact.closeShellIO();
    throw new IllegalStateException(ex.getMessage());
  }
  fireMessageDelivered(message,to);
}
