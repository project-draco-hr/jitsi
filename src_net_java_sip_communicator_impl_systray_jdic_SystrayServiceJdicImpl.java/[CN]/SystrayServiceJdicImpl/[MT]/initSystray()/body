{
  popupTimer.scheduleAtFixedRate(new ShowPopupTask(),0,messageDelay);
  menu=new TrayMenu(this);
  String osName=System.getProperty("os.name");
  if (osName.startsWith("Windows")) {
    logoIcon=new ImageIcon(Resources.getImage("trayIconWindows"));
    envelopeIcon=new ImageIcon(Resources.getImage("messageIconWindows"));
  }
 else   if (osName.startsWith("Mac OS X")) {
    logoIcon=new ImageIcon(Resources.getImage("trayIconMacOSX"));
    logoIconWhite=new ImageIcon(Resources.getImage("trayIconMacOSXWhite"));
    envelopeIcon=new ImageIcon(Resources.getImage("messageIconMacOSX"));
  }
 else {
    logoIcon=new ImageIcon(Resources.getImage("trayIcon"));
    envelopeIcon=new ImageIcon(Resources.getImage("messageIcon"));
  }
  trayIcon=new TrayIcon(logoIcon,"SIP Communicator",menu);
  trayIcon.setIconAutoSize(true);
  trayIcon.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      UIService uiService=SystrayActivator.getUIService();
      boolean isVisible;
      isVisible=!uiService.isVisible();
      uiService.setVisible(isVisible);
      ConfigurationService configService=SystrayActivator.getConfigurationService();
      configService.setProperty("net.java.sip.communicator.impl.systray.showApplication",new Boolean(isVisible));
    }
  }
);
  if (osName.startsWith("Mac OS X")) {
    menu.addPopupMenuListener(new PopupMenuListener(){
      public void popupMenuWillBecomeVisible(      PopupMenuEvent e){
        trayIcon.setIcon(logoIconWhite);
      }
      public void popupMenuWillBecomeInvisible(      PopupMenuEvent e){
        trayIcon.setIcon(logoIcon);
      }
      public void popupMenuCanceled(      PopupMenuEvent e){
        trayIcon.setIcon(logoIconWhite);
      }
    }
);
  }
  trayIcon.addBalloonActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      UIService uiService=SystrayActivator.getUIService();
      firePopupMessageEvent(e.getSource());
      ExportedWindow chatWindow=uiService.getExportedWindow(ExportedWindow.CHAT_WINDOW);
      if (chatWindow != null && chatWindow.isVisible()) {
        chatWindow.bringToFront();
      }
    }
  }
);
  systray.addTrayIcon(trayIcon);
}
