{
  popupTimer.scheduleAtFixedRate(new ShowPopupTask(),0,messageDelay);
  Object o=Toolkit.getDefaultToolkit().getDesktopProperty("awt.multiClickInterval");
  final int doubleClickSpeed=(o instanceof Integer ? ((Integer)o).intValue() : 500);
  menu=new TrayMenu(this);
  String osName=System.getProperty("os.name");
  if (osName.startsWith("Windows")) {
    logoIcon=Resources.getImage("trayIconWindows");
    logoIconOffline=Resources.getImage("trayIconWindowsOffline");
    logoIconAway=Resources.getImage("trayIconWindowsAway");
    logoIconFFC=Resources.getImage("trayIconWindowsFFC");
    envelopeIcon=Resources.getImage("messageIconWindows");
  }
 else   if (osName.startsWith("Mac OS X")) {
    logoIcon=Resources.getImage("trayIconMacOSX");
    logoIconWhite=Resources.getImage("trayIconMacOSXWhite");
    envelopeIcon=Resources.getImage("messageIconMacOSX");
    envelopeIconWhite=Resources.getImage("messageIconMacOSXWhite");
  }
 else {
    logoIcon=Resources.getImage("trayIcon");
    logoIconOffline=Resources.getImage("trayIconOffline");
    logoIconAway=Resources.getImage("trayIconAway");
    logoIconFFC=Resources.getImage("trayIconFFC");
    envelopeIcon=Resources.getImage("messageIcon");
  }
  if (!osName.startsWith("Mac OS X")) {
    currentIcon=logoIconOffline;
  }
 else   currentIcon=logoIcon;
  trayIcon=new TrayIcon(currentIcon,Resources.getApplicationString("applicationName"),menu);
  trayIcon.setIconAutoSize(true);
  trayIcon.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      long currentTime=System.currentTimeMillis();
      UIService uiService=SystrayActivator.getUIService();
      boolean isVisible;
      isVisible=!uiService.isVisible();
      if (isVisible) {
        setVisibleTime=currentTime;
      }
 else       if (currentTime < (setVisibleTime + doubleClickSpeed)) {
        return;
      }
      uiService.setVisible(isVisible);
      ConfigurationService configService=SystrayActivator.getConfigurationService();
      configService.setProperty("net.java.sip.communicator.impl.systray.showApplication",Boolean.toString(isVisible));
    }
  }
);
  if (osName.startsWith("Mac OS X")) {
    menu.addPopupMenuListener(new PopupMenuListener(){
      public void popupMenuWillBecomeVisible(      PopupMenuEvent e){
        if (currentIcon == envelopeIcon) {
          trayIcon.setIcon(envelopeIconWhite);
          currentIcon=envelopeIconWhite;
        }
 else {
          trayIcon.setIcon(logoIconWhite);
          currentIcon=logoIconWhite;
        }
      }
      public void popupMenuWillBecomeInvisible(      PopupMenuEvent e){
        if (currentIcon == envelopeIconWhite) {
          trayIcon.setIcon(envelopeIcon);
          currentIcon=envelopeIcon;
        }
 else {
          trayIcon.setIcon(logoIcon);
          currentIcon=logoIcon;
        }
      }
      public void popupMenuCanceled(      PopupMenuEvent e){
        popupMenuWillBecomeInvisible(e);
      }
    }
);
  }
  trayIcon.addBalloonActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      UIService uiService=SystrayActivator.getUIService();
      firePopupMessageEvent(e.getSource());
      ExportedWindow chatWindow=uiService.getExportedWindow(ExportedWindow.CHAT_WINDOW);
      if (chatWindow != null && chatWindow.isVisible()) {
        chatWindow.bringToFront();
      }
    }
  }
);
  systray.addTrayIcon(trayIcon);
  initialized=true;
}
