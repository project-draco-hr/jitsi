{
  String errorMsg=null;
  Message sourceMessage=(Message)evt.getSource();
  Contact sourceContact=evt.getDestinationContact();
  MetaContact metaContact=mainFrame.getContactList().findMetaContactByContact(sourceContact);
  PresenceStatus contactStatus=((ContactListModel)this.contactList.getModel()).getMetaContactStatus(metaContact);
  if (evt.getErrorCode() == MessageDeliveryFailedEvent.OFFLINE_MESSAGES_NOT_SUPPORTED) {
    errorMsg=Messages.getI18NString("msgDeliveryOfflineNotSupported").getText();
  }
 else   if (evt.getErrorCode() == MessageDeliveryFailedEvent.NETWORK_FAILURE) {
    errorMsg=Messages.getI18NString("msgNotDelivered").getText();
  }
 else   if (evt.getErrorCode() == MessageDeliveryFailedEvent.PROVIDER_NOT_REGISTERED) {
    errorMsg=Messages.getI18NString("msgSendConnectionProblem").getText();
  }
 else   if (evt.getErrorCode() == MessageDeliveryFailedEvent.INTERNAL_ERROR) {
    errorMsg=Messages.getI18NString("msgDeliveryInternalError").getText();
  }
 else {
    errorMsg=Messages.getI18NString("msgDeliveryFailedUnknownError").getText();
  }
  ChatPanel chatPanel;
  ChatWindow chatWindow;
  if (!Constants.TABBED_CHAT_WINDOW) {
    chatPanel=chatWindowManager.getContactChat(metaContact,sourceContact);
    chatWindow=chatPanel.getChatWindow();
    chatPanel.refreshWriteArea();
    chatPanel.processMessage(metaContact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.OUTGOING_MESSAGE,sourceMessage.getContent());
    chatPanel.processMessage(metaContact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.ERROR_MESSAGE,errorMsg);
  }
 else {
    chatPanel=chatWindowManager.getContactChat(metaContact,sourceContact);
    chatWindow=chatPanel.getChatWindow();
    chatPanel.refreshWriteArea();
    chatPanel.processMessage(metaContact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.OUTGOING_MESSAGE,sourceMessage.getContent());
    chatPanel.processMessage(metaContact.getDisplayName(),new Date(System.currentTimeMillis()),Constants.ERROR_MESSAGE,errorMsg);
  }
  chatWindowManager.openChat(chatPanel,false);
}
