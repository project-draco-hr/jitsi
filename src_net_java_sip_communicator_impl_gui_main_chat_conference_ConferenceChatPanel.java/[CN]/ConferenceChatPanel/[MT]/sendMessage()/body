{
  ChatRoom chatRoom=chatRoomWrapper.getChatRoom();
  String msgText=this.getTextFromWriteArea(OperationSetBasicInstantMessaging.DEFAULT_MIME_TYPE);
  Message msg=chatRoom.createMessage(msgText);
  try {
    chatRoom.sendMessage(msg);
  }
 catch (  IllegalStateException ex) {
    logger.error("Failed to send message.",ex);
    this.refreshWriteArea();
    this.processMessage(chatRoom.getName(),new Date(System.currentTimeMillis()),Constants.OUTGOING_MESSAGE,msg.getContent(),msg.getContentType());
    this.processMessage(chatRoom.getName(),new Date(System.currentTimeMillis()),Constants.ERROR_MESSAGE,Messages.getI18NString("msgSendConnectionProblem").getText(),"text");
  }
catch (  Exception ex) {
    logger.error("Failed to send message.",ex);
    this.refreshWriteArea();
    this.processMessage(chatRoom.getName(),new Date(System.currentTimeMillis()),Constants.OUTGOING_MESSAGE,msg.getContent(),msg.getContentType());
    this.processMessage(chatRoom.getName(),new Date(System.currentTimeMillis()),Constants.ERROR_MESSAGE,Messages.getI18NString("msgDeliveryInternalError").getText(),"text");
  }
}
