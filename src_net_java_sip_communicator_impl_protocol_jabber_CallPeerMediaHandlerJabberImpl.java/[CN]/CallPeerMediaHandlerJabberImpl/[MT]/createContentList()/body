{
  List<ContentPacketExtension> mediaDescs=new ArrayList<ContentPacketExtension>();
  for (  MediaType mediaType : MediaType.values()) {
    MediaDevice dev=getDefaultDevice(mediaType);
    if (dev != null) {
      MediaDirection direction=dev.getDirection().and(getDirectionUserPreference(mediaType));
      if (isLocallyOnHold())       direction=direction.and(MediaDirection.SENDONLY);
      if (MediaDirection.RECVONLY.equals(direction))       direction=MediaDirection.INACTIVE;
      if (direction != MediaDirection.INACTIVE) {
        ContentPacketExtension content=createContentForOffer(dev.getSupportedFormats(),direction,dev.getSupportedExtensions());
        if (getPeer().getCall().isSipZrtpAttribute()) {
          Map<MediaTypeSrtpControl,SrtpControl> srtpControls=getSrtpControls();
          MediaTypeSrtpControl key=new MediaTypeSrtpControl(mediaType,SrtpControlType.ZRTP);
          SrtpControl control=srtpControls.get(key);
          if (control == null) {
            control=JabberActivator.getMediaService().createZrtpControl();
            srtpControls.put(key,control);
          }
          String helloHash[]=((ZrtpControl)control).getHelloHashSep();
          if (helloHash != null && helloHash[1].length() > 0) {
            EncryptionPacketExtension encryption=new EncryptionPacketExtension();
            ZrtpHashPacketExtension hash=new ZrtpHashPacketExtension();
            hash.setVersion(helloHash[0]);
            hash.setValue(helloHash[1]);
            encryption.addChildExtension(hash);
            RtpDescriptionPacketExtension description=JingleUtils.getRtpDescription(content);
            description.setEncryption(encryption);
          }
        }
        RtpDescriptionPacketExtension description=JingleUtils.getRtpDescription(content);
        if (description.getMedia().equals(MediaType.VIDEO.toString()) && localInputEvtAware) {
          content.addChildExtension(new InputEvtPacketExtension());
        }
        mediaDescs.add(content);
      }
    }
  }
  if (mediaDescs.isEmpty()) {
    ProtocolProviderServiceJabberImpl.throwOperationFailedException("We couldn't find any active Audio/Video devices" + " and couldn't create a call",OperationFailedException.GENERAL_ERROR,null,logger);
  }
  TransportInfoSender transportInfoSender=getTransportManager().getXmlNamespace().equals(ProtocolProviderServiceJabberImpl.URN_GOOGLE_TRANSPORT_P2P) ? new TransportInfoSender(){
    public void sendTransportInfo(    Iterable<ContentPacketExtension> contents){
      getPeer().sendTransportInfo(contents);
    }
  }
 : null;
  return harvestCandidates(null,mediaDescs,transportInfoSender);
}
