{
  MediaDirection direction=dev.getDirection().and(getDirectionUserPreference(dev.getMediaType()));
  if (isLocallyOnHold())   direction=direction.and(MediaDirection.SENDONLY);
  if (direction != MediaDirection.INACTIVE) {
    ContentPacketExtension content=createContentForOffer(dev.getSupportedFormats(),direction,dev.getSupportedExtensions());
    if (getPeer().getCall().isSipZrtpAttribute()) {
      SrtpControl control=getZrtpControls().get(dev.getMediaType());
      if (control == null || !(control instanceof ZrtpControl)) {
        control=JabberActivator.getMediaService().createZrtpControl();
        getZrtpControls().put(dev.getMediaType(),control);
      }
      String helloHash[]=((ZrtpControl)control).getHelloHashSep();
      if (helloHash != null && helloHash[1].length() > 0) {
        EncryptionPacketExtension encryption=new EncryptionPacketExtension();
        ZrtpHashPacketExtension hash=new ZrtpHashPacketExtension();
        hash.setVersion(helloHash[0]);
        hash.setValue(helloHash[1]);
        encryption.addChildExtension(hash);
        RtpDescriptionPacketExtension description=JingleUtils.getRtpDescription(content);
        description.setEncryption(encryption);
      }
    }
    return content;
  }
  return null;
}
