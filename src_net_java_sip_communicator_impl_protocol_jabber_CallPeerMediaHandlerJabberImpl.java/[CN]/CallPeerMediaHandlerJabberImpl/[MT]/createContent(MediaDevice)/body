{
  MediaDirection direction=dev.getDirection().and(getDirectionUserPreference(dev.getMediaType()));
  if (isLocallyOnHold())   direction=direction.and(MediaDirection.SENDONLY);
  QualityPreset sendQualityPreset=null;
  QualityPreset receiveQualityPreset=null;
  if (qualityControls != null) {
    sendQualityPreset=qualityControls.getRemoteReceivePreset();
    receiveQualityPreset=qualityControls.getRemoteSendMaxPreset();
  }
  if (direction != MediaDirection.INACTIVE) {
    ContentPacketExtension content=createContentForOffer(dev.getSupportedFormats(sendQualityPreset,receiveQualityPreset),direction,dev.getSupportedExtensions());
    if (getPeer().getCall().isSipZrtpAttribute()) {
      MediaTypeSrtpControl key=new MediaTypeSrtpControl(dev.getMediaType(),SrtpControlType.ZRTP);
      SrtpControl control=getSrtpControls().get(key);
      if (control == null) {
        control=JabberActivator.getMediaService().createZrtpControl();
        getSrtpControls().put(key,control);
      }
      String helloHash[]=((ZrtpControl)control).getHelloHashSep();
      if (helloHash != null && helloHash[1].length() > 0) {
        EncryptionPacketExtension encryption=new EncryptionPacketExtension();
        ZrtpHashPacketExtension hash=new ZrtpHashPacketExtension();
        hash.setVersion(helloHash[0]);
        hash.setValue(helloHash[1]);
        encryption.addChildExtension(hash);
        RtpDescriptionPacketExtension description=JingleUtils.getRtpDescription(content);
        description.setEncryption(encryption);
      }
    }
    return content;
  }
  return null;
}
