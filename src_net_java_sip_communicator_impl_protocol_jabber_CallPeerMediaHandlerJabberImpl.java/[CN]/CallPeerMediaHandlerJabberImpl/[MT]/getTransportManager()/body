{
  if (transportManager == null) {
    CallPeerJabberImpl peer=getPeer();
    if (peer.isInitiator()) {
synchronized (transportManagerSyncRoot) {
        try {
          transportManagerSyncRoot.wait(5000);
        }
 catch (        InterruptedException e) {
        }
      }
      if (transportManager == null)       throw new IllegalStateException("The initiator is expected to specify the transport" + " in their offer.");
 else       return transportManager;
    }
 else {
      ProtocolProviderServiceJabberImpl protocolProvider=peer.getProtocolProvider();
      ScServiceDiscoveryManager discoveryManager=protocolProvider.getDiscoveryManager();
      DiscoverInfo peerDiscoverInfo=peer.getDiscoveryInfo();
      boolean isJitsiVideobridge=peer.isJitsiVideobridge();
      boolean google=protocolProvider.isGmailOrGoogleAppsAccount() || ProtocolProviderServiceJabberImpl.isGmailOrGoogleAppsAccount(StringUtils.parseServer(peer.getAddress()));
      if (isJitsiVideobridge)       google=false;
synchronized (supportedTransportsSyncRoot) {
        if (supportedTransports != null && supportedTransports.length > 0) {
          for (int i=0; i < supportedTransports.length; i++) {
            if (ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_ICE_UDP_1.equals(supportedTransports[i])) {
              transportManager=new IceUdpTransportManager(peer);
              break;
            }
 else             if (ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_RAW_UDP_0.equals(supportedTransports[i])) {
              transportManager=new RawUdpTransportManager(peer);
              break;
            }
          }
          if (transportManager == null) {
            logger.warn("Could not find a supported transport" + "manager in supportedTransports. Will try" + "to select one based on disco#info");
          }
        }
      }
      if (transportManager == null && google && isFeatureSupported(discoveryManager,peerDiscoverInfo,ProtocolProviderServiceJabberImpl.URN_GOOGLE_TRANSPORT_P2P)) {
        transportManager=new P2PTransportManager(peer);
      }
 else       if (transportManager == null) {
        String[] transports=new String[]{ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_ICE_UDP_1,ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_RAW_UDP_0};
        if (isJitsiVideobridge) {
          transports=new String[]{ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_RAW_UDP_0};
        }
        for (        String transport : transports) {
          if (isFeatureSupported(discoveryManager,peerDiscoverInfo,transport)) {
            if (ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_ICE_UDP_1.equals(transport)) {
              transportManager=new IceUdpTransportManager(peer);
            }
 else             if (ProtocolProviderServiceJabberImpl.URN_XMPP_JINGLE_RAW_UDP_0.equals(transport)) {
              transportManager=new RawUdpTransportManager(peer);
            }
            if (transportManager != null)             break;
          }
        }
        if ((transportManager == null) && logger.isDebugEnabled()) {
          logger.debug("No known Jingle transport supported" + " by Jabber call peer " + peer);
        }
      }
    }
  }
  return transportManager;
}
