{
  MediaDirection direction=stream.getDirection();
  System.out.println("original direction is " + direction);
  if (direction.allowsSending())   return direction;
  ContentPacketExtension content=remoteContentMap.get(stream.getName());
  MediaDirection remoteDirection=JingleUtils.getDirection(content,!getPeer().isInitiator());
  System.out.println("remote direction from our perspective is " + remoteDirection);
  direction=direction.and(remoteDirection);
  MediaDevice device=stream.getDevice();
  direction=direction.and(getDirectionUserPreference(device.getMediaType()));
  System.out.println("user pref direction is " + getDirectionUserPreference(device.getMediaType()));
  if (isLocallyOnHold()) {
    System.out.println("locally on hold is " + isLocallyOnHold());
    direction.and(MediaDirection.SENDONLY);
  }
  direction=direction.and(device.getDirection());
  System.out.println("device direction is " + device.getDirection());
  System.out.println("result direction is " + direction);
  return direction;
}
