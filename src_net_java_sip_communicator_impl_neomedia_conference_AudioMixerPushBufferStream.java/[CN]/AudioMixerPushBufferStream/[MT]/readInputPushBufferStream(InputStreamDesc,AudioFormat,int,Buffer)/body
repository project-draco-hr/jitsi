{
  PushBufferStream inputStream=(PushBufferStream)inputStreamDesc.getInputStream();
  AudioFormat inputStreamFormat=(AudioFormat)inputStream.getFormat();
  Buffer inputBuffer=inputStreamDesc.getBuffer(true);
  if (sampleCount != 0) {
    Class<?> inputDataType=inputStreamFormat.getDataType();
    if (Format.byteArray.equals(inputDataType)) {
      Object data=inputBuffer.getData();
      int length=sampleCount * (inputStreamFormat.getSampleSizeInBits() / 8);
      if (!(data instanceof byte[]) || (((byte[])data).length != length))       inputBuffer.setData(new byte[length]);
      inputBuffer.setLength(0);
      inputBuffer.setOffset(0);
    }
 else     throw new UnsupportedFormatException("!Format.getDataType().equals(byte[].class)",inputStreamFormat);
  }
  audioMixer.read(inputStream,inputBuffer,inputStreamDesc.inputDataSourceDesc.inputDataSource);
  if (inputBuffer.isDiscard()) {
    outputBuffer.setDiscard(true);
    return;
  }
  int inputLength=inputBuffer.getLength();
  if (inputLength <= 0) {
    outputBuffer.setDiscard(true);
    return;
  }
  AudioFormat inputFormat=(AudioFormat)inputBuffer.getFormat();
  if (inputFormat == null)   inputFormat=inputStreamFormat;
  if (logger.isTraceEnabled() && (lastReadInputFormat != null) && !lastReadInputFormat.matches(inputFormat)) {
    lastReadInputFormat=inputFormat;
    logger.trace("Read inputSamples in different format " + lastReadInputFormat);
  }
  int inputFormatSigned=inputFormat.getSigned();
  if ((inputFormatSigned != AudioFormat.SIGNED) && (inputFormatSigned != Format.NOT_SPECIFIED))   throw new UnsupportedFormatException("AudioFormat.getSigned()",inputFormat);
  int inputChannels=inputFormat.getChannels();
  int outputChannels=outputFormat.getChannels();
  if ((inputChannels != outputChannels) && (inputChannels != Format.NOT_SPECIFIED) && (outputChannels != Format.NOT_SPECIFIED)) {
    logger.error("Read inputFormat with channels " + inputChannels + " while expected outputFormat channels is "+ outputChannels);
    throw new UnsupportedFormatException("AudioFormat.getChannels()",inputFormat);
  }
  double inputSampleRate=inputFormat.getSampleRate();
  double outputSampleRate=outputFormat.getSampleRate();
  if (inputSampleRate != outputSampleRate) {
    logger.warn("Read inputFormat with sampleRate " + inputSampleRate + " while expected outputFormat sampleRate is "+ outputSampleRate);
  }
  Object inputData=inputBuffer.getData();
  if (inputData == null) {
    outputBuffer.setDiscard(true);
  }
 else   if (inputData instanceof byte[]) {
    int inputSampleSizeInBits=inputFormat.getSampleSizeInBits();
    int outputSampleSizeInBits=outputFormat.getSampleSizeInBits();
    if (logger.isTraceEnabled() && (inputSampleSizeInBits != outputSampleSizeInBits)) {
      logger.trace("Read inputFormat with sampleSizeInBits " + inputSampleSizeInBits + ". Will convert to sampleSizeInBits "+ outputSampleSizeInBits);
    }
    byte[] inputSamples=(byte[])inputData;
    int outputLength;
    int[] outputSamples;
switch (inputSampleSizeInBits) {
case 16:
      outputLength=inputLength / 2;
    outputSamples=validateIntArraySize(outputBuffer,outputLength);
  for (int i=0; i < outputLength; i++) {
    int sample=ArrayIOUtils.readInt16(inputSamples,i * 2);
switch (outputSampleSizeInBits) {
case 16:
      break;
case 32:
    sample=Math.round(sample * INT_TO_SHORT_RATIO);
  break;
case 8:
case 24:
default :
throw new UnsupportedFormatException("AudioFormat.getSampleSizeInBits()",outputFormat);
}
outputSamples[i]=sample;
}
break;
case 32:
outputLength=inputSamples.length / 4;
outputSamples=validateIntArraySize(outputBuffer,outputLength);
for (int i=0; i < outputLength; i++) {
int sample=readInt(inputSamples,i * 4);
switch (outputSampleSizeInBits) {
case 16:
sample=Math.round(sample * SHORT_TO_INT_RATIO);
break;
case 32:
break;
case 8:
case 24:
default :
throw new UnsupportedFormatException("AudioFormat.getSampleSizeInBits()",outputFormat);
}
outputSamples[i]=sample;
}
break;
case 8:
case 24:
default :
throw new UnsupportedFormatException("AudioFormat.getSampleSizeInBits()",inputFormat);
}
outputBuffer.setFlags(inputBuffer.getFlags());
outputBuffer.setFormat(outputFormat);
outputBuffer.setLength(outputLength);
outputBuffer.setOffset(0);
outputBuffer.setTimeStamp(inputBuffer.getTimeStamp());
}
 else {
throw new UnsupportedFormatException("Format.getDataType().equals(" + inputData.getClass() + ")",inputFormat);
}
}
