{
  CVPixelBuffer pixelBuffer=(CVPixelBuffer)videoFrame;
  boolean transferData;
synchronized (dataSyncRoot) {
    if (!automaticallyDropsLateVideoFrames && (data != null)) {
      if (nextData != null) {
        returnFreeBuffer(nextData);
        nextData=null;
      }
      nextData=getFreeBuffer(pixelBuffer.getByteCount());
      if (nextData != null) {
        nextData.setLength(pixelBuffer.getBytes(nextData.ptr,nextData.capacity));
        nextDataTimeStamp=System.nanoTime();
        if (nextDataFormat == null)         nextDataFormat=getVideoFrameFormat(pixelBuffer);
      }
      return;
    }
    if (data != null) {
      returnFreeBuffer(data);
      data=null;
    }
    data=getFreeBuffer(pixelBuffer.getByteCount());
    if (data != null) {
      data.setLength(pixelBuffer.getBytes(data.ptr,data.capacity));
      dataTimeStamp=System.nanoTime();
      if (dataFormat == null)       dataFormat=getVideoFrameFormat(pixelBuffer);
    }
    if (nextData != null) {
      returnFreeBuffer(nextData);
      nextData=null;
    }
    if (automaticallyDropsLateVideoFrames)     transferData=(data != null);
 else {
      transferData=false;
      dataSyncRoot.notifyAll();
    }
  }
  if (transferData) {
    BufferTransferHandler transferHandler=this.transferHandler;
    if (transferHandler != null)     transferHandler.transferData(this);
  }
}
