{
  logger.info("Updating buddy list...");
  listChanged=(Boolean)buddyList.get("listChanged");
  availableCount=(Number)buddyList.get("availableCount");
  logger.trace("listChanged: " + listChanged);
  logger.trace("availableCount: " + availableCount);
  JSONObject userInfos=(JSONObject)buddyList.get("userInfos");
  if (userInfos == null)   return;
  for (  Map.Entry<String,FacebookUser> entry : buddyCache.entrySet()) {
    FacebookUser user=entry.getValue();
    user.isOnline=false;
  }
  Iterator<String> it=userInfos.keys();
  while (it.hasNext()) {
    String key=it.next();
    logger.debug("userID: " + key);
    JSONObject user=(JSONObject)userInfos.get(key);
    if (user == null)     continue;
    FacebookUser fu=new FacebookUser(key,user);
    if (fu == null)     continue;
    if (key.equals(adapter.getUID())) {
      me=fu;
      continue;
    }
    buddyCache.put(key,fu);
    printUserInfo(fu);
  }
  if (listChanged) {
    JSONObject nowAvailableList=(JSONObject)buddyList.get("nowAvailableList");
    if (nowAvailableList == null)     return;
    it=nowAvailableList.keys();
    while (it.hasNext()) {
      String key=it.next();
      logger.debug("userID: " + key);
      JSONObject status=(JSONObject)nowAvailableList.get(key);
      if (status == null)       continue;
      buddyCache.get(key).isIdle=status.getBoolean("i");
    }
  }
  Map<String,OperationSet> supportedOperationSets=adapter.getParentProvider().getSupportedOperationSets();
  if (supportedOperationSets == null || supportedOperationSets.size() < 1)   throw new NullPointerException("No OperationSet implementations are supported by " + "this implementation. ");
  OperationSetPersistentPresenceFacebookImpl operationSetPresence=(OperationSetPersistentPresenceFacebookImpl)supportedOperationSets.get(OperationSetPresence.class.getName());
  for (  Map.Entry<String,FacebookUser> entry : buddyCache.entrySet()) {
    String uid=entry.getKey();
    FacebookUser user=entry.getValue();
    if (user.isOnline && user.isIdle)     operationSetPresence.setPresenceStatusForContact(uid,FacebookStatusEnum.IDLE);
 else     if (user.isOnline)     operationSetPresence.setPresenceStatusForContact(uid,FacebookStatusEnum.ONLINE);
 else     operationSetPresence.setPresenceStatusForContact(uid,FacebookStatusEnum.OFFLINE);
  }
}
