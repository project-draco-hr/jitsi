{
  try {
    int peeked;
    if (corked)     peeked=0;
 else {
      int offset;
      if ((buffer == null) || (buffer.length < length)) {
        buffer=new byte[length];
        this.offset=0;
        this.length=0;
        offset=0;
      }
 else {
        offset=this.offset + this.length;
        if (offset + length > buffer.length) {
          int overflow=this.length + length - buffer.length;
          if (overflow > 0) {
            if (overflow >= this.length) {
              if (DEBUG && logger.isDebugEnabled()) {
                logger.debug("Dropping " + this.length + " bytes!");
              }
              this.offset=0;
              this.length=0;
              offset=0;
            }
 else {
              if (DEBUG && logger.isDebugEnabled()) {
                logger.debug("Dropping " + overflow + " bytes!");
              }
              this.offset+=overflow;
              this.length-=overflow;
            }
          }
          if (this.length > 0) {
            for (int i=0; i < this.length; i++, this.offset++) {
              buffer[i]=buffer[this.offset];
            }
            this.offset=0;
            offset=this.length;
          }
        }
      }
      peeked=PA.stream_peek(stream,buffer,offset);
    }
    PA.stream_drop(stream);
    this.length+=peeked;
  }
  finally {
    pulseAudioSystem.signalMainloop(false);
  }
}
