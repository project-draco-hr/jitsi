{
  InetAddress localHost=null;
  String osVersion=System.getProperty("os.version");
  if (logger.isTraceEnabled())   logger.trace("Querying a localhost addr for dst=" + intendedDestination);
  if (OSUtils.IS_WINDOWS && !osVersion.startsWith("4") && !osVersion.startsWith("5.0")) {
    byte[] src=Win32LocalhostRetriever.getSourceForDestination(intendedDestination.getAddress());
    if (src == null) {
      logger.warn("Failed to get localhost ");
    }
 else {
      try {
        localHost=InetAddress.getByAddress(src);
      }
 catch (      UnknownHostException e) {
        logger.warn("Failed to get localhost ",e);
      }
    }
  }
 else {
    localHostFinderSocket.connect(intendedDestination,RANDOM_ADDR_DISC_PORT);
    localHost=localHostFinderSocket.getLocalAddress();
    localHostFinderSocket.disconnect();
  }
  if (localHost.isAnyLocalAddress()) {
    if (logger.isTraceEnabled())     logger.trace("Socket returned the AnyLocalAddress. " + "Trying a workaround.");
    try {
      if (intendedDestination instanceof Inet6Address) {
        Enumeration<NetworkInterface> interfaces=NetworkInterface.getNetworkInterfaces();
        while (interfaces.hasMoreElements()) {
          NetworkInterface iface=interfaces.nextElement();
          Enumeration<InetAddress> addresses=iface.getInetAddresses();
          while (addresses.hasMoreElements()) {
            InetAddress address=addresses.nextElement();
            if (address instanceof Inet6Address) {
              if (!address.isAnyLocalAddress() && !address.isLinkLocalAddress() && !address.isSiteLocalAddress()&& !address.isLoopbackAddress()) {
                if (logger.isTraceEnabled()) {
                  logger.trace("will return ipv6 addr " + address);
                }
                return address;
              }
            }
          }
        }
      }
 else {
        localHost=InetAddress.getLocalHost();
        if (!(localHost instanceof Inet4Address)) {
          Enumeration<NetworkInterface> interfaces=NetworkInterface.getNetworkInterfaces();
          while (interfaces.hasMoreElements()) {
            NetworkInterface iface=interfaces.nextElement();
            Enumeration<InetAddress> addresses=iface.getInetAddresses();
            while (addresses.hasMoreElements()) {
              InetAddress address=addresses.nextElement();
              if (address instanceof Inet4Address) {
                if (!address.isLoopbackAddress()) {
                  if (logger.isTraceEnabled()) {
                    logger.trace("will return ipv6 addr " + address);
                  }
                  return address;
                }
              }
            }
          }
        }
      }
    }
 catch (    Exception ex) {
      logger.warn("Failed to get localhost ",ex);
    }
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Will return the following localhost address: " + localHost);
  }
  return localHost;
}
