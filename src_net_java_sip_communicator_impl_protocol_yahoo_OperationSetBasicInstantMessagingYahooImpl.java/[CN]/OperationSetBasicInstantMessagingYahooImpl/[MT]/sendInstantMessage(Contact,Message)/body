{
  assertConnected();
  if (!(to instanceof ContactYahooImpl))   throw new IllegalArgumentException("The specified contact is not a Yahoo contact." + to);
  try {
    String toUserID=((ContactYahooImpl)to).getID();
    MessageDeliveredEvent msgDeliveryPendingEvt=new MessageDeliveredEvent(message,to,System.currentTimeMillis());
    OperationSetInstantMessageTransformYahooImpl messageTransform=(OperationSetInstantMessageTransformYahooImpl)yahooProvider.getOperationSet(OperationSetInstantMessageTransform.class);
    for (    Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
      for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
        TransformLayer transformLayer=(TransformLayer)iterator.next();
        if (msgDeliveryPendingEvt != null)         msgDeliveryPendingEvt=transformLayer.messageDeliveryPending(msgDeliveryPendingEvt);
      }
    }
    if (msgDeliveryPendingEvt == null)     return;
    byte[] msgBytesToBeSent=msgDeliveryPendingEvt.getSourceMessage().getContent().trim().getBytes();
    do {
      if (msgBytesToBeSent.length > MAX_MESSAGE_LENGTH) {
        byte[] tmp1=new byte[MAX_MESSAGE_LENGTH];
        System.arraycopy(msgBytesToBeSent,0,tmp1,0,MAX_MESSAGE_LENGTH);
        byte[] tmp2=new byte[msgBytesToBeSent.length - MAX_MESSAGE_LENGTH];
        System.arraycopy(msgBytesToBeSent,MAX_MESSAGE_LENGTH,tmp2,0,tmp2.length);
        msgBytesToBeSent=tmp2;
        yahooProvider.getYahooSession().sendMessage(toUserID,new String(tmp1));
      }
 else {
        yahooProvider.getYahooSession().sendMessage(toUserID,new String(msgBytesToBeSent));
      }
      MessageDeliveredEvent msgDeliveredEvt=new MessageDeliveredEvent(message,to,System.currentTimeMillis());
      for (      Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
        for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
          TransformLayer transformLayer=(TransformLayer)iterator.next();
          if (msgDeliveredEvt != null)           msgDeliveredEvt=transformLayer.messageDelivered(msgDeliveredEvt);
        }
      }
      if (msgDeliveredEvt != null)       fireMessageEvent(msgDeliveredEvt);
    }
 while (msgBytesToBeSent.length > MAX_MESSAGE_LENGTH);
  }
 catch (  IOException ex) {
    logger.fatal("Cannot Send Message! " + ex.getMessage());
    MessageDeliveryFailedEvent evt=new MessageDeliveryFailedEvent(message,to,MessageDeliveryFailedEvent.NETWORK_FAILURE);
    OperationSetInstantMessageTransformYahooImpl messageTransform=(OperationSetInstantMessageTransformYahooImpl)yahooProvider.getOperationSet(OperationSetInstantMessageTransform.class);
    for (    Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
      for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
        TransformLayer transformLayer=(TransformLayer)iterator.next();
        if (evt != null)         evt=transformLayer.messageDeliveryFailed(evt);
      }
    }
    if (evt != null)     fireMessageEvent(evt);
    return;
  }
}
