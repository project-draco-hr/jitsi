{
  logger.debug("Message received : " + ev);
  String formattedMessage=ev.getMessage();
  logger.debug("original message received : " + formattedMessage);
  formattedMessage=processLinks(messageDecoder.decodeToHTML(formattedMessage));
  formattedMessage=formattedMessage.replaceAll("(<font) (.*) size=\"0\">","$1 $2 size=\"10\">");
  formattedMessage=formattedMessage.replaceAll("(<font) (.*) size=\"(\\d+)\">","$1 $2 style=\"font-size: $3px;\">");
  logger.debug("formatted Message : " + formattedMessage);
  Message newMessage=createMessage(formattedMessage,HTML_MIME_TYPE,DEFAULT_MIME_ENCODING,null);
  Contact sourceContact=opSetPersPresence.findContactByID(ev.getFrom());
  if (sourceContact == null) {
    logger.debug("received a message from an unknown contact: " + ev.getFrom());
    sourceContact=opSetPersPresence.createVolatileContact(ev.getFrom());
  }
  MessageReceivedEvent msgReceivedEvt=new MessageReceivedEvent(newMessage,sourceContact,System.currentTimeMillis());
  OperationSetInstantMessageTransformYahooImpl messageTransform=(OperationSetInstantMessageTransformYahooImpl)yahooProvider.getOperationSet(OperationSetInstantMessageTransform.class);
  for (  Map.Entry<Integer,Vector<TransformLayer>> entry : messageTransform.transformLayers.entrySet()) {
    for (Iterator<TransformLayer> iterator=entry.getValue().iterator(); iterator.hasNext(); ) {
      TransformLayer transformLayer=(TransformLayer)iterator.next();
      if (msgReceivedEvt != null)       msgReceivedEvt=transformLayer.messageReceived(msgReceivedEvt);
    }
  }
  if (msgReceivedEvt != null)   fireMessageEvent(msgReceivedEvt);
}
