{
synchronized (storedAccounts) {
    if (!storedAccounts.contains(accountID))     storedAccounts.add(accountID);
  }
  ConfigurationService configurationService=ProtocolProviderActivator.getConfigurationService();
  String factoryPackage=getFactoryImplPackageName(factory);
  List<String> storedAccounts=configurationService.getPropertyNamesByPrefix(factoryPackage,true);
  String accountUID=accountID.getAccountUniqueID();
  String accountNodeName=null;
  for (Iterator<String> storedAccountIter=storedAccounts.iterator(); storedAccountIter.hasNext(); ) {
    String storedAccount=storedAccountIter.next();
    String storedAccountUID=configurationService.getString(storedAccount + "." + ProtocolProviderFactory.ACCOUNT_UID);
    if (storedAccountUID.equals(accountUID))     accountNodeName=configurationService.getString(storedAccount);
  }
  Map<String,Object> configurationProperties=new HashMap<String,Object>();
  if (accountNodeName == null) {
    accountNodeName="acc" + Long.toString(System.currentTimeMillis());
    configurationProperties.put(factoryPackage + "." + accountNodeName,accountNodeName);
    configurationProperties.put(factoryPackage + "." + accountNodeName+ "."+ ProtocolProviderFactory.ACCOUNT_UID,accountID.getAccountUniqueID());
  }
  Map<String,String> accountProperties=accountID.getAccountProperties();
  for (  Map.Entry<String,String> entry : accountProperties.entrySet()) {
    String property=entry.getKey();
    String value=entry.getValue();
    if (property.equals(ProtocolProviderFactory.PASSWORD)) {
      CredentialsStorageService credentialsStorage=ServiceUtils.getService(bundleContext,CredentialsStorageService.class);
      String accountPrefix=factoryPackage + "." + accountNodeName;
      if ((value != null) && (value.length() != 0) && !credentialsStorage.isStoredEncrypted(accountPrefix)&& !credentialsStorage.storePassword(accountPrefix,value)) {
        throw new OperationFailedException("CredentialsStorageService failed to" + " storePassword",OperationFailedException.GENERAL_ERROR);
      }
    }
 else {
      configurationProperties.put(factoryPackage + "." + accountNodeName+ "."+ property,value);
    }
  }
  if (configurationProperties.size() > 0)   configurationService.setProperties(configurationProperties);
  if (logger.isDebugEnabled())   logger.debug("Stored account for id " + accountID.getAccountUniqueID() + " for package "+ factoryPackage);
}
