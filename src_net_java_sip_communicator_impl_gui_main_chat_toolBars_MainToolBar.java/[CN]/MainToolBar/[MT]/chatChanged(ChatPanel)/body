{
  if (chatPanel == null) {
    setChatSession(null);
  }
 else {
    MetaContact contact=GuiActivator.getUIService().getChatContact(chatPanel);
    for (    PluginComponent c : pluginContainer.getPluginComponents())     c.setCurrentContact(contact);
    setChatSession(chatPanel.chatSession);
    leaveChatRoomButton.setEnabled(chatPanel.chatSession instanceof ConferenceChatSession);
    inviteButton.setEnabled(chatPanel.findInviteChatTransport() != null);
    sendFileButton.setEnabled(chatPanel.findFileTransferChatTransport() != null);
    boolean hasPhone=false;
    boolean hasTelephony=!getOperationSetForCapabilities(chatPanel.chatSession.getTransportsForOperationSet(OperationSetBasicTelephony.class),OperationSetBasicTelephony.class).isEmpty();
    if (!hasTelephony && contact != null) {
      Iterator<Contact> contacts=contact.getContacts();
      while (contacts.hasNext()) {
        Contact c=contacts.next();
        OperationSetServerStoredContactInfo infoOpSet=c.getProtocolProvider().getOperationSet(OperationSetServerStoredContactInfo.class);
        Iterator<GenericDetail> details;
        if (infoOpSet != null) {
          details=infoOpSet.requestAllDetailsForContact(c,new DetailsListener(chatPanel.chatSession,callButton));
          if (details != null) {
            while (details.hasNext()) {
              GenericDetail d=details.next();
              if (d instanceof PhoneNumberDetail && !(d instanceof PagerDetail) && !(d instanceof FaxDetail)) {
                PhoneNumberDetail pnd=(PhoneNumberDetail)d;
                if (pnd.getNumber() != null && pnd.getNumber().length() > 0) {
                  hasPhone=true;
                  break;
                }
              }
            }
          }
        }
      }
    }
    callButton.setEnabled(hasTelephony || hasPhone);
    desktopSharingButton.setEnabled(!getOperationSetForCapabilities(chatPanel.chatSession.getTransportsForOperationSet(OperationSetDesktopSharingServer.class),OperationSetDesktopSharingServer.class).isEmpty());
    changeHistoryButtonsState(chatPanel);
  }
}
